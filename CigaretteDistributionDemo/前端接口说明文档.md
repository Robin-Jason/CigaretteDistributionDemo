# 卷烟投放管理系统前端接口说明文档

## 📋 文档概述

本文档详细描述了卷烟投放管理系统前端调用的所有后端接口，包括请求格式、参数说明、响应数据结构等，供后端开发人员实现接口时参考。

### 🏷️ 基本信息

- **项目名称**: 卷烟投放管理系统
- **前端技术栈**: Vue 3 + Element Plus + Axios
- **API基础路径**: `/api/cigarette`
- **数据格式**: JSON
- **文档版本**: v1.0
- **更新时间**: 2025年1月9日

---

## 🌐 通用接口配置

### 1. 基础配置

```javascript
// API基础配置
baseURL: process.env.VUE_APP_API_BASE_URL || '/api/cigarette'
timeout: 10000ms
headers: {
  'Content-Type': 'application/json'
}
```

### 2. 请求拦截器
前端会在每个请求中添加以下处理：
- 打印请求日志（开发模式）
- 自动错误处理

### 3. 响应拦截器
前端期望的标准响应格式：
```json
{
  "success": true|false,
  "message": "操作结果消息",
  "data": {}, // 或 []
  "total": 0, // 分页查询时
  "originalTotal": 0 // 原始记录数（可选）
}
```

---

## 📝 核心业务接口

### 1. 健康检查接口

**接口地址**: `GET /api/cigarette/health`  
**功能描述**: 检查服务健康状态  
**调用场景**: 系统启动时、健康监控

#### 请求参数
无

#### 响应示例
```json
{
  "success": true,
  "message": "服务正常",
  "timestamp": "2025-01-09T10:30:00Z"
}
```

---

### 2. 查询卷烟分配数据

**接口地址**: `POST /api/cigarette/query`  
**功能描述**: 根据时间条件查询卷烟投放分配数据  
**调用场景**: 主要的数据查询功能，表格数据展示

#### 请求参数
```json
{
  "year": 2024,
  "month": 1,
  "weekSeq": 1
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| year | Integer | 是 | 年份 |
| month | Integer | 是 | 月份（1-12） |
| weekSeq | Integer | 是 | 周序号（1-5） |

#### 响应示例
```json
{
  "success": true,
  "message": "查询成功",
  "total": 10,
  "originalTotal": 15,
  "data": [
    {
      "id": 1,
      "cigCode": "42010114",
      "cigName": "红金龙(硬爱你爆珠)",
      "deliveryArea": "城区",
      "year": 2024,
      "month": 1,
      "weekSeq": 1,
      "deliveryMethod": "按档位扩展投放",
      "deliveryEtype": "档位+城乡分类代码",
      "advAmount": 1000.00,
      "actualDelivery": 980.50,
      "remark": "备注信息",
      "d30": 50.00,
      "d29": 45.00,
      // ... d28 到 d1 的档位数据
      "d1": 0.80
    }
  ]
}
```

#### 前端处理逻辑
- 验证必填参数（year, month, weekSeq）
- 成功时显示查询结果和记录数量
- 自动添加日期显示字段
- 对数据进行分组排序
- 单条记录时自动选中

---

### 3. 查询原始数据

**接口地址**: `POST /api/cigarette/query-raw`  
**功能描述**: 查询未经处理的原始数据  
**调用场景**: 需要获取原始数据时

#### 请求参数
同查询卷烟分配数据接口

#### 响应数据
返回原始数据记录，不包含预投放量和实际投放量字段的计算结果

---

### 4. 更新卷烟信息

**接口地址**: `POST /api/cigarette/update-cigarette`  
**功能描述**: 更新卷烟的投放信息和档位分配（推荐使用）  
**调用场景**: 修改档位设置、新增投放区域

#### 请求参数
```json
{
  "cigCode": "42010114",
  "cigName": "红金龙(硬爱你爆珠)",
  "year": 2024,
  "month": 1,
  "weekSeq": 1,
  "deliveryMethod": "按档位扩展投放",
  "deliveryEtype": "档位+城乡分类代码",
  "deliveryArea": "城区",
  "distribution": [50.00, 45.00, 40.00, /* ... 30个档位值 */],
  "remark": "更新备注"
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| cigCode | String | 是 | 卷烟代码 |
| cigName | String | 是 | 卷烟名称 |
| year | Integer | 是 | 年份 |
| month | Integer | 是 | 月份 |
| weekSeq | Integer | 是 | 周序号 |
| deliveryMethod | String | 是 | 投放方式 |
| deliveryEtype | String | 否 | 扩展投放类型 |
| deliveryArea | String | 是 | 投放区域 |
| distribution | Array&lt;Number&gt; | 是 | 30个档位分配值（D30到D1） |
| remark | String | 否 | 备注信息 |

#### 响应示例
```json
{
  "success": true,
  "message": "更新成功"
}
```

#### 前端处理逻辑
- 档位数据验证（非递增约束）
- 批量新增区域时使用Promise.all
- 成功后刷新表格数据

---

### 5. 删除投放区域

**接口地址**: `POST /api/cigarette/delete-delivery-areas`  
**功能描述**: 删除指定卷烟的特定投放区域记录  
**调用场景**: 用户删除不需要的投放区域

#### 请求参数
```json
{
  "cigCode": "42010114",
  "cigName": "红金龙(硬爱你爆珠)",
  "year": 2024,
  "month": 1,
  "weekSeq": 1,
  "areasToDelete": ["乡中心区", "村庄"]
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| cigCode | String | 是 | 卷烟代码 |
| cigName | String | 是 | 卷烟名称 |
| year | Integer | 是 | 年份 |
| month | Integer | 是 | 月份 |
| weekSeq | Integer | 是 | 周序号 |
| areasToDelete | Array&lt;String&gt; | 是 | 要删除的投放区域列表 |

#### 响应示例
```json
{
  "success": true,
  "message": "删除成功",
  "deletedCount": 2,
  "deletedAreas": ["乡中心区", "村庄"],
  "remainingAreas": ["镇中心区", "镇乡结合区"],
  "remainingCount": 2
}
```

#### 前端处理逻辑
- 确认对话框确认删除
- 验证至少保留一个区域
- 成功后刷新表格并重新选中

---

## 📊 数据导入接口

### 6. 导入卷烟投放基本信息

**接口地址**: `POST /api/cigarette/import-basic-info`  
**功能描述**: 导入卷烟投放基本信息Excel文件  
**调用场景**: 批量导入基础数据

#### 请求参数（FormData）
```javascript
// FormData格式
const formData = new FormData()
formData.append('file', excelFile)        // Excel文件
formData.append('year', 2024)             // 年份
formData.append('month', 1)               // 月份
formData.append('weekSeq', 1)             // 周序号
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | Excel文件(.xlsx, .xls) |
| year | Integer | 是 | 年份 |
| month | Integer | 是 | 月份 |
| weekSeq | Integer | 是 | 周序号 |

#### 请求头
```
Content-Type: multipart/form-data
```

#### 响应示例
```json
{
  "success": true,
  "message": "导入成功",
  "importCount": 25
}
```

#### 前端处理逻辑
- 文件格式验证（只允许Excel）
- 文件大小限制（10MB）
- 时间参数完整性验证
- 成功后刷新表格数据

---

### 7. 导入区域客户数

**接口地址**: `POST /api/cigarette/import-customer-data`  
**功能描述**: 导入区域客户数Excel文件  
**调用场景**: 导入客户数据以支持分配算法

#### 请求参数（FormData）
```javascript
const formData = new FormData()
formData.append('file', excelFile)                    // Excel文件
formData.append('distributionType', '按档位扩展投放')    // 投放类型
formData.append('extendedType', '档位+城乡分类代码')    // 扩展类型（可选）
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | Excel文件(.xlsx, .xls) |
| distributionType | String | 是 | 投放类型 |
| extendedType | String | 否 | 扩展投放类型（按档位扩展投放时必填） |

#### 投放类型选项
- **按档位统一投放**: 不需要扩展类型
- **按档位扩展投放**: 需要选择扩展类型
  - 档位+区县
  - 档位+城乡分类代码
  - 档位+市场类型
  - 档位+业态

#### 响应示例
```json
{
  "success": true,
  "message": "导入成功",
  "importCount": 15
}
```

---

### 8. 生成分配方案

**接口地址**: `POST /api/cigarette/generate-distribution-plan`  
**功能描述**: 根据基本信息和客户数据自动生成分配方案  
**调用场景**: 智能生成档位分配算法

#### 请求参数
```json
{
  "year": 2024,
  "month": 1,
  "weekSeq": 1
}
```

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| year | Integer | 是 | 年份 |
| month | Integer | 是 | 月份 |
| weekSeq | Integer | 是 | 周序号 |

#### 响应示例
```json
{
  "success": true,
  "message": "分配方案生成成功",
  "processedCount": 25,
  "generatedPlans": [
    {
      "cigCode": "42010114",
      "cigName": "红金龙(硬爱你爆珠)",
      "deliveryArea": "城区",
      "distribution": [50.00, 45.00, /* ... 30个档位值 */]
    }
  ],
  "timestamp": "2025-01-09T10:30:00Z"
}
```

#### 前端处理逻辑
- 时间参数完整性验证
- 显示处理进度和结果统计
- 成功后自动刷新表格

---

## 🎯 辅助功能接口

### 9. 更新卷烟分配（传统接口）

**接口地址**: `POST /api/cigarette/update`  
**功能描述**: 传统的卷烟分配更新接口  
**调用场景**: 向下兼容，建议使用update-cigarette

#### 请求参数
```json
{
  "cigCode": "42010114",
  "cigName": "红金龙(硬爱你爆珠)",
  "distribution": [50.00, 45.00, /* ... 30个档位值 */],
  "deliveryAreas": "410101,410102,410103",
  "year": 2024,
  "month": 1,
  "weekSeq": 1
}
```

---

### 10. 写回分配矩阵

**接口地址**: `POST /api/cigarette/write-back`  
**功能描述**: 写回分配矩阵数据  
**调用场景**: 特定的数据写回操作

---

### 11. 测试分配算法

**接口地址**: `GET /api/cigarette/test-algorithm`  
**功能描述**: 测试分配算法功能  
**调用场景**: 开发测试时验证算法

---

## 🏗️ 投放方案管理接口

### 12. 查询卷烟投放方案

**接口地址**: `GET /api/cigarette/distribution-plan/query`  
**功能描述**: 查询投放方案数据  

#### 请求参数（Query Parameters）
```
?cigaretteName=红金龙&year=2024&month=1&week=1
```

---

### 13. 保存档位设置

**接口地址**: `POST /api/cigarette/distribution-plan/save-positions`  
**功能描述**: 保存档位设置数据  

---

### 14. 获取档位数据

**接口地址**: `GET /api/cigarette/distribution-plan/positions`  
**功能描述**: 获取特定卷烟的档位数据  

#### 请求参数（Query Parameters）
```
?cigaretteName=红金龙&year=2024&month=1&week=1
```

---

## 🚀 卷烟基础数据接口

### 15. 获取卷烟列表

**接口地址**: `GET /api/cigarette/cigarettes`  
**功能描述**: 获取所有卷烟列表  

#### 响应示例
```json
{
  "success": true,
  "data": [
    {
      "cigCode": "42010114",
      "cigName": "红金龙(硬爱你爆珠)"
    }
  ]
}
```

---

### 16. 搜索卷烟

**接口地址**: `GET /api/cigarette/cigarettes/search`  
**功能描述**: 根据关键词搜索卷烟  

#### 请求参数（Query Parameters）
```
?keyword=红金龙
```

---

## 📋 数据字典

### 1. 投放类型选项
```javascript
const distributionTypes = [
  '按档位统一投放',
  '按档位扩展投放'
]
```

### 2. 扩展投放类型选项
```javascript
const extendedTypes = [
  '档位+区县',
  '档位+城乡分类代码', 
  '档位+市场类型',
  '档位+业态'
]
```

### 3. 投放区域选项

#### 按档位统一投放
```javascript
const unifiedAreas = ['全市']
```

#### 按档位扩展投放
```javascript
const extendedAreaOptions = {
  '档位+区县': ['丹江', '房县', '郧西', '郧阳', '竹山', '竹溪', '城区'],
  '档位+城乡分类代码': ['主城区', '城乡结合区', '镇中心区', '镇乡结合区', '特殊区域', '乡中心区', '村庄'],
  '档位+市场类型': ['城网', '农网'],
  '档位+业态': ['便利店', '超市', '商场', '烟草专卖店', '娱乐服务类', '其他']
}
```

### 4. 档位数据结构
```javascript
// 30个档位：D30到D1
const positionFields = ['d30', 'd29', 'd28', ..., 'd2', 'd1']
```

---

## ⚠️ 错误处理规范

### 1. 标准错误响应
```json
{
  "success": false,
  "message": "具体错误信息",
  "error": "ERROR_CODE", // 可选
  "details": {} // 可选的错误详情
}
```

### 2. 常见错误类型
- **参数验证错误**: 400 Bad Request
- **数据不存在**: 404 Not Found  
- **服务器错误**: 500 Internal Server Error
- **文件格式错误**: 400 Bad Request
- **文件大小超限**: 413 Payload Too Large

### 3. 前端错误处理
- 所有API调用都包含try-catch
- 统一的错误消息显示
- 自动重试机制（部分接口）
- 用户友好的错误提示

---

## 🔒 安全考虑

### 1. 请求验证
- 参数类型验证
- 参数范围验证
- 必填字段验证

### 2. 文件上传安全
- 文件类型限制（只允许Excel）
- 文件大小限制（10MB）
- 文件内容验证

### 3. 数据一致性
- 事务处理
- 并发控制
- 数据完整性约束

---

## 📈 性能要求

### 1. 响应时间
- 查询接口: < 2秒
- 更新接口: < 3秒
- 导入接口: < 30秒
- 生成方案: < 60秒

### 2. 并发支持
- 支持多用户同时查询
- 避免并发修改冲突
- 合理的连接池配置

### 3. 数据量支持
- 单次查询: < 10000条记录
- 批量导入: < 50000条记录
- 文件上传: < 10MB

---

## 🧪 接口测试建议

### 1. 功能测试
- 正常流程测试
- 边界值测试
- 异常情况测试

### 2. 性能测试
- 响应时间测试
- 并发压力测试
- 大数据量测试

### 3. 安全测试
- 参数注入测试
- 文件上传安全测试
- 权限验证测试

---

## 📝 开发注意事项

### 1. 接口版本控制
- 保持向下兼容
- 新功能新接口
- 废弃接口渐进式替换

### 2. 日志记录
- 记录关键操作日志
- 错误详情记录
- 性能监控数据

### 3. 文档维护
- 接口变更及时更新文档
- 提供测试示例
- 保持文档与代码同步

---

## 🎉 总结

本文档详细描述了卷烟投放管理系统前端调用的16个核心接口，涵盖了：

✅ **核心业务**: 查询、更新、删除卷烟投放数据  
✅ **数据导入**: Excel文件导入功能  
✅ **智能算法**: 自动生成分配方案  
✅ **辅助功能**: 健康检查、数据管理等  

