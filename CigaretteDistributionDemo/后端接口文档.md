# 卷烟分配系统 API 接口文档

**版本**: v2.0  
**生成日期**: 2025-09-16  
**服务地址**: http://localhost:28080  

## 📖 接口概览

系统提供4个功能模块的API接口：
- **数据管理** (`/api/data`) - 数据查询、更新、删除
- **通用功能** (`/api/common`) - 健康检查等系统功能
- **分配计算** (`/api/calculate`) - 算法计算和矩阵写回
- **数据导入** (`/api/import`) - Excel文件导入

---

## 1. 数据管理接口 (DataManageController)

**基础路径**: `/api/data`

### 1.1 查询卷烟分配数据

**接口地址**: `POST /api/data/query`  
**功能描述**: 根据年份、月份、周序号查询卷烟分配数据  
**Content-Type**: `application/json`

#### 请求参数
```json
{
    "year": 2024,           // 年份 (必填)
    "month": 1,             // 月份 (必填)  
    "weekSeq": 1            // 周序号 (必填)
}
```

#### 响应示例
```json
{
    "success": true,
    "message": "查询成功",
    "total": 44,
    "data": [
        {
            "id": 1,
            "cigCode": "42010114",
            "cigName": "红金龙(硬爱你爆珠)",
            "deliveryArea": "全市",
            "year": 2024,
            "month": 1,
            "weekSeq": 1,
            "remark": "备注信息",
            "advAmount": 1000.00,           // 预投放量
            "deliveryMethod": "按档位统一投放", // 投放方式
            "deliveryEtype": "NULL",        // 扩展投放方式
            "actualDelivery": 850.50,       // 实际投放量(总计)
            "d30": 30.00,                   // 档位30分配
            "d29": 29.00,                   // 档位29分配
            "...": "...",                   // d28~d2
            "d1": 1.00                      // 档位1分配
        }
    ]
}
```

### 1.2 更新卷烟信息

**接口地址**: `POST /api/data/update-cigarette`  
**功能描述**: 更新指定卷烟的投放信息和档位分配  
**Content-Type**: `application/json`

#### 请求参数
```json
{
    "cigCode": "42010114",                    // 卷烟代码 (必填)
    "cigName": "红金龙(硬爱你爆珠)",          // 卷烟名称 (必填)
    "year": 2024,                             // 年份 (必填)
    "month": 1,                               // 月份 (必填)
    "weekSeq": 1,                             // 周序号 (必填)
    "deliveryMethod": "按档位统一投放",        // 投放方式 (必填)
    "deliveryEtype": "NULL",                  // 扩展投放方式 (必填)
    "deliveryArea": "全市",                   // 投放区域 (必填)
    "distribution": [                         // 档位分配D30~D1 (必填)
        30, 29, 28, 27, 26, 25, 24, 23, 22, 21,
        20, 19, 18, 17, 16, 15, 14, 13, 12, 11,
        10, 9, 8, 7, 6, 5, 4, 3, 2, 1
    ],
    "remark": "更新备注"                      // 备注 (可选)
}
```

#### 响应示例
```json
{
    "success": true,
    "message": "投放类型变更完成，已重建投放记录",
    "operation": "投放类型变更",
    "deletedRecords": 2,
    "addedRecords": 1
}
```

### 1.3 删除投放区域

**接口地址**: `POST /api/data/delete-delivery-areas`  
**功能描述**: 删除指定卷烟的投放区域记录  
**Content-Type**: `application/json`

#### 请求参数
```json
{
    "cigCode": "42010114",              // 卷烟代码 (必填)
    "cigName": "红金龙(硬爱你爆珠)",    // 卷烟名称 (必填)
    "year": 2024,                       // 年份 (必填)
    "month": 1,                         // 月份 (必填)
    "weekSeq": 1,                       // 周序号 (必填)
    "areasToDelete": ["房县", "丹江"]   // 要删除的区域列表 (必填)
}
```

#### 响应示例
```json
{
    "success": true,
    "message": "删除成功",
    "deletedCount": 2,
    "deletedAreas": ["房县", "丹江"],
    "remainingAreas": ["全市"],
    "remainingCount": 1
}
```

---

## 2. 通用功能接口 (CommonController)

**基础路径**: `/api/common`

### 2.1 健康检查

**接口地址**: `GET /api/common/health`  
**功能描述**: 检查系统运行状态  

#### 响应示例
```json
{
    "status": "UP",
    "message": "卷烟分配服务运行正常",
    "timestamp": 1758039448390
}
```

---

## 3. 分配计算接口 (DistributionCalculateController)

**基础路径**: `/api/calculate`

### 3.1 分配矩阵写回数据库

**接口地址**: `POST /api/calculate/write-back`  
**功能描述**: 将算法计算的分配矩阵写入数据库  
**参数**: URL参数

#### 请求参数
```
POST /api/calculate/write-back?year=2024&month=1&weekSeq=1
```

#### 响应示例
```json
{
    "success": true,
    "message": "分配矩阵写回成功",
    "totalCount": 14,
    "successCount": 14,
    "failureCount": 0,
    "details": "所有卷烟分配矩阵写回完成"
}
```

### 3.2 一键生成分配方案

**接口地址**: `POST /api/calculate/generate-distribution-plan`  
**功能描述**: 一键删除指定日期的所有分配数据，重新执行各投放类型的算法分配并写回数据库  
**参数**: URL参数

#### 请求参数
```
POST /api/calculate/generate-distribution-plan?year=2024&month=1&weekSeq=1
```

#### 响应示例
```json
{
    "success": true,
    "message": "一键分配方案生成成功",
    "operation": "一键生成分配方案",
    "year": 2024,
    "month": 1,
    "weekSeq": 1,
    "deletedExistingData": true,
    "deletedRecords": 47,
    "totalCigarettes": 14,
    "successfulAllocations": 14,
    "processedCount": 47,
    "processingTime": "92ms",
    "allocationResult": {
        "success": true,
        "totalCount": 14,
        "successCount": 14,
        "results": [...]
    }
}
```

#### 功能特点
- ✅ **智能检测**: 自动检测指定日期是否已有分配数据
- ✅ **安全删除**: 如有现有数据，先删除后重新生成
- ✅ **全算法支持**: 支持所有投放类型（全市、区县、市场、城乡、业态）
- ✅ **实时反馈**: 返回详细的处理过程和结果统计
- ✅ **记录统计**: 返回 `processedCount` 字段，表示实际生成的分配记录数
- ✅ **事务保证**: 整个过程在事务中执行，确保数据一致性

### 3.3 计算总实际投放量

**接口地址**: `POST /api/calculate/total-actual-delivery`  
**功能描述**: 计算指定时间范围内所有卷烟的总实际投放量  
**参数**: URL参数

#### 请求参数
```
POST /api/calculate/total-actual-delivery?year=2024&month=1&weekSeq=1
```

#### 响应示例
```json
{
    "success": true,
    "message": "总实际投放量计算成功",
    "year": 2024,
    "month": 1,
    "weekSeq": 1,
    "totalRecords": 78,
    "cigaretteCount": 14,
    "data": {
        "42010114_红金龙(硬爱你爆珠)": 15792.00,
        "42020128_黄鹤楼(硬8度)": 19740.00,
        "31030005_木牡丹(软)": 23028.00
    }
}
```

---

## 4. 数据导入接口 (ExcelImportController)

**基础路径**: `/api/import`

### 4.1 导入卷烟投放基础信息

**接口地址**: `POST /api/import/cigarette-info`  
**功能描述**: 导入卷烟投放基础信息Excel文件  
**Content-Type**: `multipart/form-data`

#### 请求参数
```json
{
    "file": "Excel文件",       // Excel文件 (必填)
    "year": 2024,              // 年份 (必填)
    "month": 1,                // 月份 (必填)
    "weekSeq": 1               // 周序号 (必填)
}
```

#### 响应示例
```json
{
    "success": true,
    "message": "卷烟投放基础信息导入成功",
    "tableName": "demo_test_ADVdata",
    "insertedCount": 15,
    "fileName": "cigarette_info.xlsx",
    "processingTime": "2.5s"
}
```

### 4.2 导入区域客户数表

**接口地址**: `POST /api/import/region-clientnum`  
**功能描述**: 导入区域客户数表Excel文件  
**Content-Type**: `multipart/form-data`

#### 请求参数
```json
{
    "file": "Excel文件",                    // Excel文件 (必填)
    "year": 2024,                           // 年份 (必填)
    "month": 1,                             // 月份 (必填)
    "deliveryMethod": "按档位统一投放",      // 投放方式 (必填)
    "deliveryEtype": "NULL",                // 扩展投放方式 (必填)
    "sequenceNumber": 0                     // 序列号 (必填, 0-4)
}
```

#### 响应示例
```json
{
    "success": true,
    "message": "区域客户数表导入成功",
    "tableName": "city_clientnum_data",
    "insertedCount": 125,
    "sequenceNumber": 0,
    "fileName": "client_data.xlsx",
    "processingTime": "3.2s"
}
```

---

## 📋 投放类型说明

### 投放方式 (deliveryMethod)
- `按档位统一投放` - 全市统一按档位投放
- `按档位扩展投放` - 按不同维度扩展投放

### 扩展投放方式 (deliveryEtype)
- `NULL` - 全市统一投放
- `档位+区县` - 按区县分别投放
- `档位+市场类型` - 按市场类型分别投放
- `档位+城乡分类代码` - 按城乡分类分别投放
- `档位+业态` - 按业态分别投放

### 序列号映射 (sequenceNumber)
- `0` - 按档位统一投放 (全市)
- `1` - 档位+区县
- `2` - 档位+市场类型
- `3` - 档位+城乡分类代码
- `4` - 档位+业态

---

## 🔧 通用响应格式

### 成功响应
```json
{
    "success": true,
    "message": "操作成功",
    "data": "具体数据"
}
```

### 错误响应
```json
{
    "success": false,
    "message": "错误描述",
    "error": "错误代码",
    "details": "详细错误信息"
}
```

### HTTP状态码
- `200` - 请求成功
- `400` - 请求参数错误
- `500` - 服务器内部错误

---

## 🧪 测试说明

### 前端调用示例 (JavaScript)

#### 查询数据
```javascript
fetch('/api/data/query', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        year: 2024,
        month: 1,
        weekSeq: 1
    })
})
.then(response => response.json())
.then(data => console.log(data));
```

#### 更新卷烟信息
```javascript
fetch('/api/data/update-cigarette', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        cigCode: "42010114",
        cigName: "红金龙(硬爱你爆珠)",
        year: 2024,
        month: 1,
        weekSeq: 1,
        deliveryMethod: "按档位统一投放",
        deliveryEtype: "NULL",
        deliveryArea: "全市",
        distribution: [30,29,28,27,26,25,24,23,22,21,20,19,18,17,16,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1],
        remark: "更新备注"
    })
})
.then(response => response.json())
.then(data => console.log(data));
```

#### 健康检查
```javascript
fetch('/api/common/health')
.then(response => response.json())
.then(data => console.log(data));
```

#### 一键生成分配方案
```javascript
fetch('/api/calculate/generate-distribution-plan?year=2024&month=1&weekSeq=1', {
    method: 'POST'
})
.then(response => response.json())
.then(data => {
    console.log('分配方案生成结果:', data);
    if (data.success) {
        console.log(`成功分配${data.successfulAllocations}种卷烟`);
        console.log(`生成${data.processedCount}条分配记录`);
        console.log(`处理时间: ${data.processingTime}`);
        if (data.deletedExistingData) {
            console.log(`删除了${data.deletedRecords}条现有数据`);
        }
    }
});
```

### cURL测试示例

#### 查询数据
```bash
curl -X POST "http://localhost:28080/api/data/query" \
     -H "Content-Type: application/json" \
     -d '{"year": 2024, "month": 1, "weekSeq": 1}'
```

#### 健康检查
```bash
curl -X GET "http://localhost:28080/api/common/health"
```

#### 计算总实际投放量
```bash
curl -X POST "http://localhost:28080/api/calculate/total-actual-delivery?year=2024&month=1&weekSeq=1"
```

#### 一键生成分配方案
```bash
curl -X POST "http://localhost:28080/api/calculate/generate-distribution-plan?year=2024&month=1&weekSeq=1"
```

---

## 📝 重要说明

### 1. 档位分配数组
- `distribution` 数组包含30个元素，对应D30到D1的档位分配值
- 数组顺序：`[D30, D29, D28, ..., D2, D1]`
- 所有档位值必须为数字类型

### 2. 投放区域格式
- 全市投放：`"全市"`
- 多区域投放：`"区域1,区域2,区域3"` (逗号分隔)
- 区域名称不能包含逗号

### 3. 文件上传限制
- 最大文件大小：10MB
- 支持格式：Excel (.xlsx, .xls)
- 文件编码：UTF-8

### 4. 数据校验
- 所有必填字段不能为空
- 年份、月份、周序号必须为正整数
- 档位分配值必须为非负数

---

## 🚀 版本更新记录

### v2.0 (2025-09-16)
- ✅ 重构控制器架构，拆分为4个专业化控制器
- ✅ 修复档位映射顺序错误
- ✅ 删除废弃的CigaretteDistributionController
- ✅ 优化API路径和响应格式
- ✅ 新增总实际投放量计算接口

### v1.0 (之前版本)
- ✅ 基础卷烟分配功能
- ✅ Excel导入导出
- ✅ 多种投放类型支持

---

**📞 技术支持**: 如有问题请联系开发团队  
**📚 更多文档**: 请参考项目README和源码注释
