
# 卷烟（Cigarette）智能分配系统 - 后端功能说明文档

## 1. 系统概述

本项目是一个基于Spring Boot的卷烟智能分配系统后端服务。其核心功能是根据预设的投放计划和各区域客户数据，通过一系列复杂的优化算法，智能计算出每种卷烟在不同区域、不同客户档位上的最优分配方案。系统支持多种投放策略，并提供灵活的数据导入和管理功能。

该系统的设计采用了动态数据表的策略，使得不同时间周期、不同类型的投放数据能够被有效隔离和管理。

### 1.1. 技术栈

- **核心框架**: Spring Boot 2.7.18
- **数据持久层**: Spring Data JPA, Hibernate
- **数据库**: MySQL 8.0
- **Web框架**: Spring Web (MVC)
- **核心依赖**:
    - `Apache POI`: 用于处理Excel文件的导入导出。
    - `Lombok`: 简化JavaBean的开发。
    - `Spring Cache`: 提供缓存支持，提高性能。

### 1.2. 核心设计思想

- **动态表管理**: 系统的大部分核心数据表（如投放信息、客户数、预测结果）都采用动态表名。表名通常包含年份、月份、周序号或投放类型编码，以此实现数据的版本化和隔离管理。
- **策略模式 (Strategy Pattern)**: 系统核心的分配算法部分采用了策略模式。针对"全市统一投放"、"档位+区县"等不同的投放类型，系统都封装了独立的策略实现类。这种设计使得算法逻辑与主业务流程解耦，极大地提高了系统的可扩展性和可维护性。
- **投放类型识别机制**: 系统通过`DistributionStrategyManager`智能识别投放类型：
    - 当`DELIVERY_METHOD`为"按档位统一投放"或"按档位投放"时，自动匹配全市统一投放策略
    - 当`DELIVERY_METHOD`为"按档位扩展投放"时，根据`DELIVERY_ETYPE`字段值匹配对应的扩展投放策略
    - 系统会自动处理`DELIVERY_ETYPE`字段为`NULL`或空值的情况，确保策略选择的准确性
- **数据驱动**: 整个业务流程由数据驱动。用户首先导入基础数据，然后基于这些数据触发计算，最后对生成的计算结果进行查询和管理。

## 2. 数据库核心表结构

系统主要围绕三类动态表展开工作：**输入信息表**、**客户数表**和**预测结果表**。

### 2.1. 卷烟投放基础信息表 (`cigarette_distribution_info_{Y}_{M}_{W}`)

- **命名规则**: `cigarette_distribution_info_` + 年份 + `_` + 月份 + `_` + 周序号。例如: `cigarette_distribution_info_2025_9_3`。
- **作用**: 存储卷烟投放的**输入**参数。这是触发分配计算的原始依据。
- **核心字段**:
    - `CIG_CODE`, `CIG_NAME`: 卷烟的唯一标识。
    - `ADV`, `URS`: 预设的投放量目标值。
    - `DELIVERY_METHOD`: 投放方法，支持以下几种类型：
        - `"按档位统一投放"`: 全市范围内的统一投放策略
        - `"按档位投放"`: 等同于"按档位统一投放"的另一种表述方式
        - `"按档位扩展投放"`: 基于特定维度（区县、市场类型等）的精细化投放策略
    - `DELIVERY_ETYPE`: 扩展投放类型，仅在`DELIVERY_METHOD`为"按档位扩展投放"时有效：
        - `"档位+区县"`: 按区县维度进行分配
        - `"档位+市场类型"`: 按城网/农网维度进行分配
        - `"档位+城乡分类代码"`: 按城乡属性维度进行分配
        - `"档位+业态"`: 按业态类型维度进行分配
        - `NULL` 或 `空值`: 当投放方法为"按档位统一投放"或"按档位投放"时，此字段为空
    - `DELIVERY_AREA`: 投放区域（可能为单个区域，或用逗号分隔的多个区域）。

### 2.2. 区域客户数表 (`region_clientNum_{P}_{S}`)

- **命名规则**: `region_clientNum_` + 主序号 + `_` + 子序号。例如: `region_clientNum_1_1`。
- **作用**: 存储不同投放类型下，各区域内30个档位的客户数量。这是计算“实际投放量”的**核心依据**。
- **核心字段**:
    - `region`: 区域标识（根据主序号的不同，可能代表“区县”、“市场类型”等）。
    - `D30`, `D29`, ..., `D1`: 分别对应30个档位的客户数量。

### 2.3. 卷烟分配预测结果表 (`cigarette_distribution_prediction_{Y}_{M}_{W}`)

- **命名规则**: `cigarette_distribution_prediction_` + 年份 + `_` + 月份 + `_` + 周序号。例如: `cigarette_distribution_prediction_2025_9_3`。
- **作用**: 存储算法计算出的**输出**结果。
- **核心字段**:
    - `CIG_CODE`, `CIG_NAME`, `DELIVERY_AREA`: 标识了为哪个卷烟的哪个区域生成的分配方案。
    - `D30`, `D29`, ..., `D1`: 算法计算出的，分配给该区域各档位的卷烟数量。
    - `ACTUAL_DELIVERY`: 根据分配方案和客户数计算出的“实际投放量”。
    - `DEPLOYINFO_CODE`: 一个紧凑的“编码表达式”，用于唯一表示和快速识别此条分配方案的特征。

## 3. 核心业务流程

系统的标准业务流程分为数据导入、分配计算和数据管理三个主要阶段。

![业务流程图](https://via.placeholder.com/800x200.png?text=Import+Data+->+Trigger+Calculation+->+Manage+Results)

1.  **数据导入**:
    - 用户通过Excel模板准备好“卷烟投放基础信息”和“区域客户数”两类数据。
    - 调用对应的API接口将Excel文件上传至系统。
    - 后端`ExcelImportService`服务负责解析文件，并根据规则创建或更新对应的动态数据库表。

2.  **分配计算**:
    - 用户通过API接口触发对指定时间周期（年、月、周）的分配计算。
    - 后端`DistributionCalculateService`作为总调度，从`cigarette_distribution_info_*`表中读取待处理的卷烟列表。
    - 针对每一条卷烟记录，通过`DistributionStrategyManager`（策略管理器）根据投放类型动态选择匹配的分配策略：
        - **统一投放处理**: 当`DELIVERY_METHOD`为"按档位统一投放"或"按档位投放"时，且`DELIVERY_ETYPE`为`NULL`或空值时，系统选择`CityDistributionStrategy`（全市统一投放策略）
        - **扩展投放处理**: 当`DELIVERY_METHOD`为"按档位扩展投放"时，根据`DELIVERY_ETYPE`的具体值选择对应策略（如`CountyDistributionStrategy`、`MarketDistributionStrategy`等）
    - 所选策略将调用其对应的算法服务（例如，`CountyCigaretteDistributionService`），该服务会从相应的`region_clientNum_*`表中加载客户数数据。
    - 最终，核心算法（例如，`countyCigaretteDistributionAlgorithm`）执行数学优化计算，生成"分配矩阵"。
    - `DistributionCalculateService`接收分配矩阵，计算每个区域的"实际投放量"，并通过`EncodeDecodeService`生成"编码表达式"，最终将完整结果写入`cigarette_distribution_prediction_*`结果表中。

3.  **数据管理**:
    - 计算完成后，用户可通过API接口对`cigarette_distribution_prediction_*`表中的结果数据进行查询、修改、删除等操作。
    - 系统支持单条记录的精细化修改，也支持通过"编码表达式"进行高效的批量更新。

## 4. 投放类型与策略映射

系统支持的投放类型组合及其对应的处理策略如下：

| 投放方法 | 扩展投放类型 | 策略类型 | 客户数表 | 说明 |
|---------|-------------|---------|---------|------|
| `按档位统一投放` | `NULL` 或 `空值` | 全市统一投放 | `region_clientNum_0_1` | 全市范围内的统一分配 |
| `按档位投放` | `NULL` 或 `空值` | 全市统一投放 | `region_clientNum_0_1` | 等同于"按档位统一投放" |
| `按档位扩展投放` | `档位+区县` | 区县分配 | `region_clientNum_1_1` | 按区县精准投放 |
| `按档位扩展投放` | `档位+市场类型` | 市场类型分配 | `region_clientNum_2_1` | 按城网/农网分类投放 |
| `按档位扩展投放` | `档位+城乡分类代码` | 城乡分类分配 | `region_clientNum_3_1` | 按城乡属性分类投放 |
| `按档位扩展投放` | `档位+业态` | 业态分配 | `region_clientNum_4_1` | 按业态类型分类投放 |

**注意事项**:
- 表名中的子序号（最后一位数字）用于区分是否支持双周上浮功能，`_1`表示非双周上浮，`_2`表示双周上浮
- `DELIVERY_METHOD`字段支持"按档位统一投放"和"按档位投放"两种等价表述
- 当选择统一投放策略时，`DELIVERY_ETYPE`字段应为`NULL`或空值
- 系统会自动根据投放类型组合选择对应的算法策略和客户数据源

## 5. API接口说明

所有API接口均以 `/api` 为前缀。

### 5.1. 数据导入 (`/api/import`)

-   **`POST /cigarette-info`**: 导入"卷烟投放基础信息"Excel。
-   **`POST /region-clientnum`**: 导入"区域客户数"Excel。

### 5.2. 分配计算 (`/api/calculate`)

-   **`POST /generate-distribution-plan`**: **（核心功能）** 一键生成分配方案。此接口会先删除指定周期的旧数据，然后完整执行一次全新的分配计算流程。
-   **`POST /write-back`**: 执行分配计算并将结果写入数据库（`generate-distribution-plan`的子步骤）。
-   **`POST /total-actual-delivery`**: 计算并返回指定周期内，每种卷烟的实际投放总量。

### 5.3. 数据管理 (`/api/data`)

-   **`POST /query`**: 查询指定周期的分配结果数据，返回的数据会附加预投放量、总实际投放量、编码表达式等多种辅助信息。
-   **`POST /update-cigarette`**: 更新单条分配记录（例如，手动修改某个区域的档位分配值）。
-   **`POST /delete-delivery-areas`**: 删除指定卷烟的一个或多个投放区域的分配记录。
-   **`POST /batch-update-from-expressions`**: **（高级功能）** 根据"编码表达式"进行批量更新。这是一个非常强大的接口，允许用户通过简洁的编码字符串快速调整复杂的投放方案。

### 5.4. 通用接口 (`/api/common`)

-   **`GET /health`**: 系统健康检查接口，用于监控服务状态。

## 6. 核心算法与编码规则

### 6.1. 分配算法概述

-   **目标**: 算法的核心目标是在满足一系列约束条件下，使“总实际投放量”尽可能逼近“预设投放量”。
-   **核心约束**: **非递增约束**。即对于任何一个区域，高档位（如D30）的分配数量必须**大于或等于**低档位（如D29）的分配数量。
-   **实现步骤**:
    1.  **粗调（Greedy Fill）**: 从高档位开始，以整数为单位逐步增加分配量，直到总投放量接近但不超过目标。
    2.  **微调（Iterative Refinement）**: 在粗调的基础上，通过多次迭代，对分配矩阵进行微小的、能减小误差的调整（增加或减少）。
    3.  **强制约束**: 在最后阶段，强制修正分配矩阵，确保所有数据都满足“非递增约束”。

### 6.2. 编码/解码规则

`EncodeDecodeService`服务提供了一套将复杂投放方案与简洁字符串进行双向转换的机制。

-   **编码 (`Encode`)**:
    -   系统会自动分析同一种卷烟下所有区域的分配方案。
    -   将档位设置（D30到D1的值）完全相同的区域**聚合**到一组。
    -   根据投放类型生成对应的编码字符串：
        - **统一投放编码**: 当投放方法为"按档位统一投放"或"按档位投放"时，生成`A`类型编码，例如 `A(5x9+5x8+10x7+10x6)`
            - `A`: 代表按档位统一投放
            - `(5x9+...)`: 代表档位分配方案
        - **扩展投放编码**: 当投放方法为"按档位扩展投放"时，生成`B`类型编码，例如 `B1(3+4)(5x9+5x8+10x7+10x6)`
            - `B1`: 代表"按档位扩展投放 - 档位+区县"
            - `(3+4)`: 代表这组包含编码为3（房县）和4（郧西）的区域
            - `(5x9+...)`: 代表档位分配方案
-   **解码 (`Decode`)**: 将上述编码字符串翻译回人类可读的描述，如“按档位扩展投放、档位+区县、房县郧西、(5x9+...)”。
-   **解析 (`Parse`)**: 将编码字符串解析为一个结构化的数据对象，为批量更新等高级功能提供程序接口。

此功能是系统实现高效数据管理和高级编辑能力的关键。
