# ä¸€é”®ç”Ÿæˆåˆ†é…æ–¹æ¡ˆAPI - æ•°æ®æµè¯¦è§£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¦

**APIåç§°**: ä¸€é”®ç”Ÿæˆåˆ†é…æ–¹æ¡ˆ  
**æ¥å£åœ°å€**: `/api/calculate/generate-distribution-plan`  
**è¯·æ±‚æ–¹å¼**: POST  
**æ ¸å¿ƒåŠŸèƒ½**: åˆ é™¤æ—§æ•°æ® â†’ æ‰§è¡Œç®—æ³•è®¡ç®— â†’ å†™å›æ–°æ•°æ®  
**æœ€åæ›´æ–°**: 2025-10-19

---

## ğŸ¯ APIæ¦‚è¿°

### ä¸¤ä¸ªæ ¸å¿ƒæ¥å£

| æ¥å£ | åŠŸèƒ½ | åŒºåˆ« |
|-----|------|------|
| `/api/calculate/write-back` | æ‰§è¡Œè®¡ç®—å¹¶å†™å› | ç›´æ¥å†™å›ï¼Œå¯èƒ½è¦†ç›– |
| `/api/calculate/generate-distribution-plan` | ä¸€é”®ç”Ÿæˆåˆ†é…æ–¹æ¡ˆ | å…ˆåˆ é™¤åå†™å›ï¼Œå®Œå…¨é‡å»º |

**æœ¬æ–‡æ¡£é‡ç‚¹**: `/api/calculate/generate-distribution-plan`

---

## ğŸ“¡ è¯·æ±‚å‚æ•°è¯´æ˜

### åŸºæœ¬å‚æ•°ï¼ˆå¿…å¡«ï¼‰

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|-------|------|------|------|------|
| `year` | Integer | âœ… | å¹´ä»½ (2020-2099) | 2025 |
| `month` | Integer | âœ… | æœˆä»½ (1-12) | 10 |
| `weekSeq` | Integer | âœ… | å‘¨åºå· (1-5) | 1 |

### æ‰©å±•å‚æ•°ï¼ˆå¯é€‰ï¼‰

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ | é»˜è®¤å€¼ | é€‚ç”¨ä¸šåŠ¡ç±»å‹ |
|-------|------|------|------|--------|------------|
| `urbanRatio` | BigDecimal | âŒ | åŸç½‘åˆ†é…æ¯”ä¾‹ | 0.4 (40%) | ä»…æ¡£ä½+å¸‚åœºç±»å‹ |
| `ruralRatio` | BigDecimal | âŒ | å†œç½‘åˆ†é…æ¯”ä¾‹ | 0.6 (60%) | ä»…æ¡£ä½+å¸‚åœºç±»å‹ |

**ç‰¹åˆ«è¯´æ˜**: 
- æ¯”ä¾‹å‚æ•°åªå¯¹"æ¡£ä½+å¸‚åœºç±»å‹"ç”Ÿæ•ˆ
- ä¸”ä»…å½“å¾…æŠ•æ”¾åŒºåŸŸåŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘æ—¶æ‰ä½¿ç”¨

---

## ğŸ”„ å®Œæ•´æ•°æ®æµï¼ˆç«¯åˆ°ç«¯ï¼‰

### æ•°æ®æµæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å‰ç«¯å‘èµ·è¯·æ±‚                                                    â”‚
â”‚    POST /api/calculate/generate-distribution-plan               â”‚
â”‚    å‚æ•°: year=2025, month=10, weekSeq=1                         â”‚
â”‚          urbanRatio=0.45, ruralRatio=0.55 (å¯é€‰)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Controllerå±‚æ¥æ”¶ï¼ˆDistributionCalculateControllerï¼‰           â”‚
â”‚    - æ¥æ”¶å¹¶éªŒè¯å‚æ•°                                                â”‚
â”‚    - æ„å»ºmarketRatios Mapï¼ˆå¦‚æœæœ‰æ¯”ä¾‹å‚æ•°ï¼‰                        â”‚
â”‚    - è°ƒç”¨Serviceå±‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Serviceå±‚æ£€æŸ¥ï¼ˆDistributionCalculateServiceImplï¼‰              â”‚
â”‚    - æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—§æ•°æ®                                             â”‚
â”‚    - å¦‚æœå­˜åœ¨ï¼Œè°ƒç”¨DataManagementServiceåˆ é™¤                       â”‚
â”‚    - è°ƒç”¨getAndwriteBackAllocationMatrix()                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æŸ¥è¯¢å·çƒŸåŸºç¡€æ•°æ®ï¼ˆJdbcTemplateï¼‰                                â”‚
â”‚    - è¡¨å: cigarette_distribution_info_{year}_{month}_{weekSeq}â”‚
â”‚    - SQL: SELECT CIG_CODE, CIG_NAME, ADV, DELIVERY_AREA, ...   â”‚
â”‚    - ç»“æœ: List<Map<String, Object>> advDataList               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. éå†æ¯ä¸ªå·çƒŸï¼ŒæŒ‰ä¸šåŠ¡ç±»å‹åˆ†åˆ«å¤„ç†                                  â”‚
â”‚    for each cigarette in advDataList:                          â”‚
â”‚        æ ¹æ® deliveryMethod + deliveryEtype ç¡®å®šä¸šåŠ¡ç±»å‹           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                                                 â”‚
                 â–¼                                                 â–¼
        [æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ]                                   [æ¡£ä½+ä¸šæ€]
        [æ¡£ä½+åŒºå¿]                                          [æ¡£ä½+å¸‚åœºç±»å‹]
        [æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾]                                       ...

ï¼ˆä»¥ä¸‹è¯¦ç»†å±•å¼€å„ä¸šåŠ¡ç±»å‹çš„æ•°æ®æµï¼‰
```

---

## ğŸ“Š å„ä¸šåŠ¡ç±»å‹è¯¦ç»†æ•°æ®æµ

### ç±»å‹1: æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç 

#### æ•°æ®æµç¨‹

```
å·çƒŸæ•°æ®
â”œâ”€ deliveryMethod: "æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾"
â”œâ”€ deliveryEtype: "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç "
â”œâ”€ deliveryArea: "ä¸»åŸåŒº,ä¹¡ä¸­å¿ƒåŒº,æ‘åº„"
â””â”€ adv: 10000

        â†“

DistributionStrategyManager.getStrategy()
        â†“
è¿”å›: UrbanRuralDistributionStrategy

        â†“

UrbanRuralDistributionStrategy.getTargetList()
â”œâ”€ è°ƒç”¨: CommonService.getAllRegionList("æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾", "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ")
â”‚   â””â”€ æŸ¥è¯¢: region_clientNum_3_1 è¡¨
â”‚   â””â”€ è¿”å›: ["ä¸»åŸåŒº", "ä¹¡ä¸­å¿ƒåŒº", "åŸä¹¡ç»“åˆåŒº", "æ‘åº„", ...]
â”œâ”€ è°ƒç”¨: KmpMatcher.matchPatterns("ä¸»åŸåŒº,ä¹¡ä¸­å¿ƒåŒº,æ‘åº„", allRegions)
â””â”€ è¿”å›: ["ä¸»åŸåŒº", "ä¹¡ä¸­å¿ƒåŒº", "æ‘åº„"]

        â†“

UrbanRuralDistributionStrategy.calculateMatrix()
â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µ:
â”‚   â””â”€ CommonService.buildRegionCustomerMatrix("æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾", "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ")
â”‚       â””â”€ æŸ¥è¯¢: region_clientNum_3_1
â”‚       â””â”€ è¿”å›: RegionCustomerMatrix {
â”‚             regionNames: ["ä¸»åŸåŒº", "ä¹¡ä¸­å¿ƒåŒº", ...],
â”‚             customerMatrix: [[D30, D29, ..., D1], [...], ...]
â”‚          }
â”‚
â”œâ”€ ç­›é€‰ç›®æ ‡åŒºåŸŸçš„å®¢æˆ·æ•°:
â”‚   â”œâ”€ ä¸»åŸåŒºçš„30ä¸ªæ¡£ä½å®¢æˆ·æ•°: [100, 95, 90, ...]
â”‚   â”œâ”€ ä¹¡ä¸­å¿ƒåŒºçš„30ä¸ªæ¡£ä½å®¢æˆ·æ•°: [50, 48, 45, ...]
â”‚   â””â”€ æ‘åº„çš„30ä¸ªæ¡£ä½å®¢æˆ·æ•°: [30, 28, 26, ...]
â”‚
â””â”€ è°ƒç”¨ç®—æ³•è®¡ç®—:
    â””â”€ UrbanRuralClassificationCodeDistributionAlgorithm.calculateDistribution()
        â”œâ”€ è¾“å…¥: targetList=["ä¸»åŸåŒº","ä¹¡ä¸­å¿ƒåŒº","æ‘åº„"]
        â”‚        customerMatrix=[3][30]
        â”‚        targetAmount=10000
        â”‚
        â”œâ”€ æ‰§è¡Œå¤šè½®ç²—è°ƒï¼ˆ100è½®ä¸Šé™ï¼‰
        â”œâ”€ ç”Ÿæˆ3ä¸ªå€™é€‰æ–¹æ¡ˆ
        â”œâ”€ é€‰æ‹©è¯¯å·®æœ€å°çš„æ–¹æ¡ˆ
        â”œâ”€ å¼ºåˆ¶éé€’å¢çº¦æŸ
        â”‚
        â””â”€ è¾“å‡º: allocationMatrix = [
              [5, 5, 5, 4, 4, ...],  // ä¸»åŸåŒºå„æ¡£ä½åˆ†é…
              [5, 5, 5, 4, 4, ...],  // ä¹¡ä¸­å¿ƒåŒºå„æ¡£ä½åˆ†é…
              [5, 5, 5, 4, 4, ...]   // æ‘åº„å„æ¡£ä½åˆ†é…
           ]

        â†“

è®¡ç®—å®é™…æŠ•æ”¾é‡ï¼ˆæ¯ä¸ªåŒºåŸŸï¼‰
for each region in targetList:
    actualDelivery = Î£(allocationMatrix[i][j] Ã— customerMatrix[i][j])
    
ç¤ºä¾‹:
â”œâ”€ ä¸»åŸåŒºå®é™…æŠ•æ”¾ = 5Ã—100 + 5Ã—95 + 5Ã—90 + ... = 4500æ¡
â”œâ”€ ä¹¡ä¸­å¿ƒåŒºå®é™…æŠ•æ”¾ = 5Ã—50 + 5Ã—48 + 5Ã—45 + ... = 2500æ¡
â””â”€ æ‘åº„å®é™…æŠ•æ”¾ = 5Ã—30 + 5Ã—28 + 5Ã—26 + ... = 1500æ¡

        â†“

ç”Ÿæˆç¼–ç è¡¨è¾¾å¼
â”œâ”€ è°ƒç”¨: EncodeDecodeService.encodeForSpecificArea()
â”œâ”€ ä¸»åŸåŒºç¼–ç ç¤ºä¾‹: "B4â‘ (5Ã—9+5Ã—8+10Ã—7+10Ã—6)"
â”œâ”€ ä¹¡ä¸­å¿ƒåŒºç¼–ç ç¤ºä¾‹: "B4â‘¥(5Ã—9+5Ã—8+10Ã—7+10Ã—6)"
â””â”€ æ‘åº„ç¼–ç ç¤ºä¾‹: "B4â‘¦(5Ã—9+5Ã—8+10Ã—7+10Ã—6)"

**ç¼–ç è§„åˆ™**: è¯¦è§ `docs/ç¼–ç è§„åˆ™è¡¨.md`

**ç¼–ç æ ¼å¼è¯´æ˜**:
- `B`: æŠ•æ”¾ç±»å‹ç¼–ç ï¼ˆB=æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾ï¼‰
- `4`: æ‰©å±•ç±»å‹ç¼–ç ï¼ˆ4=æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ï¼‰
- `â‘ â‘¥â‘¦`: åŒºåŸŸç¼–ç ï¼ˆâ‘ =ä¸»åŸåŒºï¼Œâ‘¥=ä¹¡ä¸­å¿ƒåŒºï¼Œâ‘¦=æ‘åº„ï¼‰
- `(5Ã—9+5Ã—8+10Ã—7+10Ã—6)`: æ¡£ä½å‹ç¼©ç¼–ç 
  - 5Ã—9: D30-D26å…±5ä¸ªæ¡£ä½ï¼Œæ¯æ¡£åˆ†é…9
  - 5Ã—8: D25-D21å…±5ä¸ªæ¡£ä½ï¼Œæ¯æ¡£åˆ†é…8
  - 10Ã—7: D20-D11å…±10ä¸ªæ¡£ä½ï¼Œæ¯æ¡£åˆ†é…7
  - 10Ã—6: D10-D1å…±10ä¸ªæ¡£ä½ï¼Œæ¯æ¡£åˆ†é…6

        â†“

å†™å›æ•°æ®åº“
è¡¨: cigarette_distribution_prediction_{year}_{month}_{weekSeq}
è®°å½•1: {cigCode, cigName, deliveryArea:"ä¸»åŸåŒº", D30:5, D29:5, ..., actualDelivery:4500}
è®°å½•2: {cigCode, cigName, deliveryArea:"ä¹¡ä¸­å¿ƒåŒº", D30:5, D29:5, ..., actualDelivery:2500}
è®°å½•3: {cigCode, cigName, deliveryArea:"æ‘åº„", D30:5, D29:5, ..., actualDelivery:1500}
```

---

### ç±»å‹2: æ¡£ä½+ä¸šæ€

#### æ•°æ®æµç¨‹

```
å·çƒŸæ•°æ®
â”œâ”€ deliveryMethod: "æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾"
â”œâ”€ deliveryEtype: "æ¡£ä½+ä¸šæ€"
â”œâ”€ deliveryArea: "ä¾¿åˆ©åº—,è¶…å¸‚,å•†åœº"
â””â”€ adv: 20000

        â†“

DistributionStrategyManager.getStrategy()
        â†“
è¿”å›: BusinessFormatDistributionStrategy

        â†“

BusinessFormatDistributionStrategy.getTargetList()
â”œâ”€ è°ƒç”¨: CommonService.getAllRegionList("æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾", "æ¡£ä½+ä¸šæ€")
â”‚   â””â”€ æŸ¥è¯¢: region_clientNum_4_1 è¡¨
â”‚   â””â”€ è¿”å›: ["ä¾¿åˆ©åº—", "è¶…å¸‚", "å•†åœº", "çƒŸè‰ä¸“ä¸šåº—", ...]
â”œâ”€ è°ƒç”¨: KmpMatcher.matchPatterns("ä¾¿åˆ©åº—,è¶…å¸‚,å•†åœº", allFormats)
â””â”€ è¿”å›: ["ä¾¿åˆ©åº—", "è¶…å¸‚", "å•†åœº"]

        â†“

BusinessFormatDistributionStrategy.calculateMatrix()
â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µ: region_clientNum_4_1
â”œâ”€ ç­›é€‰ç›®æ ‡ä¸šæ€çš„å®¢æˆ·æ•°
â””â”€ è°ƒç”¨: BussinessFormatDistributionAlgorithm.calculateDistribution()
    â””â”€ è¾“å‡º: allocationMatrix = [
          [8, 8, 7, 7, ...],  // ä¾¿åˆ©åº—
          [8, 8, 7, 7, ...],  // è¶…å¸‚
          [8, 8, 7, 7, ...]   // å•†åœº
       ]

        â†“

è®¡ç®—å®é™…æŠ•æ”¾é‡ + ç”Ÿæˆç¼–ç  + å†™å›æ•°æ®åº“
ï¼ˆä¸æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ç›¸åŒæµç¨‹ï¼‰
```

---

### ç±»å‹3: æ¡£ä½+å¸‚åœºç±»å‹ â­

#### æ•°æ®æµç¨‹ï¼ˆå«æ¯”ä¾‹å‚æ•°ï¼‰

```
å·çƒŸæ•°æ®
â”œâ”€ deliveryMethod: "æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾"
â”œâ”€ deliveryEtype: "æ¡£ä½+å¸‚åœºç±»å‹"
â”œâ”€ deliveryArea: "åŸç½‘,å†œç½‘"
â””â”€ adv: 15000

å‰ç«¯ä¼ å…¥çš„æ¯”ä¾‹å‚æ•°
â”œâ”€ urbanRatio: 0.45 (45%)
â””â”€ ruralRatio: 0.55 (55%)

        â†“

Controllerå±‚
â”œâ”€ æ¥æ”¶å‚æ•°: year, month, weekSeq, urbanRatio, ruralRatio
â”œâ”€ æ„å»ºmarketRatios Map:
â”‚   marketRatios = {
â”‚       "urbanRatio": 0.45,
â”‚       "ruralRatio": 0.55
â”‚   }
â””â”€ è°ƒç”¨: distributionService.getAndwriteBackAllocationMatrix(
        year, month, weekSeq, marketRatios)

        â†“

Serviceå±‚ï¼ˆDistributionCalculateServiceImplï¼‰
â”œâ”€ ä»æ•°æ®åº“æŸ¥è¯¢å·çƒŸæ•°æ®
â”œâ”€ éå†æ¯ä¸ªå·çƒŸ
â””â”€ å½“ deliveryEtype = "æ¡£ä½+å¸‚åœºç±»å‹" æ—¶:
    â”œâ”€ ä»marketRatiosä¸­æå–æ¯”ä¾‹å‚æ•°
    â””â”€ æ„å»ºextraParams Map:
        extraParams = {
            "urbanRatio": 0.45,
            "ruralRatio": 0.55
        }

        â†“

ç­–ç•¥å±‚ï¼ˆMarketDistributionStrategyï¼‰
â”œâ”€ getTargetList("åŸç½‘,å†œç½‘")
â”‚   â””â”€ è¿”å›: ["åŸç½‘", "å†œç½‘"]
â”‚
â””â”€ calculateMatrix(targetList, 15000, extraParams)
    â”œâ”€ æ£€æŸ¥æ˜¯å¦åŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘:
    â”‚   hasUrban = true (åŒ…å«"åŸ")
    â”‚   hasRural = true (åŒ…å«"å†œ")
    â”‚   hasBoth = true âœ…
    â”‚
    â”œâ”€ ç¡®å®šæ¯”ä¾‹:
    â”‚   if (hasBoth && extraParamsæœ‰æ¯”ä¾‹) {
    â”‚       urbanRatio = 0.45  // ä½¿ç”¨å‰ç«¯ä¼ å…¥çš„
    â”‚       ruralRatio = 0.55
    â”‚   } else {
    â”‚       urbanRatio = 0.4   // ä½¿ç”¨é»˜è®¤å€¼
    â”‚       ruralRatio = 0.6
    â”‚   }
    â”‚
    â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µ: region_clientNum_2_1
    â”‚   â”œâ”€ åŸç½‘å®¢æˆ·æ•°: [150, 145, 140, ...]
    â”‚   â””â”€ å†œç½‘å®¢æˆ·æ•°: [80, 78, 75, ...]
    â”‚
    â””â”€ è°ƒç”¨ç®—æ³•:
        MarketProportionalCigaretteDistributionAlgorithm.calculateDistribution(
            targetList, customerMatrix, 15000, 0.45, 0.55)
        
        â”œâ”€ æŒ‰æ¯”ä¾‹è®¡ç®—å„ç½‘ç»œç›®æ ‡æŠ•æ”¾é‡:
        â”‚   urbanTarget = 15000 Ã— 0.45 = 6750æ¡
        â”‚   ruralTarget = 15000 Ã— 0.55 = 8250æ¡
        â”‚
        â”œâ”€ åˆ†åˆ«å¯¹åŸç½‘å’Œå†œç½‘æ‰§è¡Œæ ¸å¿ƒç®—æ³•
        â”‚   â”œâ”€ åŸç½‘åˆ†é…: runCoreAlgorithm(["åŸç½‘"], ..., 6750)
        â”‚   â”‚   â””â”€ è¾“å‡º: [[7, 7, 6, 6, ...]]
        â”‚   â””â”€ å†œç½‘åˆ†é…: runCoreAlgorithm(["å†œç½‘"], ..., 8250)
        â”‚       â””â”€ è¾“å‡º: [[9, 9, 8, 8, ...]]
        â”‚
        â””â”€ åˆå¹¶ç»“æœ:
            allocationMatrix = [
                [7, 7, 6, 6, ...],  // åŸç½‘
                [9, 9, 8, 8, ...]   // å†œç½‘
            ]

        â†“

è®¡ç®—å®é™…æŠ•æ”¾é‡
â”œâ”€ åŸç½‘å®é™…æŠ•æ”¾ = Î£(7Ã—150 + 7Ã—145 + ...) â‰ˆ 6750æ¡
â””â”€ å†œç½‘å®é™…æŠ•æ”¾ = Î£(9Ã—80 + 9Ã—78 + ...) â‰ˆ 8250æ¡
æ€»è®¡: 15000æ¡ âœ…

        â†“

ç”Ÿæˆç¼–ç è¡¨è¾¾å¼ + å†™å›æ•°æ®åº“
è®°å½•1: {deliveryArea:"åŸç½‘", D30:7, ..., actualDelivery:6750}
è®°å½•2: {deliveryArea:"å†œç½‘", D30:9, ..., actualDelivery:8250}
```

---

### ç±»å‹4: æ¡£ä½+åŒºå¿

#### æ•°æ®æµç¨‹

```
å·çƒŸæ•°æ®
â”œâ”€ deliveryEtype: "æ¡£ä½+åŒºå¿"
â”œâ”€ deliveryArea: "æˆ¿å¿,éƒ§è¥¿,ç«¹å±±"
â””â”€ adv: 8000

        â†“

CountyDistributionStrategy
â”œâ”€ getTargetList() â†’ ["æˆ¿å¿", "éƒ§è¥¿", "ç«¹å±±"]
â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µ: region_clientNum_1_1
â””â”€ è°ƒç”¨: countyCigaretteDistributionAlgorithm.calculateDistribution()
    â””â”€ è¾“å‡º: allocationMatrix (ä¸åŸä¹¡åˆ†ç±»ä»£ç ç›¸åŒç®—æ³•)

        â†“

å†™å›3æ¡è®°å½•ï¼ˆæˆ¿å¿ã€éƒ§è¥¿ã€ç«¹å±±å„1æ¡ï¼‰
```

---

### ç±»å‹5: æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾

#### æ•°æ®æµç¨‹

```
å·çƒŸæ•°æ®
â”œâ”€ deliveryMethod: "æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾"
â”œâ”€ deliveryEtype: null
â”œâ”€ deliveryArea: ä»»æ„ï¼ˆä¼šè¢«å¿½ç•¥ï¼‰
â””â”€ adv: 50000

        â†“

CityDistributionStrategy
â”œâ”€ getTargetList() â†’ ["å…¨å¸‚"] (å›ºå®š)
â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µ: region_clientNum_0_1
â””â”€ è°ƒç”¨: CityCigaretteDistributionAlgorithm.calculateDistribution()
    â””â”€ è¾“å‡º: allocationMatrix (å•è¡Œï¼Œå…¨å¸‚æ±‡æ€»)

        â†“

å†™å›1æ¡è®°å½•ï¼ˆå…¨å¸‚ï¼‰
```

---

## ğŸ” æ•°æ®æµå…³é”®èŠ‚ç‚¹è¯¦è§£

### èŠ‚ç‚¹1: ç­–ç•¥é€‰æ‹©ï¼ˆDistributionStrategyManagerï¼‰

```java
// æ ¹æ®æŠ•æ”¾æ–¹æ³•å’ŒæŠ•æ”¾ç±»å‹é€‰æ‹©ç­–ç•¥
DistributionStrategy strategy = strategyManager.getStrategy(deliveryMethod, deliveryEtype);

// æ˜ å°„å…³ç³»
æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾ + null          â†’ CityDistributionStrategy
æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾ + "æ¡£ä½+åŒºå¿"    â†’ CountyDistributionStrategy
æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾ + "æ¡£ä½+å¸‚åœºç±»å‹" â†’ MarketDistributionStrategy
æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾ + "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç " â†’ UrbanRuralDistributionStrategy
æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾ + "æ¡£ä½+ä¸šæ€"    â†’ BusinessFormatDistributionStrategy
```

---

### èŠ‚ç‚¹2: ç›®æ ‡åˆ—è¡¨è§£æ

```java
// ç»Ÿä¸€çš„è§£ææµç¨‹
List<String> targetList = strategy.getTargetList(deliveryArea);

// å†…éƒ¨æµç¨‹ï¼ˆä»¥æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ä¸ºä¾‹ï¼‰
1. è°ƒç”¨CommonServiceè·å–æ‰€æœ‰å¯ç”¨åŒºåŸŸ
   allRegions = ["ä¸»åŸåŒº", "ä¹¡ä¸­å¿ƒåŒº", "åŸä¹¡ç»“åˆåŒº", "æ‘åº„", ...]
   
2. ä½¿ç”¨KmpMatcherè¿›è¡Œæ¨¡å¼åŒ¹é…
   pattern = "ä¸»åŸåŒº,ä¹¡ä¸­å¿ƒåŒº,æ‘åº„"
   result = ["ä¸»åŸåŒº", "ä¹¡ä¸­å¿ƒåŒº", "æ‘åº„"]
   
3. è¿”å›åŒ¹é…ç»“æœ
```

**è¯´æ˜**: 
- CommonServiceç»Ÿä¸€ç®¡ç†åŒºåŸŸåˆ—è¡¨
- KmpMatcherç»Ÿä¸€å¤„ç†æ¨¡å¼åŒ¹é…
- å„ç­–ç•¥ç±»ä½¿ç”¨ç›¸åŒçš„è§£ææœºåˆ¶

---

### èŠ‚ç‚¹3: å®¢æˆ·æ•°çŸ©é˜µè·å–

```java
// ç»Ÿä¸€çš„è·å–æµç¨‹
BigDecimal[][] customerMatrix = strategy.getCustomerMatrix();

// å†…éƒ¨æµç¨‹
1. è°ƒç”¨CommonService.buildRegionCustomerMatrix()
   â”œâ”€ æ ¹æ®æŠ•æ”¾ç±»å‹ç¡®å®šè¡¨å
   â”‚   æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç  â†’ region_clientNum_3_1
   â”‚   æ¡£ä½+ä¸šæ€ â†’ region_clientNum_4_1
   â”‚   æ¡£ä½+å¸‚åœºç±»å‹ â†’ region_clientNum_2_1
   â”‚   ...
   â”‚
   â”œâ”€ æŸ¥è¯¢è¯¥è¡¨çš„æ‰€æœ‰æ•°æ®
   â”‚   SELECT region, D30, D29, ..., D1 FROM region_clientNum_X_X
   â”‚
   â””â”€ æ„å»ºçŸ©é˜µ
       regionNames = ["åŒºåŸŸ1", "åŒºåŸŸ2", ...]
       customerMatrix = [
           [D30, D29, ..., D1],  // åŒºåŸŸ1
           [D30, D29, ..., D1],  // åŒºåŸŸ2
           ...
       ]

2. ç­›é€‰ç›®æ ‡åŒºåŸŸçš„æ•°æ®
   targetCustomerMatrix = ä»å®Œæ•´çŸ©é˜µä¸­ç­›é€‰targetListå¯¹åº”çš„è¡Œ

3. ç¼“å­˜ï¼ˆ@Cacheableï¼‰
   ç›¸åŒæŠ•æ”¾ç±»å‹çš„åç»­è¯·æ±‚ç›´æ¥ä»ç¼“å­˜è¯»å–
```

---

### èŠ‚ç‚¹4: ç®—æ³•è®¡ç®—

```java
// ç®—æ³•è°ƒç”¨
BigDecimal[][] allocationMatrix = distributionAlgorithm.calculateDistribution(
    targetList, targetCustomerMatrix, targetAmount);

// æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ã€æ¡£ä½+ä¸šæ€ã€æ¡£ä½+åŒºå¿ä½¿ç”¨ç›¸åŒç®—æ³•é€»è¾‘:
// V3 å¤šè½®ç²—è°ƒä¼˜åŒ–ç®—æ³•

1. åˆå§‹åŒ–åˆ†é…çŸ©é˜µï¼ˆå…¨0ï¼‰
2. å¤šè½®ç²—è°ƒ
   â”œâ”€ ä»D30åˆ°D1é€åˆ—å°è¯•å¢åŠ 
   â”œâ”€ æ•´åˆ—+1æ“ä½œ
   â”œâ”€ æœ€å¤š100è½®
   â””â”€ æ¥è¿‘ç›®æ ‡ï¼ˆ<5%ï¼‰æ—¶åœæ­¢
3. ç”Ÿæˆå€™é€‰æ–¹æ¡ˆï¼ˆ3ä¸ªï¼‰
   â”œâ”€ å€™é€‰1: ç²—è°ƒç»“æœ
   â”œâ”€ å€™é€‰2: è¾ƒä½æ¡£ä½å¢åŠ 
   â””â”€ å€™é€‰3: åˆ†æ®µè°ƒæ•´
4. é€‰æ‹©è¯¯å·®æœ€å°çš„æ–¹æ¡ˆ
5. å¼ºåˆ¶éé€’å¢çº¦æŸ

// æ¡£ä½+å¸‚åœºç±»å‹ä½¿ç”¨ç‰¹æ®Šç®—æ³•:
// MarketProportionalCigaretteDistributionAlgorithm

1. æŒ‰æ¯”ä¾‹è®¡ç®—åŸç½‘å’Œå†œç½‘ç›®æ ‡æŠ•æ”¾é‡
2. åˆ†åˆ«å¯¹åŸç½‘å’Œå†œç½‘æ‰§è¡Œæ ¸å¿ƒç®—æ³•
3. åˆå¹¶ç»“æœ
4. å¼ºåˆ¶éé€’å¢çº¦æŸ
```

---

### èŠ‚ç‚¹5: å®é™…æŠ•æ”¾é‡è®¡ç®—

```java
// å¯¹æ¯ä¸ªåŒºåŸŸè®¡ç®—å®é™…æŠ•æ”¾é‡
BigDecimal actualDelivery = calculateActualDeliveryForRegion(
    target, allocationRow, deliveryMethod, deliveryEtype, remark);

// å†…éƒ¨æµç¨‹
1. è·å–è¯¥åŒºåŸŸçš„å®¢æˆ·æ•°
   customerCounts = RegionClientNumDataService.findByTableNameAndRegion(tableName, target)
   
2. æŒ‰å…¬å¼è®¡ç®—
   actualDelivery = Î£(i=0 to 29) allocationRow[i] Ã— customerCounts[i]
   
ç¤ºä¾‹:
   ä¸»åŸåŒºå®é™…æŠ•æ”¾ = 5Ã—100 + 5Ã—95 + 5Ã—90 + 4Ã—85 + ... = 4500æ¡
```

---

### èŠ‚ç‚¹6: ç¼–ç è¡¨è¾¾å¼ç”Ÿæˆ

```java
// ç”Ÿæˆç¼–ç è¡¨è¾¾å¼
String encodedExpression = encodeDecodeService.encodeForSpecificArea(
    cigCode, cigName, deliveryMethod, deliveryEtype, target, allRecords);

// ç¼–ç ç¤ºä¾‹:
â”œâ”€ æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ï¼Œä¸»åŸåŒº: "B4â‘ (5Ã—9+5Ã—8+10Ã—7+10Ã—6)"
â”œâ”€ æ¡£ä½+ä¸šæ€ï¼Œä¾¿åˆ©åº—: "B5a(6Ã—10+6Ã—9+10Ã—8+8Ã—7)"
â””â”€ æ¡£ä½+å¸‚åœºç±»å‹ï¼ŒåŸç½‘: "B2C(7Ã—10+7Ã—9+8Ã—8+8Ã—7)"
```

**è¯¦ç»†ç¼–ç è§„åˆ™**: è¯·å‚è€ƒ `docs/ç¼–ç è§„åˆ™è¡¨.md`

**ç¼–ç æ ¼å¼è¯´æ˜**:
- ç¬¬ä¸€éƒ¨åˆ†: æŠ•æ”¾ç±»å‹ç¼–ç 
  - `A`: æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾
  - `B`: æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾
  - `C`: æŒ‰éœ€æŠ•æ”¾
  
- ç¬¬äºŒéƒ¨åˆ†: æ‰©å±•ç±»å‹ç¼–ç ï¼ˆä»…Bç±»å‹ï¼‰
  - `1`: æ¡£ä½+åŒºå¿
  - `2`: æ¡£ä½+å¸‚åœºç±»å‹
  - `3`: æ¡£ä½+åŒºå¿+å¸‚åœºç±»å‹
  - `4`: æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç 
  - `5`: æ¡£ä½+ä¸šæ€
  
- ç¬¬ä¸‰éƒ¨åˆ†: åŒºåŸŸç¼–ç 
  - æ¡£ä½+åŒºå¿: åŸåŒº(1)ã€ä¸¹æ±Ÿ(2)ã€æˆ¿å¿(3)ã€éƒ§è¥¿(4)ã€éƒ§é˜³(5)ã€ç«¹å±±(6)ã€ç«¹æºª(7)
  - æ¡£ä½+å¸‚åœºç±»å‹: åŸç½‘(C)ã€å†œç½‘(N)
  - æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç : ä¸»åŸåŒº(â‘ )ã€åŸä¹¡ç»“åˆåŒº(â‘¡)ã€é•‡ä¸­å¿ƒåŒº(â‘¢)ã€é•‡ä¹¡æ¥åˆåŒº(â‘£)ã€ç‰¹æ®ŠåŒºåŸŸ(â‘¤)ã€ä¹¡ä¸­å¿ƒåŒº(â‘¥)ã€æ‘åº„(â‘¦)
  - æ¡£ä½+ä¸šæ€: ä¾¿åˆ©åº—(a)ã€è¶…å¸‚(b)ã€å•†åœº(c)ã€çƒŸè‰ä¸“ä¸šåº—(d)ã€å¨±ä¹æœåŠ¡ç±»(e)ã€å…¶ä»–(f)
  
- ç¬¬å››éƒ¨åˆ†: æ¡£ä½å‹ç¼©ç¼–ç 
  - æ ¼å¼: `(æ¡£ä½è·¨åº¦Ã—æŠ•æ”¾é‡+æ¡£ä½è·¨åº¦Ã—æŠ•æ”¾é‡+...)`
  - ç¤ºä¾‹: `(5Ã—9+5Ã—8+10Ã—7+10Ã—6)` è¡¨ç¤ºD30-D26=9, D25-D21=8, D20-D11=7, D10-D1=6

---

### èŠ‚ç‚¹7: æ‰¹é‡å†™å›æ•°æ®åº“

```java
// æ‰¹é‡æ’å…¥ï¼ˆä½¿ç”¨JdbcTemplateï¼‰
String tableName = "cigarette_distribution_prediction_{year}_{month}_{weekSeq}";
String sql = CigaretteDistributionSqlBuilder.buildBatchInsertSql(tableName);

jdbcTemplate.batchUpdate(sql, batchArgs);

// æ¯æ¡è®°å½•åŒ…å«
{
    CIG_CODE: "12345678",
    CIG_NAME: "é»„é¹¤æ¥¼(1916ä¸­æ”¯)",
    YEAR: 2025,
    MONTH: 10,
    WEEK_SEQ: 1,
    DELIVERY_AREA: "ä¸»åŸåŒº",  // å…·ä½“åŒºåŸŸ
    DELIVERY_METHOD: "æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾",
    DELIVERY_ETYPE: "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ",
    D30: 5, D29: 5, ..., D1: 2,
    ACTUAL_DELIVERY: 4500,
    DEPLOYINFO_CODE: "DM1E3R1G5,5,5,4,4,...",
    BZ: "ç®—æ³•è‡ªåŠ¨ç”Ÿæˆ"
}
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµå›¾ï¼ˆåˆ†å±‚è§†å›¾ï¼‰

### Layer 1: Controllerå±‚ï¼ˆHTTPå¤„ç†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DistributionCalculateController                                 â”‚
â”‚                                                                 â”‚
â”‚ @PostMapping("/generate-distribution-plan")                    â”‚
â”‚                                                                 â”‚
â”‚ è¾“å…¥å‚æ•°:                                                        â”‚
â”‚ â”œâ”€ year: 2025                                                  â”‚
â”‚ â”œâ”€ month: 10                                                   â”‚
â”‚ â”œâ”€ weekSeq: 1                                                  â”‚
â”‚ â”œâ”€ urbanRatio: 0.45 (å¯é€‰)                                     â”‚
â”‚ â””â”€ ruralRatio: 0.55 (å¯é€‰)                                     â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†é€»è¾‘:                                                        â”‚
â”‚ â”œâ”€ éªŒè¯å‚æ•°                                                      â”‚
â”‚ â”œâ”€ æ„å»ºmarketRatios Map                                        â”‚
â”‚ â””â”€ è°ƒç”¨Serviceå±‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
```

### Layer 2: Serviceå±‚ï¼ˆä¸šåŠ¡åè°ƒï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DistributionCalculateServiceImpl                                â”‚
â”‚                                                                 â”‚
â”‚ æ ¸å¿ƒæ–¹æ³•:                                                        â”‚
â”‚ getAndwriteBackAllocationMatrix(year, month, weekSeq, ratios)  â”‚
â”‚                                                                 â”‚
â”‚ å¤„ç†æµç¨‹:                                                        â”‚
â”‚ â”œâ”€ 1. æŸ¥è¯¢å·çƒŸåŸºç¡€æ•°æ®ï¼ˆJdbcTemplateï¼‰                           â”‚
â”‚ â”‚   â””â”€ SELECT * FROM cigarette_distribution_info_2025_10_1    â”‚
â”‚ â”‚                                                              â”‚
â”‚ â”œâ”€ 2. éå†æ¯ä¸ªå·çƒŸ                                              â”‚
â”‚ â”‚   for each cigarette:                                       â”‚
â”‚ â”‚       â”œâ”€ æå–: deliveryMethod, deliveryEtype, adv, area     â”‚
â”‚ â”‚       â”œâ”€ é€‰æ‹©ç­–ç•¥: strategyManager.getStrategy(method, type)â”‚
â”‚ â”‚       â”œâ”€ æ„å»ºextraParamsï¼ˆå¦‚æœæ˜¯å¸‚åœºç±»å‹ï¼‰                    â”‚
â”‚ â”‚       â”œâ”€ è§£æç›®æ ‡: strategy.getTargetList(area)             â”‚
â”‚ â”‚       â”œâ”€ è®¡ç®—åˆ†é…: strategy.calculateMatrix(targets, adv, extra)â”‚
â”‚ â”‚       â”œâ”€ è®¡ç®—å®é™…æŠ•æ”¾: æ¯ä¸ªåŒºåŸŸçš„Î£(åˆ†é…Ã—å®¢æˆ·æ•°)                â”‚
â”‚ â”‚       â”œâ”€ ç”Ÿæˆç¼–ç : encodeDecodeService.encode(...)          â”‚
â”‚ â”‚       â””â”€ å‡†å¤‡å†™å›æ•°æ®                                         â”‚
â”‚ â”‚                                                              â”‚
â”‚ â””â”€ 3. æ‰¹é‡å†™å›æ•°æ®åº“ï¼ˆJdbcTemplate.batchUpdateï¼‰                â”‚
â”‚     â””â”€ INSERT INTO cigarette_distribution_prediction_...       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
```

### Layer 3: Strategyå±‚ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DistributionStrategyï¼ˆç­–ç•¥æ¥å£ï¼‰                                  â”‚
â”‚                                                                 â”‚
â”‚ 5ä¸ªå…·ä½“ç­–ç•¥:                                                     â”‚
â”‚ â”œâ”€ UrbanRuralDistributionStrategyï¼ˆåŸä¹¡åˆ†ç±»ä»£ç ï¼‰                â”‚
â”‚ â”œâ”€ BusinessFormatDistributionStrategyï¼ˆä¸šæ€ï¼‰                   â”‚
â”‚ â”œâ”€ CountyDistributionStrategyï¼ˆåŒºå¿ï¼‰                           â”‚
â”‚ â”œâ”€ MarketDistributionStrategyï¼ˆå¸‚åœºç±»å‹ï¼‰â­                      â”‚
â”‚ â””â”€ CityDistributionStrategyï¼ˆç»Ÿä¸€æŠ•æ”¾ï¼‰                          â”‚
â”‚                                                                 â”‚
â”‚ ç»Ÿä¸€æ¥å£æ–¹æ³•:                                                    â”‚
â”‚ â”œâ”€ getTargetList(deliveryArea) â†’ è§£æç›®æ ‡åŒºåŸŸåˆ—è¡¨                â”‚
â”‚ â””â”€ calculateMatrix(targets, amount, extraParams) â†’ è®¡ç®—åˆ†é…çŸ©é˜µ  â”‚
â”‚                                                                 â”‚
â”‚ å…±åŒä¾èµ–:                                                        â”‚
â”‚ â”œâ”€ CommonServiceï¼ˆç»Ÿä¸€æ•°æ®æœåŠ¡ï¼‰                                 â”‚
â”‚ â”œâ”€ KmpMatcherï¼ˆæ¨¡å¼åŒ¹é…å·¥å…·ï¼‰                                    â”‚
â”‚ â””â”€ å¯¹åº”çš„ç®—æ³•ç±»                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
```

### Layer 4: Algorithmå±‚ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†é…ç®—æ³•                                                         â”‚
â”‚                                                                 â”‚
â”‚ V3å¤šè½®ç²—è°ƒç®—æ³•ï¼ˆç”¨äº3ä¸ªä¸šåŠ¡ç±»å‹ï¼‰:                                 â”‚
â”‚ â”œâ”€ UrbanRuralClassificationCodeDistributionAlgorithm            â”‚
â”‚ â”œâ”€ BussinessFormatDistributionAlgorithm                        â”‚
â”‚ â””â”€ countyCigaretteDistributionAlgorithm                        â”‚
â”‚                                                                 â”‚
â”‚ å¸‚åœºæ¯”ä¾‹åˆ†é…ç®—æ³•:                                                 â”‚
â”‚ â””â”€ MarketProportionalCigaretteDistributionAlgorithm             â”‚
â”‚                                                                 â”‚
â”‚ ç»Ÿä¸€æŠ•æ”¾ç®—æ³•:                                                     â”‚
â”‚ â””â”€ CityCigaretteDistributionAlgorithm                           â”‚
â”‚                                                                 â”‚
â”‚ æ ¸å¿ƒé€»è¾‘:                                                        â”‚
â”‚ â”œâ”€ åˆå§‹åŒ–åˆ†é…çŸ©é˜µ                                                â”‚
â”‚ â”œâ”€ å¤šè½®ç²—è°ƒï¼ˆæ•´åˆ—+1ï¼‰                                            â”‚
â”‚ â”œâ”€ ç”Ÿæˆå€™é€‰æ–¹æ¡ˆ                                                  â”‚
â”‚ â”œâ”€ é€‰æ‹©æœ€ä¼˜æ–¹æ¡ˆ                                                  â”‚
â”‚ â””â”€ å¼ºåˆ¶éé€’å¢çº¦æŸ                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
```

### Layer 5: Data Accesså±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•°æ®è®¿é—®å±‚                                                        â”‚
â”‚                                                                 â”‚
â”‚ CommonServiceï¼ˆé€šç”¨æ•°æ®æœåŠ¡ï¼‰:                                    â”‚
â”‚ â”œâ”€ getAllRegionList() - è·å–åŒºåŸŸåˆ—è¡¨                             â”‚
â”‚ â””â”€ buildRegionCustomerMatrix() - æ„å»ºå®¢æˆ·æ•°çŸ©é˜µ                  â”‚
â”‚                                                                 â”‚
â”‚ RegionClientNumDataServiceï¼ˆåŒºåŸŸå®¢æˆ·æ•°æŸ¥è¯¢ï¼‰:                     â”‚
â”‚ â””â”€ findByTableNameAndRegion() - æŸ¥è¯¢å•ä¸ªåŒºåŸŸå®¢æˆ·æ•°                â”‚
â”‚                                                                 â”‚
â”‚ æ•°æ®è®¿é—®æŠ€æœ¯:                                                     â”‚
â”‚ â”œâ”€ JdbcTemplate - ä¸»è¦æ–¹å¼ï¼ˆåŠ¨æ€è¡¨åï¼‰                           â”‚
â”‚ â””â”€ EntityManager - è¾…åŠ©æ–¹å¼ï¼ˆå®ä½“æ˜ å°„ï¼‰                          â”‚
â”‚                                                                 â”‚
â”‚ SQLå·¥å…·:                                                         â”‚
â”‚ â””â”€ CigaretteDistributionSqlBuilder - ç»Ÿä¸€SQLæ„å»º                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
```

### Layer 6: Databaseå±‚ï¼ˆæ•°æ®å­˜å‚¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MySQLæ•°æ®åº“ï¼ˆmarketingï¼‰                                         â”‚
â”‚                                                                 â”‚
â”‚ è¾“å…¥è¡¨ï¼ˆå·çƒŸæŠ•æ”¾åŸºç¡€ä¿¡æ¯ï¼‰:                                        â”‚
â”‚ â””â”€ cigarette_distribution_info_{year}_{month}_{weekSeq}        â”‚
â”‚     â”œâ”€ CIG_CODE, CIG_NAME, ADV                                â”‚
â”‚     â”œâ”€ DELIVERY_METHOD, DELIVERY_ETYPE, DELIVERY_AREA         â”‚
â”‚     â””â”€ bz, YEAR, MONTH, WEEK_SEQ                              â”‚
â”‚                                                                 â”‚
â”‚ è¾“å‡ºè¡¨ï¼ˆå·çƒŸåˆ†é…é¢„æµ‹æ•°æ®ï¼‰:                                        â”‚
â”‚ â””â”€ cigarette_distribution_prediction_{year}_{month}_{weekSeq}  â”‚
â”‚     â”œâ”€ CIG_CODE, CIG_NAME, DELIVERY_AREA                      â”‚
â”‚     â”œâ”€ D30, D29, D28, ..., D2, D1ï¼ˆ30ä¸ªæ¡£ä½ï¼‰                  â”‚
â”‚     â”œâ”€ ACTUAL_DELIVERYï¼ˆå®é™…æŠ•æ”¾é‡ï¼‰                            â”‚
â”‚     â””â”€ DEPLOYINFO_CODEï¼ˆç¼–ç è¡¨è¾¾å¼ï¼‰                            â”‚
â”‚                                                                 â”‚
â”‚ å®¢æˆ·æ•°åŸºç¡€è¡¨ï¼ˆåŒºåŸŸå®¢æˆ·æ•°ï¼‰:                                        â”‚
â”‚ â”œâ”€ region_clientNum_0_1/2 - ç»Ÿä¸€æŠ•æ”¾                           â”‚
â”‚ â”œâ”€ region_clientNum_1_1/2 - æ¡£ä½+åŒºå¿                          â”‚
â”‚ â”œâ”€ region_clientNum_2_1/2 - æ¡£ä½+å¸‚åœºç±»å‹                       â”‚
â”‚ â”œâ”€ region_clientNum_3_1/2 - æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç                    â”‚
â”‚ â””â”€ region_clientNum_4_1/2 - æ¡£ä½+ä¸šæ€                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ ç‰¹æ®Šä¸šåŠ¡ç±»å‹ï¼šæ¡£ä½+å¸‚åœºç±»å‹æ¯”ä¾‹å‚æ•°æµ

### å®Œæ•´æ•°æ®æµï¼ˆå¸¦æ¯”ä¾‹å‚æ•°ï¼‰

```
å‰ç«¯è¯·æ±‚
POST /api/calculate/generate-distribution-plan?
    year=2025&month=10&weekSeq=1&
    urbanRatio=0.45&ruralRatio=0.55
                â†“
Controllerå±‚
â”œâ”€ æ¥æ”¶å‚æ•°
â”œâ”€ æ„å»ºmarketRatios = {"urbanRatio": 0.45, "ruralRatio": 0.55}
â””â”€ è°ƒç”¨Service: getAndwriteBackAllocationMatrix(2025, 10, 1, marketRatios)
                â†“
Serviceå±‚
â”œâ”€ æŸ¥è¯¢cigarette_distribution_info_2025_10_1è¡¨
â”œâ”€ éå†æ¯ä¸ªå·çƒŸ
â””â”€ å½“å‘ç°æŠ•æ”¾ç±»å‹="æ¡£ä½+å¸‚åœºç±»å‹":
    â”œâ”€ ä»marketRatiosæå–æ¯”ä¾‹å‚æ•°
    â””â”€ æ„å»ºextraParams = {"urbanRatio": 0.45, "ruralRatio": 0.55}
                â†“
Strategyå±‚ï¼ˆMarketDistributionStrategyï¼‰
â”œâ”€ getTargetList("åŸç½‘,å†œç½‘") â†’ ["åŸç½‘", "å†œç½‘"]
â”œâ”€ calculateMatrix(["åŸç½‘","å†œç½‘"], 15000, extraParams)
â”‚   â”œâ”€ æ£€æŸ¥åŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘: âœ… æ˜¯
â”‚   â”œâ”€ æ£€æŸ¥extraParamsæœ‰æ¯”ä¾‹: âœ… æœ‰
â”‚   â”œâ”€ ä½¿ç”¨æ¯”ä¾‹: urbanRatio=0.45, ruralRatio=0.55
â”‚   â””â”€ è®°å½•æ—¥å¿—: "ä½¿ç”¨å‰ç«¯ä¼ å…¥çš„å¸‚åœºç±»å‹æ¯”ä¾‹ - åŸç½‘: 0.45, å†œç½‘: 0.55"
                â†“
Algorithmå±‚
â”œâ”€ è®¡ç®—åŸç½‘ç›®æ ‡: 15000 Ã— 0.45 = 6750æ¡
â”œâ”€ è®¡ç®—å†œç½‘ç›®æ ‡: 15000 Ã— 0.55 = 8250æ¡
â”œâ”€ åˆ†åˆ«æ‰§è¡Œæ ¸å¿ƒç®—æ³•
â”œâ”€ åˆå¹¶ç»“æœ
â””â”€ è¿”å›: allocationMatrix = [[åŸç½‘åˆ†é…], [å†œç½‘åˆ†é…]]
                â†“
å†™å›æ•°æ®åº“
â”œâ”€ è®°å½•1: åŸç½‘, D30-D1, actualDeliveryâ‰ˆ6750
â””â”€ è®°å½•2: å†œç½‘, D30-D1, actualDeliveryâ‰ˆ8250
```

### æ¯”ä¾‹å‚æ•°çš„ä¸‰ç§åœºæ™¯

#### åœºæ™¯1: ä¼ å…¥æ¯”ä¾‹ + åŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘ âœ…

```
å¾…æŠ•æ”¾åŒºåŸŸ: "åŸç½‘,å†œç½‘"
å‰ç«¯å‚æ•°: urbanRatio=0.45, ruralRatio=0.55

        â†“
æ£€æŸ¥: hasUrban=true, hasRural=true, hasBoth=true âœ…
ä½¿ç”¨æ¯”ä¾‹: 0.45 / 0.55ï¼ˆå‰ç«¯ä¼ å…¥ï¼‰
æ—¥å¿—: "ä½¿ç”¨å‰ç«¯ä¼ å…¥çš„å¸‚åœºç±»å‹æ¯”ä¾‹"
```

#### åœºæ™¯2: ä¸ä¼ æ¯”ä¾‹ + åŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘ âœ…

```
å¾…æŠ•æ”¾åŒºåŸŸ: "åŸç½‘,å†œç½‘"
å‰ç«¯å‚æ•°: æ— æ¯”ä¾‹å‚æ•°

        â†“
æ£€æŸ¥: hasUrban=true, hasRural=true, hasBoth=true âœ…
ä½¿ç”¨æ¯”ä¾‹: 0.4 / 0.6ï¼ˆé»˜è®¤å€¼ï¼‰
æ—¥å¿—: "ä½¿ç”¨é»˜è®¤å¸‚åœºç±»å‹æ¯”ä¾‹ - åŸç½‘: 40%, å†œç½‘: 60%"
```

#### åœºæ™¯3: ä¼ å…¥æ¯”ä¾‹ + ä»…åŒ…å«ä¸€ä¸ªå¸‚åœº âŒ

```
å¾…æŠ•æ”¾åŒºåŸŸ: "åŸç½‘"ï¼ˆä»…åŸç½‘ï¼‰
å‰ç«¯å‚æ•°: urbanRatio=0.45, ruralRatio=0.55

        â†“
æ£€æŸ¥: hasUrban=true, hasRural=false, hasBoth=false âŒ
ä½¿ç”¨æ¯”ä¾‹: 1.0 / 0.0ï¼ˆå¿½ç•¥å‰ç«¯å‚æ•°ï¼Œ100%ç»™åŸç½‘ï¼‰
æ—¥å¿—: "å¾…æŠ•æ”¾åŒºåŸŸä»…åŒ…å«åŸç½‘ï¼Œæ¯”ä¾‹å‚æ•°æ— æ•ˆï¼Œ100%åˆ†é…ç»™åŸç½‘"
è­¦å‘Š: "å¾…æŠ•æ”¾åŒºåŸŸä¸åŒæ—¶åŒ…å«åŸç½‘å’Œå†œç½‘ï¼Œä¼ å…¥çš„æ¯”ä¾‹å‚æ•°æ— æ•ˆï¼Œå·²å¿½ç•¥"
```

---

## ğŸ“ äº”ç§ä¸šåŠ¡ç±»å‹å¯¹æ¯”

| ä¸šåŠ¡ç±»å‹ | ç­–ç•¥ç±» | ç®—æ³•ç±» | å®¢æˆ·æ•°è¡¨ | æ¯”ä¾‹å‚æ•° | ç‰¹æ®Šå¤„ç† |
|---------|-------|--------|---------|---------|---------|
| æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾ | CityDistributionStrategy | CityCigaretteDistributionAlgorithm | region_clientNum_0_1 | âŒ | ç›®æ ‡å›ºå®šä¸º"å…¨å¸‚" |
| æ¡£ä½+åŒºå¿ | CountyDistributionStrategy | countyCigaretteDistributionAlgorithm | region_clientNum_1_1 | âŒ | - |
| æ¡£ä½+å¸‚åœºç±»å‹ | MarketDistributionStrategy | MarketProportionalCigaretteDistributionAlgorithm | region_clientNum_2_1 | âœ… | æ”¯æŒåŸç½‘/å†œç½‘æ¯”ä¾‹ |
| æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç  | UrbanRuralDistributionStrategy | UrbanRuralClassificationCodeDistributionAlgorithm | region_clientNum_3_1 | âŒ | - |
| æ¡£ä½+ä¸šæ€ | BusinessFormatDistributionStrategy | BussinessFormatDistributionAlgorithm | region_clientNum_4_1 | âŒ | - |

---

## ğŸ”§ å…³é”®æŠ€æœ¯ç»„ä»¶

### 1. ç­–ç•¥ç®¡ç†å™¨ï¼ˆDistributionStrategyManagerï¼‰

```java
// èŒè´£ï¼šæ ¹æ®æŠ•æ”¾æ–¹æ³•å’Œç±»å‹é€‰æ‹©å¯¹åº”ç­–ç•¥
public DistributionStrategy getStrategy(String deliveryMethod, String deliveryEtype) {
    // ç­–ç•¥æ˜ å°„
    if ("æŒ‰æ¡£ä½ç»Ÿä¸€æŠ•æ”¾".equals(deliveryMethod)) {
        return cityDistributionStrategy;
    } else if ("æŒ‰æ¡£ä½æ‰©å±•æŠ•æ”¾".equals(deliveryMethod)) {
        switch (deliveryEtype) {
            case "æ¡£ä½+åŒºå¿": return countyDistributionStrategy;
            case "æ¡£ä½+å¸‚åœºç±»å‹": return marketDistributionStrategy;
            case "æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ": return urbanRuralDistributionStrategy;
            case "æ¡£ä½+ä¸šæ€": return businessFormatDistributionStrategy;
        }
    }
    throw new IllegalArgumentException("ä¸æ”¯æŒçš„æŠ•æ”¾ç±»å‹");
}
```

### 2. é€šç”¨æ•°æ®æœåŠ¡ï¼ˆCommonServiceï¼‰

```java
// èŒè´£ï¼šä¸ºæ‰€æœ‰ç­–ç•¥ç±»æä¾›ç»Ÿä¸€çš„æ•°æ®è®¿é—®æ¥å£

// æ–¹æ³•1ï¼šè·å–åŒºåŸŸåˆ—è¡¨
List<String> getAllRegionList(String deliveryMethod, String deliveryEtype) {
    // 1. æ ¹æ®æŠ•æ”¾ç±»å‹ç¡®å®šè¡¨å
    String tableName = TableNameGeneratorUtil.generateRegionClientTableName(...);
    
    // 2. æŸ¥è¯¢è¯¥è¡¨çš„æ‰€æœ‰åŒºåŸŸ
    SELECT DISTINCT region FROM {tableName} WHERE region IS NOT NULL
    
    // 3. è¿”å›åŒºåŸŸåˆ—è¡¨
}

// æ–¹æ³•2ï¼šæ„å»ºå®¢æˆ·æ•°çŸ©é˜µ
RegionCustomerMatrix buildRegionCustomerMatrix(String deliveryMethod, String deliveryEtype) {
    // 1. ç¡®å®šè¡¨å
    // 2. æŸ¥è¯¢æ‰€æœ‰åŒºåŸŸçš„D30-D1æ•°æ®
    // 3. æ„å»ºçŸ©é˜µå¯¹è±¡è¿”å›
}
```

### 3. SQLæ„å»ºå·¥å…·ï¼ˆCigaretteDistributionSqlBuilderï¼‰

```java
// èŒè´£ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰SQLè¯­å¥æ„å»º

buildAdvDataQuerySql(tableName, year, month, weekSeq)
    â†’ "SELECT CIG_CODE, CIG_NAME, ADV, ... FROM {tableName}"

buildBatchInsertSql(tableName)
    â†’ "INSERT INTO {tableName} (...) VALUES (...) ON DUPLICATE KEY UPDATE ..."

buildCheckTableExistsSql()
    â†’ "SELECT COUNT(*) FROM information_schema.tables WHERE ..."
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

### 1. ç¼“å­˜æœºåˆ¶ï¼ˆ@Cacheableï¼‰

```java
// å„ç­–ç•¥ç±»ä¸­çš„ç¼“å­˜
@Cacheable("regionCustomerMatrix")
private BigDecimal[][] getRegionCustomerMatrix() {
    // é¦–æ¬¡æŸ¥è¯¢æ•°æ®åº“ï¼Œåç»­ä»ç¼“å­˜è¯»å–
}

// ç¼“å­˜key
- regionCustomerMatrix (åŸä¹¡åˆ†ç±»ä»£ç )
- businessFormatCustomerMatrix (ä¸šæ€)
- countyCustomerMatrix (åŒºå¿)
- marketCustomerMatrix (å¸‚åœºç±»å‹)
- cityCustomerMatrix (ç»Ÿä¸€æŠ•æ”¾)
```

### 2. æ‰¹é‡æ“ä½œ

```java
// ä½¿ç”¨JdbcTemplateæ‰¹é‡å†™å›
jdbcTemplate.batchUpdate(sql, batchArgs);

// ç›¸æ¯”é€æ¡æ’å…¥ï¼Œæ€§èƒ½æå‡10-100å€
```

---

## â±ï¸ å®Œæ•´è¯·æ±‚æ—¶é—´çº¿

```
T0: å‰ç«¯å‘èµ·è¯·æ±‚

T0+10ms: Controlleræ¥æ”¶å¹¶éªŒè¯å‚æ•°

T0+20ms: æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—§æ•°æ®
    â”œâ”€ å¦‚æœå­˜åœ¨
    â”‚   â””â”€ T0+50ms: åˆ é™¤æ—§æ•°æ®ï¼ˆDELETEæ“ä½œï¼‰
    â””â”€ å¦‚æœä¸å­˜åœ¨
        â””â”€ T0+30ms: ç»§ç»­

T0+100ms: æŸ¥è¯¢å·çƒŸåŸºç¡€æ•°æ®
    â””â”€ SELECT * FROM cigarette_distribution_info_2025_10_1
    â””â”€ å‡è®¾æŸ¥è¯¢åˆ°50ä¸ªå·çƒŸ

T0+150ms: å¼€å§‹éå†å¤„ç†ï¼ˆ50ä¸ªå·çƒŸï¼‰
    â”œâ”€ å·çƒŸ1ï¼ˆæ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ï¼‰
    â”‚   â”œâ”€ è·å–åŒºåŸŸåˆ—è¡¨ï¼ˆç¼“å­˜å‘½ä¸­: 0msï¼‰
    â”‚   â”œâ”€ è·å–å®¢æˆ·æ•°çŸ©é˜µï¼ˆç¼“å­˜å‘½ä¸­: 0msï¼‰
    â”‚   â”œâ”€ æ‰§è¡Œç®—æ³•è®¡ç®—: 5ms
    â”‚   â””â”€ è®¡ç®—å®é™…æŠ•æ”¾é‡: 1ms
    â”‚
    â”œâ”€ å·çƒŸ2ï¼ˆæ¡£ä½+ä¸šæ€ï¼‰
    â”‚   â”œâ”€ ç¼“å­˜å‘½ä¸­: 0ms
    â”‚   â”œâ”€ ç®—æ³•è®¡ç®—: 5ms
    â”‚   â””â”€ å®é™…æŠ•æ”¾: 1ms
    â”‚
    â””â”€ ... (å…¶ä»–48ä¸ªå·çƒŸ)
    
    æ€»è€—æ—¶: çº¦300ms

T0+450ms: æ‰¹é‡å†™å›æ•°æ®åº“
    â””â”€ INSERT INTO cigarette_distribution_prediction_...
    â””â”€ æ‰¹é‡å†™å›50ä¸ªå·çƒŸÃ—å¹³å‡4ä¸ªåŒºåŸŸ=200æ¡è®°å½•
    â””â”€ è€—æ—¶: çº¦100ms

T0+550ms: æ„å»ºå“åº”å¹¶è¿”å›
    â””â”€ æ€»è€—æ—¶: çº¦550ms

å‰ç«¯æ”¶åˆ°å“åº”: T0+600ms
```

**æ€»ç»“**: å¤„ç†50ä¸ªå·çƒŸï¼Œçº¦600mså®Œæˆï¼ˆå«ç½‘ç»œå»¶è¿Ÿï¼‰

---

## ğŸ¯ æ•°æ®æµå…³é”®è¦ç‚¹

### 1. ç»Ÿä¸€æ¶æ„

æ‰€æœ‰5ä¸ªä¸šåŠ¡ç±»å‹ä½¿ç”¨ç»Ÿä¸€çš„æ¶æ„ï¼š
```
Controller â†’ Service â†’ Strategy â†’ Algorithm â†’ Database
```

### 2. ç­–ç•¥æ¨¡å¼

- æ ¹æ®æŠ•æ”¾ç±»å‹è‡ªåŠ¨é€‰æ‹©ç­–ç•¥
- å„ç­–ç•¥ç±»æ¥å£ç»Ÿä¸€
- æ˜“äºæ‰©å±•æ–°ç±»å‹

### 3. ç¼“å­˜ä¼˜åŒ–

- å®¢æˆ·æ•°çŸ©é˜µç¼“å­˜
- é¿å…é‡å¤æŸ¥è¯¢
- æ˜¾è‘—æå‡æ€§èƒ½

### 4. æ‰¹é‡æ“ä½œ

- JdbcTemplateæ‰¹é‡å†™å›
- å‡å°‘æ•°æ®åº“äº¤äº’
- æå‡å†™å…¥æ€§èƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **ç®—æ³•è¯¦è§£**: `docs/æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç ç®—æ³•è¯´æ˜.md`
- **ç­–ç•¥ç±»æ¶æ„**: ä»£ç ä¸­çš„StrategyåŒ…
- **æµ‹è¯•æŠ¥å‘Š**: `test docs/æ¡£ä½+åŸä¹¡åˆ†ç±»ä»£ç /æµ‹è¯•æŠ¥å‘Š_202ç”¨ä¾‹_è¯¦ç»†åˆ†æ.md`
- **æµ‹è¯•æŠ¥å‘Š**: `test docs/æ¡£ä½+ä¸šæ€/æµ‹è¯•æŠ¥å‘Š_202ç”¨ä¾‹_è¯¦ç»†åˆ†æ.md`

---

## ğŸ‰ æ€»ç»“

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ä¸€é”®ç”Ÿæˆåˆ†é…æ–¹æ¡ˆAPIçš„å®Œæ•´æ•°æ®æµï¼ŒåŒ…æ‹¬ï¼š

âœ… ä»å‰ç«¯è¯·æ±‚åˆ°æ•°æ®åº“å†™å›çš„å®Œæ•´é“¾è·¯  
âœ… 5ç§ä¸šåŠ¡ç±»å‹çš„å…·ä½“æ•°æ®æµ  
âœ… æ¡£ä½+å¸‚åœºç±»å‹æ¯”ä¾‹å‚æ•°çš„ç‰¹æ®Šå¤„ç†  
âœ… å„å±‚æ¬¡çš„èŒè´£å’Œäº¤äº’å…³ç³»  
âœ… å…³é”®æŠ€æœ¯ç»„ä»¶å’Œä¼˜åŒ–æœºåˆ¶  
âœ… å®Œæ•´çš„æ—¶é—´çº¿åˆ†æ  

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç¼–å†™æ—¥æœŸ**: 2025-10-19

