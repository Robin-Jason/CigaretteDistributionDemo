# 导入表功能开发文档

## 📋 文档概述

**文档版本**: v3.0  
**更新时间**: 2024-12-29  
**适用对象**: 前端开发人员  
**功能描述**: 卷烟分配系统Excel数据导入功能完整指南

---

## 🎯 功能总览

系统提供**两个核心Excel导入功能**，用于建立和维护卷烟分配算法的基础数据：

### 📊 **功能一：卷烟投放基础信息导入**
- **业务用途**: 导入卷烟的投放策略配置和预投放量
- **数据特性**: 按时间周期（年-月-周）版本管理
- **表命名**: `cigarette_distribution_info_{年份}_{月份}_{周序号}`
- **数据来源**: 投放策略规划Excel表

### 📈 **功能二：区域客户数表导入**  
- **业务用途**: 导入不同投放类型下各区域的客户分布数据
- **数据特性**: 按投放类型和双周上浮标识分类管理
- **表命名**: `region_clientNum_{主序号}_{子序号}`
- **数据来源**: 客户统计分析Excel表

---

## 🚀 API接口详细说明

### 📊 **接口一：卷烟投放基础信息导入**

#### **基本信息**
```http
POST /api/import/cigarette-info
Content-Type: multipart/form-data
Accept: application/json
```

#### **请求参数**

| 参数名 | 数据类型 | 必填 | 验证规则 | 说明 |
|--------|----------|------|----------|------|
| `file` | MultipartFile | ✅ | Excel文件(.xlsx/.xls)，≤10MB | 包含卷烟投放数据的Excel文件 |
| `year` | Integer | ✅ | 2020 ≤ value ≤ 2099 | 投放计划年份 |
| `month` | Integer | ✅ | 1 ≤ value ≤ 12 | 投放计划月份 |
| `weekSeq` | Integer | ✅ | 1 ≤ value ≤ 5 | 月内周序号 |

#### **Excel文件格式规范**

**必须包含的列名**（大小写敏感，**与init.sql表结构完全一致**，除了自动生成的`id`字段）：

| 列名 | 数据类型 | 必填 | 格式说明 | 示例值 |
|------|----------|------|----------|--------|
| `CIG_CODE` | 文本 | ✅ | 卷烟代码，varchar(32) | "001" |
| `CIG_NAME` | 文本 | ✅ | 卷烟名称，varchar(100) | "中华(软)" |
| `YEAR` | 数字 | ✅ | 年份，year类型 | 2025 |
| `MONTH` | 数字 | ✅ | 月份，tinyint(1-12) | 9 |
| `WEEK_SEQ` | 数字 | ✅ | 周序号，tinyint(1-5) | 3 |
| `URS` | 数字 | ✅ | URS，decimal(18,2) | 200.00 |
| `ADV` | 数字 | ✅ | ADV，decimal(18,2) | 1500.50 |
| `DELIVERY_METHOD` | 文本 | ✅ | 档位投放方式，varchar(50) | "按档位统一投放" |
| `DELIVERY_ETYPE` | 文本 | ✅ | 扩展投放方式，varchar(50) | "档位+区县" |
| `DELIVERY_AREA` | 文本 | ✅ | 投放区域，varchar(100) | "城区" |
| `remark` | 文本 | ✅ | 备注，varchar(255)，**列必须存在但值可以为空** | "测试数据" 或 空值 |

**Excel模板示例**：
```
CIG_CODE | CIG_NAME | YEAR | MONTH | WEEK_SEQ | URS    | ADV     | DELIVERY_METHOD | DELIVERY_ETYPE | DELIVERY_AREA | remark
001      | 中华(软)  | 2025 | 9     | 3        | 200.00 | 1500.00 | 按档位统一投放    |                | 城区          | 测试数据
002      | 玉溪(软)  | 2025 | 9     | 3        | 150.00 | 1200.50 | 按档位扩展投放    | 档位+区县       | 丹江          |
003      | 云烟(软)  | 2025 | 9     | 3        | 180.00 | 1350.75 | 按档位扩展投放    | 档位+市场类型    | 房县          | 正常投放
004      | 利群(软)  | 2025 | 9     | 3        | 160.00 | 980.25  | 按档位统一投放    |                | 农村          |
```

**remark列说明**：
- ✅ **必须包含此列**：Excel文件中必须有`remark`列标题
- ✅ **值可以为空**：单元格可以留空，系统会自动处理为NULL值
- ✅ **支持文本内容**：可以填写备注信息，最长255字符

#### **成功响应示例**
```json
{
    "success": true,
    "message": "导入成功",
    "tableName": "cigarette_distribution_info_2025_9_3",
    "insertedCount": 156,
    "totalRows": 156
}
```

#### **前端调用示例**
```javascript
const importCigaretteInfo = async (file, year, month, weekSeq) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('year', year.toString());
    formData.append('month', month.toString());
    formData.append('weekSeq', weekSeq.toString());
    
    try {
        const response = await fetch('/api/import/cigarette-info', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log(`导入成功：${result.tableName}，插入${result.insertedCount}条记录`);
            return result;
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('导入失败:', error);
        throw error;
    }
};
```

---

### 📈 **接口二：区域客户数表导入**

#### **基本信息**
```http
POST /api/import/region-clientnum
Content-Type: multipart/form-data  
Accept: application/json
```

#### **请求参数**

| 参数名 | 数据类型 | 必填 | 验证规则 | 说明 |
|--------|----------|------|----------|------|
| `file` | MultipartFile | ✅ | Excel文件(.xlsx/.xls)，≤10MB | 包含客户数据的Excel文件 |
| `year` | Integer | ✅ | 2020 ≤ value ≤ 2099 | 数据统计年份 |
| `month` | Integer | ✅ | 1 ≤ value ≤ 12 | 数据统计月份 |
| `deliveryMethod` | String | ✅ | 见投放类型映射表 | 投放方法 |
| `deliveryEtype` | String | ✅ | 见投放类型映射表 | 扩展投放类型 |
| `isBiWeeklyFloat` | Boolean | ❌ | 默认false | 是否双周上浮 |

#### **投放类型映射规则**

| 投放方法 | 扩展投放类型 | 主序号 | 双周上浮支持 | 表名示例 |
|---------|-------------|--------|-------------|----------|
| `按档位统一投放` | `""` 或 `null` | 0 | ✅ 支持 | `region_clientNum_0_1` |
| `按档位扩展投放` | `档位+区县` | 1 | ✅ 支持 | `region_clientNum_1_2` |
| `按档位扩展投放` | `档位+市场类型` | 2 | ✅ 支持 | `region_clientNum_2_1` |
| `按档位扩展投放` | `档位+城乡分类代码` | 3 | ✅ 支持 | `region_clientNum_3_2` |
| `按档位扩展投放` | `档位+业态` | 4 | ✅ 支持 | `region_clientNum_4_1` |

**表名生成逻辑**：
```javascript
// 表名格式：region_clientNum_{主序号}_{子序号}
// 子序号：1=非双周上浮，2=双周上浮

// 生成示例
const getTableName = (deliveryMethod, deliveryEtype, isBiWeeklyFloat) => {
    let mainSeq = 0; // 主序号
    let subSeq = isBiWeeklyFloat ? 2 : 1; // 子序号
    
    if (deliveryMethod === '按档位统一投放') {
        mainSeq = 0;
    } else if (deliveryMethod === '按档位扩展投放') {
        switch (deliveryEtype) {
            case '档位+区县': mainSeq = 1; break;
            case '档位+市场类型': mainSeq = 2; break;
            case '档位+城乡分类代码': mainSeq = 3; break;
            case '档位+业态': mainSeq = 4; break;
            default: throw new Error('无效的扩展投放类型');
        }
    }
    
    return `region_clientNum_${mainSeq}_${subSeq}`;
};
```

#### **Excel文件格式规范**

**必须包含的列名**（大小写敏感）：

| 列名 | 数据类型 | 必填 | 格式说明 | 示例值 |
|------|----------|------|----------|--------|
| `region` | 文本 | ✅ | 区域标识，长度根据投放类型变化 | "城区"、"主城区"、"便利店" |
| `D30` | 数字 | ✅ | 第30档位客户数，decimal(18,2) | 120.00 |
| `D29` | 数字 | ✅ | 第29档位客户数，decimal(18,2) | 150.00 |
| ... | ... | ... | 中间省略D28到D2 | ... |
| `D1` | 数字 | ✅ | 第1档位客户数，decimal(18,2) | 60.00 |
| `TOTAL` | 数字 | ✅ | 总客户数，decimal(18,2) | 3500.00 |

**重要说明**：
- 必须包含**D30到D1共30个档位列**，不能缺少任何一个
- 所有数值字段支持小数，精度为decimal(18,2)
- `region`列的含义根据投放类型而变化（区县名称、市场类型、城乡代码、业态等）

**Excel模板示例**：
```
region | D30    | D29    | D28    | ... | D2     | D1     | TOTAL
城区    | 120.00 | 150.00 | 200.00 | ... | 80.00  | 60.00  | 3500.00
农村    | 80.00  | 100.00 | 150.00 | ... | 40.00  | 30.00  | 2200.00
```

#### **成功响应示例**
```json
{
    "success": true,
    "message": "导入成功",
    "tableName": "region_clientNum_3_2",
    "insertedCount": 7,
    "totalRows": 7,
    "mainSequenceNumber": 3,
    "subSequenceNumber": 2,
    "deliveryMethod": "按档位扩展投放",
    "deliveryEtype": "档位+城乡分类代码",
    "isBiWeeklyFloat": true
}
```

#### **前端调用示例**
```javascript
const importRegionClientNum = async (file, params) => {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('year', params.year.toString());
    formData.append('month', params.month.toString());
    formData.append('deliveryMethod', params.deliveryMethod);
    formData.append('deliveryEtype', params.deliveryEtype || '');
    formData.append('isBiWeeklyFloat', params.isBiWeeklyFloat.toString());
    
    try {
        const response = await fetch('/api/import/region-clientnum', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log(`导入成功：${result.tableName}，插入${result.insertedCount}条记录`);
            return result;
        } else {
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('导入失败:', error);
        throw error;
    }
};

// 使用示例
const params = {
    year: 2025,
    month: 9,
    deliveryMethod: '按档位扩展投放',
    deliveryEtype: '档位+城乡分类代码',
    isBiWeeklyFloat: true
};

await importRegionClientNum(file, params);
```

---

## ❌ 完整错误处理指南

### **通用错误类型**

#### **1. 文件验证错误 (400)**
```json
// 文件为空
{
    "success": false,
    "message": "请选择要上传的Excel文件",
    "error": "FILE_EMPTY"
}

// 文件过大
{
    "success": false,
    "message": "文件大小超过限制（最大10MB）", 
    "error": "FILE_TOO_LARGE"
}

// 文件格式错误
{
    "success": false,
    "message": "文件格式不正确，请上传Excel文件",
    "error": "INVALID_FILE_FORMAT"
}
```

#### **2. 数据格式错误 (400)**
```json
// Excel结构错误
{
    "success": false,
    "message": "Excel文件结构不符合要求，请检查列名是否正确",
    "error": "INVALID_STRUCTURE"
}

// Excel为空
{
    "success": false,
    "message": "Excel文件为空或格式不正确",
    "error": "EMPTY_DATA"
}
```

#### **3. 业务验证错误 (400)**
```json
// 投放类型无效（仅区域客户数表）
{
    "success": false,
    "message": "投放类型和扩展投放类型组合无效",
    "error": "INVALID_DELIVERY_TYPE",
    "deliveryMethod": "按档位扩展投放",
    "deliveryEtype": "无效类型"
}

// 参数验证失败
{
    "success": false,
    "message": "年份不能小于2020",
    "error": "VALIDATION_FAILED"
}
```

#### **4. 系统错误 (500)**
```json
{
    "success": false,
    "message": "导入失败: 数据库连接异常",
    "error": "IMPORT_FAILED"
}
```

### **前端错误处理最佳实践**

```javascript
const handleImportError = (error, result) => {
    // 根据错误类型显示不同提示
    switch (result?.error) {
        case 'FILE_EMPTY':
            showMessage('请选择要上传的Excel文件', 'warning');
            break;
        case 'FILE_TOO_LARGE':
            showMessage('文件大小不能超过10MB，请压缩后重试', 'error');
            break;
        case 'INVALID_FILE_FORMAT':
            showMessage('请上传Excel格式文件(.xlsx或.xls)', 'warning');
            break;
        case 'INVALID_STRUCTURE':
            showMessage('Excel文件格式不正确，请检查列名是否与init.sql表结构完全一致', 'error');
            showExcelTemplate(); // 显示格式模板
            break;
        case 'EMPTY_DATA':
            showMessage('Excel文件中没有数据，请检查文件内容', 'warning');
            break;
        case 'INVALID_DELIVERY_TYPE':
            showMessage(
                `投放类型组合无效：${result.deliveryMethod} + ${result.deliveryEtype}，请检查选择`,
                'error'
            );
            break;
        case 'VALIDATION_FAILED':
            showMessage(`参数验证失败：${result.message}`, 'error');
            break;
        case 'IMPORT_FAILED':
            showMessage('系统内部错误，请稍后重试或联系技术支持', 'error');
            break;
        default:
            showMessage(result?.message || error.message || '导入失败', 'error');
    }
};

// 统一的导入处理函数
const performImport = async (importFunction, ...args) => {
    try {
        setLoading(true);
        const result = await importFunction(...args);
        showMessage('导入成功！', 'success');
        onImportSuccess(result);
        return result;
    } catch (error) {
        handleImportError(error, error.result);
        throw error;
    } finally {
        setLoading(false);
    }
};
```

---

## 💻 前端组件开发指南

### **1. 通用文件上传组件**

```jsx
import React, { useState, useCallback } from 'react';

const ExcelImportComponent = ({ 
    importType, 
    onSuccess, 
    onError,
    maxSize = 10 * 1024 * 1024 // 10MB
}) => {
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    const [dragOver, setDragOver] = useState(false);
    
    // 文件选择处理
    const handleFileSelect = useCallback((selectedFile) => {
        // 文件大小验证
        if (selectedFile.size > maxSize) {
            onError('文件大小超过10MB限制');
            return;
        }
        
        // 文件类型验证
        const validTypes = [
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
            'application/vnd.ms-excel' // .xls
        ];
        
        if (!validTypes.includes(selectedFile.type)) {
            onError('请上传Excel文件(.xlsx或.xls)');
            return;
        }
        
        setFile(selectedFile);
    }, [maxSize, onError]);
    
    // 拖拽处理
    const handleDrop = useCallback((e) => {
        e.preventDefault();
        setDragOver(false);
        
        const droppedFile = e.dataTransfer.files[0];
        if (droppedFile) {
            handleFileSelect(droppedFile);
        }
    }, [handleFileSelect]);
    
    const handleDragOver = useCallback((e) => {
        e.preventDefault();
        setDragOver(true);
    }, []);
    
    const handleDragLeave = useCallback((e) => {
        e.preventDefault();
        setDragOver(false);
    }, []);
    
    return (
        <div className="excel-import-component">
            {/* 文件拖拽区域 */}
            <div
                className={`drag-drop-area ${dragOver ? 'drag-over' : ''} ${file ? 'has-file' : ''}`}
                onDrop={handleDrop}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
            >
                {file ? (
                    <div className="file-info">
                        <span className="file-icon">📄</span>
                        <span className="file-name">{file.name}</span>
                        <span className="file-size">({(file.size / 1024 / 1024).toFixed(2)}MB)</span>
                        <button 
                            className="remove-file"
                            onClick={() => setFile(null)}
                            disabled={loading}
                        >
                            ✕
                        </button>
                    </div>
                ) : (
                    <div className="upload-prompt">
                        <span className="upload-icon">⬆️</span>
                        <p>拖拽Excel文件到此处，或点击选择文件</p>
                        <p className="file-limit">支持.xlsx和.xls格式，文件大小不超过10MB</p>
                    </div>
                )}
                
                <input
                    type="file"
                    accept=".xlsx,.xls"
                    onChange={(e) => handleFileSelect(e.target.files[0])}
                    style={{ display: 'none' }}
                    id="file-input"
                    disabled={loading}
                />
                
                {!file && (
                    <label htmlFor="file-input" className="file-select-button">
                        选择文件
                    </label>
                )}
            </div>
            
            {/* 进度指示器 */}
            {loading && (
                <div className="import-progress">
                    <div className="progress-bar">
                        <div className="progress-fill"></div>
                    </div>
                    <p>正在导入Excel文件，请稍候...</p>
                </div>
            )}
        </div>
    );
};
```

### **2. 卷烟投放基础信息导入组件**

```jsx
const CigaretteInfoImport = () => {
    const [formData, setFormData] = useState({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        weekSeq: 1
    });
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    
    const handleImport = async () => {
        if (!file) {
            message.warning('请选择Excel文件');
            return;
        }
        
        setLoading(true);
        try {
            const result = await importCigaretteInfo(
                file, 
                formData.year, 
                formData.month, 
                formData.weekSeq
            );
            
            message.success(`导入成功！创建表：${result.tableName}，插入${result.insertedCount}条记录`);
            
            // 刷新相关数据
            onImportComplete?.(result);
            
        } catch (error) {
            console.error('导入失败:', error);
        } finally {
            setLoading(false);
        }
    };
    
    return (
        <div className="cigarette-info-import">
            <h3>卷烟投放基础信息导入</h3>
            
            {/* 时间参数设置 */}
            <div className="form-section">
                <div className="form-row">
                    <label>年份:</label>
                    <input
                        type="number"
                        min="2020"
                        max="2099"
                        value={formData.year}
                        onChange={(e) => setFormData(prev => ({
                            ...prev,
                            year: parseInt(e.target.value)
                        }))}
                        disabled={loading}
                    />
                </div>
                
                <div className="form-row">
                    <label>月份:</label>
                    <select
                        value={formData.month}
                        onChange={(e) => setFormData(prev => ({
                            ...prev,
                            month: parseInt(e.target.value)
                        }))}
                        disabled={loading}
                    >
                        {Array.from({ length: 12 }, (_, i) => (
                            <option key={i + 1} value={i + 1}>
                                {i + 1}月
                            </option>
                        ))}
                    </select>
                </div>
                
                <div className="form-row">
                    <label>周序号:</label>
                    <select
                        value={formData.weekSeq}
                        onChange={(e) => setFormData(prev => ({
                            ...prev,
                            weekSeq: parseInt(e.target.value)
                        }))}
                        disabled={loading}
                    >
                        {Array.from({ length: 5 }, (_, i) => (
                            <option key={i + 1} value={i + 1}>
                                第{i + 1}周
                            </option>
                        ))}
                    </select>
                </div>
            </div>
            
            {/* 文件选择 */}
            <ExcelImportComponent
                importType="cigarette"
                onSuccess={() => {}}
                onError={(msg) => message.error(msg)}
            />
            
            {/* 操作按钮 */}
            <div className="action-buttons">
                <button
                    className="import-button"
                    onClick={handleImport}
                    disabled={!file || loading}
                >
                    {loading ? '导入中...' : '开始导入'}
                </button>
                
                <button
                    className="template-button"
                    onClick={() => downloadTemplate('cigarette')}
                    disabled={loading}
                >
                    下载模板
                </button>
            </div>
        </div>
    );
};
```

### **3. 区域客户数表导入组件**

```jsx
const RegionClientNumImport = () => {
    const [formData, setFormData] = useState({
        year: new Date().getFullYear(),
        month: new Date().getMonth() + 1,
        deliveryMethod: '按档位统一投放',
        deliveryEtype: '',
        isBiWeeklyFloat: false
    });
    const [file, setFile] = useState(null);
    const [loading, setLoading] = useState(false);
    
    // 投放类型选项
    const deliveryMethodOptions = [
        { value: '按档位统一投放', label: '按档位统一投放' },
        { value: '按档位扩展投放', label: '按档位扩展投放' }
    ];
    
    const deliveryEtypeOptions = [
        { value: '档位+区县', label: '档位+区县' },
        { value: '档位+市场类型', label: '档位+市场类型' },
        { value: '档位+城乡分类代码', label: '档位+城乡分类代码' },
        { value: '档位+业态', label: '档位+业态' }
    ];
    
    // 预览生成的表名
    const getPreviewTableName = () => {
        try {
            return getTableName(
                formData.deliveryMethod, 
                formData.deliveryEtype, 
                formData.isBiWeeklyFloat
            );
        } catch {
            return '请选择有效的投放类型组合';
        }
    };
    
    const handleImport = async () => {
        if (!file) {
            message.warning('请选择Excel文件');
            return;
        }
        
        setLoading(true);
        try {
            const result = await importRegionClientNum(file, formData);
            
            message.success(
                `导入成功！创建/更新表：${result.tableName}，插入${result.insertedCount}条记录`
            );
            
            onImportComplete?.(result);
            
        } catch (error) {
            console.error('导入失败:', error);
        } finally {
            setLoading(false);
        }
    };
    
    return (
        <div className="region-clientnum-import">
            <h3>区域客户数表导入</h3>
            
            {/* 参数设置 */}
            <div className="form-section">
                <div className="form-row">
                    <label>年份:</label>
                    <input
                        type="number"
                        min="2020"
                        max="2099"
                        value={formData.year}
                        onChange={(e) => setFormData(prev => ({
                            ...prev,
                            year: parseInt(e.target.value)
                        }))}
                        disabled={loading}
                    />
                </div>
                
                <div className="form-row">
                    <label>月份:</label>
                    <select
                        value={formData.month}
                        onChange={(e) => setFormData(prev => ({
                            ...prev,
                            month: parseInt(e.target.value)
                        }))}
                        disabled={loading}
                    >
                        {Array.from({ length: 12 }, (_, i) => (
                            <option key={i + 1} value={i + 1}>
                                {i + 1}月
                            </option>
                        ))}
                    </select>
                </div>
                
                <div className="form-row">
                    <label>投放方法:</label>
                    <select
                        value={formData.deliveryMethod}
                        onChange={(e) => {
                            const method = e.target.value;
                            setFormData(prev => ({
                                ...prev,
                                deliveryMethod: method,
                                deliveryEtype: method === '按档位统一投放' ? '' : '档位+区县'
                            }));
                        }}
                        disabled={loading}
                    >
                        {deliveryMethodOptions.map(option => (
                            <option key={option.value} value={option.value}>
                                {option.label}
                            </option>
                        ))}
                    </select>
                </div>
                
                {formData.deliveryMethod === '按档位扩展投放' && (
                    <div className="form-row">
                        <label>扩展投放类型:</label>
                        <select
                            value={formData.deliveryEtype}
                            onChange={(e) => setFormData(prev => ({
                                ...prev,
                                deliveryEtype: e.target.value
                            }))}
                            disabled={loading}
                        >
                            {deliveryEtypeOptions.map(option => (
                                <option key={option.value} value={option.value}>
                                    {option.label}
                                </option>
                            ))}
                        </select>
                    </div>
                )}
                
                <div className="form-row">
                    <label>
                        <input
                            type="checkbox"
                            checked={formData.isBiWeeklyFloat}
                            onChange={(e) => setFormData(prev => ({
                                ...prev,
                                isBiWeeklyFloat: e.target.checked
                            }))}
                            disabled={loading}
                        />
                        双周上浮
                    </label>
                </div>
                
                {/* 表名预览 */}
                <div className="table-name-preview">
                    <strong>目标表名: </strong>
                    <code>{getPreviewTableName()}</code>
                </div>
            </div>
            
            {/* 文件选择 */}
            <ExcelImportComponent
                importType="region"
                onSuccess={() => {}}
                onError={(msg) => message.error(msg)}
            />
            
            {/* 操作按钮 */}
            <div className="action-buttons">
                <button
                    className="import-button"
                    onClick={handleImport}
                    disabled={!file || loading}
                >
                    {loading ? '导入中...' : '开始导入'}
                </button>
                
                <button
                    className="template-button"
                    onClick={() => downloadTemplate('region')}
                    disabled={loading}
                >
                    下载模板
                </button>
            </div>
        </div>
    );
};
```

---

## 📊 业务逻辑说明

### **数据处理流程**

#### **卷烟投放基础信息导入流程**
```
文件上传 → 格式验证 → 数据解析 → 表结构校验 → 删除旧表 → 创建新表 → 插入数据 → 返回结果
```

**关键特点**：
- **覆盖模式**: 每次导入都会完全替换同名表
- **时间维度**: 支持按年-月-周建立多版本数据
- **数据完整性**: 自动填充YEAR、MONTH、WEEK_SEQ字段

#### **区域客户数表导入流程**  
```
文件上传 → 格式验证 → 投放类型验证 → 表名生成 → 数据解析 → 表结构校验 → 清空旧数据 → 插入新数据 → 返回结果
```

**关键特点**：
- **替换模式**: 清空表数据后插入新数据，保持表结构
- **智能创建**: 表不存在时自动创建，结构与init.sql完全一致
- **分类管理**: 按投放类型和双周上浮标识分表存储

### **表结构一致性保障**

系统确保动态创建的表与`init.sql`中定义的表结构**100%一致**：

#### **卷烟投放基础信息表**
- 字段类型、长度、约束完全匹配
- 自动填充时间维度字段（YEAR、MONTH、WEEK_SEQ）
- 标准字符集和排序规则设置

#### **区域客户数表**
- 根据投放类型动态生成region字段定义
- 30个档位字段（D30-D1）精度为decimal(18,2)
- 自动为档位+区县表添加唯一索引
- 引擎配置包含ROW_FORMAT=DYNAMIC

---

## 🎯 最佳实践建议

### **前端开发建议**

#### **1. 用户体验优化**
```javascript
// 文件验证提前进行
const validateFileBeforeUpload = (file) => {
    const validations = [
        { 
            condition: !file, 
            message: '请选择文件' 
        },
        { 
            condition: file.size > 10 * 1024 * 1024, 
            message: '文件大小不能超过10MB' 
        },
        { 
            condition: !['application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'application/vnd.ms-excel'].includes(file.type),
            message: '请上传Excel文件(.xlsx或.xls)' 
        }
    ];
    
    for (const validation of validations) {
        if (validation.condition) {
            throw new Error(validation.message);
        }
    }
    
    return true;
};

// 导入进度提示
const showImportProgress = () => {
    return message.loading({
        content: '正在导入Excel文件...',
        key: 'import',
        duration: 0
    });
};

const hideImportProgress = () => {
    message.destroy('import');
};
```

#### **2. 错误恢复机制**
```javascript
// 重试机制
const importWithRetry = async (importFunction, args, maxRetries = 3) => {
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await importFunction(...args);
        } catch (error) {
            lastError = error;
            
            // 只有网络错误才重试
            if (error.name === 'TypeError' || error.message.includes('fetch')) {
                console.warn(`导入失败，第${i + 1}次重试:`, error);
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // 递增延迟
                continue;
            } else {
                // 业务错误不重试
                break;
            }
        }
    }
    
    throw lastError;
};
```

#### **3. 数据验证辅助**
```javascript
// Excel模板下载
const downloadExcelTemplate = (type) => {
    const templates = {
        cigarette: {
            filename: '卷烟投放基础信息导入模板.xlsx',
            headers: ['CIG_CODE', 'CIG_NAME', 'DELIVERY_AREA', 'DELIVERY_METHOD', 'DELIVERY_ETYPE', 'URS', 'ADV'],
            sampleData: [
                ['001', '中华(软)', '城区', '按档位统一投放', '', '200.00', '1500.00'],
                ['002', '玉溪(软)', '丹江', '按档位扩展投放', '档位+区县', '150.00', '1200.50']
            ]
        },
        region: {
            filename: '区域客户数表导入模板.xlsx',
            headers: ['region', 'D30', 'D29', 'D28', '...', 'D2', 'D1', 'TOTAL'],
            sampleData: [
                ['城区', '120.00', '150.00', '200.00', '...', '80.00', '60.00', '3500.00'],
                ['农村', '80.00', '100.00', '150.00', '...', '40.00', '30.00', '2200.00']
            ]
        }
    };
    
    const template = templates[type];
    if (template) {
        // 生成Excel文件并下载
        generateExcelFile(template.headers, template.sampleData, template.filename);
    }
};
```

### **性能优化建议**

#### **1. 文件处理优化**
- **分批上传**: 超大文件建议分割后分批导入
- **压缩建议**: 推荐使用.xlsx格式，文件更小
- **并发控制**: 避免同时上传多个文件

#### **2. 用户交互优化**  
- **进度指示**: 显示明确的导入进度和状态
- **结果反馈**: 导入完成后显示详细的统计信息
- **错误引导**: 提供修正建议和模板下载

---

## 📞 技术支持

### **常见问题解答**

#### **Q1: Excel文件列名是否区分大小写？**
**A**: 是的，列名严格区分大小写，必须完全匹配文档中的要求。

#### **Q2: 数值字段可以为空吗？**
**A**: 数值字段支持NULL值，但建议填写0而不是留空，避免计算错误。

#### **Q3: 可以同时导入多个Excel文件吗？**
**A**: 不建议，系统按顺序处理，建议逐个导入以确保数据准确性。

#### **Q4: 双周上浮功能什么时候使用？**
**A**: 当需要区分平时和双周上浮期间的客户分布数据时使用，所有投放类型都支持。

#### **Q5: 导入失败后数据会回滚吗？**
**A**: 是的，使用事务处理，导入失败时会自动回滚，不会产生不完整数据。

### **联系信息**
- **文档版本**: v3.0  
- **更新日期**: 2024-12-29
- **技术支持**: Backend Development Team
- **问题反馈**: 请提供错误信息、Excel文件示例和操作步骤

---

## 📋 更新日志

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v3.0 | 2024-12-29 | 表结构与init.sql完全一致，全面支持双周上浮 |
| v2.0 | 2024-12-20 | 新增双周上浮功能，字段名统一规范 |
| v1.0 | 2024-12-01 | 基础导入功能发布 |

---

## 🎉 总结

本文档提供了卷烟分配系统导入表功能的完整开发指南，涵盖：

- ✅ **完整的API规范** - 详细的接口参数和响应格式
- ✅ **精确的格式要求** - Excel文件结构和数据类型规范  
- ✅ **实用的代码示例** - React组件和JavaScript调用示例
- ✅ **全面的错误处理** - 错误类型分析和处理建议
- ✅ **最佳实践指导** - 性能优化和用户体验建议

**关键特性**：
- 🎯 表结构与init.sql 100%一致
- 🔄 支持所有投放类型的双周上浮功能  
- 📊 智能表名生成和数据验证
- 🛡️ 完善的错误处理和事务保障

开发者可以基于此文档快速、准确地集成导入表功能！🚀
