# 导入表命名规则文档

## 📋 文档概述

**文档目标**: 明确Excel导入功能中卷烟投放基本信息表和区域客户数表的命名规则  
**适用对象**: 系统管理员、数据维护人员、开发人员  
**版本**: v2.1  
**更新日期**: 2025年10月10日  

## 🗂️ 表命名规则详解

### 1. 卷烟投放基本信息表

#### 命名格式
```
cigarette_distribution_info_{year}_{month}_{weekSeq}
```

#### 参数说明
- `{year}`: 年份 (2020-2099)
- `{month}`: 月份 (1-12)
- `{weekSeq}`: 周序号 (1-5)

#### 命名示例
| 时间参数 | 表名示例 |
|---------|----------|
| 2025年9月第1周 | `cigarette_distribution_info_2025_9_1` |
| 2025年12月第3周 | `cigarette_distribution_info_2025_12_3` |
| 2024年1月第5周 | `cigarette_distribution_info_2024_1_5` |

#### 表结构特征
- **基础结构**: 与`demo_test_ADVdata`表保持一致
- **主要字段**: `CIG_CODE`, `CIG_NAME`, `DELIVERY_AREA`, `DELIVERY_METHOD`, `DELIVERY_ETYPE`, `URS`, `ADV`
- **创建策略**: 每次导入时先删除同名表，再重新创建并插入数据

#### 使用场景
```java
// 导入请求示例
CigaretteImportRequestDto request = new CigaretteImportRequestDto();
request.setFile(excelFile);           // Excel文件
request.setYear(2025);                // 年份
request.setMonth(9);                  // 月份
request.setWeekSeq(1);                // 周序号

// 生成的表名: cigarette_distribution_info_2025_9_1
```

---

### 2. 区域客户数表

#### 命名格式
```
region_clientNum_{主序号}_{子序号}
```

#### 序号映射规则

| 投放类型组合 | 投放方法 | 扩展投放类型 | 主序号 | 双周上浮支持 | 非双周上浮表名 | 双周上浮表名 |
|-------------|----------|-------------|--------|-------------|---------------|-------------|
| **按档位统一投放** | 按档位统一投放 | NULL | `0` | ✅ | `region_clientNum_0_1` | `region_clientNum_0_2` |
| **档位+区县** | 按档位扩展投放 | 档位+区县 | `1` | ✅ | `region_clientNum_1_1` | `region_clientNum_1_2` |
| **档位+市场类型** | 按档位扩展投放 | 档位+市场类型 | `2` | ✅ | `region_clientNum_2_1` | `region_clientNum_2_2` |
| **档位+城乡分类代码** | 按档位扩展投放 | 档位+城乡分类代码 | `3` | ✅ | `region_clientNum_3_1` | `region_clientNum_3_2` |
| **档位+业态** | 按档位扩展投放 | 档位+业态 | `4` | ✅ | `region_clientNum_4_1` | `region_clientNum_4_2` |

#### 子序号规则
- **子序号 1**: 非双周上浮（默认）
- **子序号 2**: 双周上浮
- **注意**: 所有投放类型均支持双周上浮区分

#### 序号生成逻辑

##### 主序号生成
```java
public Integer getSequenceNumber() {
    if ("按档位统一投放".equals(deliveryMethod)) {
        return 0;  // 全市统一投放
    } else if ("按档位扩展投放".equals(deliveryMethod)) {
        switch (deliveryEtype) {
            case "档位+区县": return 1;
            case "档位+市场类型": return 2;
            case "档位+城乡分类代码": return 3;
            case "档位+业态": return 4;
            default: return 0;
        }
    }
    return 0; // 默认值
}
```

##### 子序号生成（双周上浮区分）
```java
public Integer getSubSequenceNumber() {
    // 所有投放类型均支持双周上浮区分
    return (isBiWeeklyFloat != null && isBiWeeklyFloat) ? 2 : 1;
}
```

##### 完整表名生成
```java
public String getTableName() {
    Integer mainSeq = getSequenceNumber();
    Integer subSeq = getSubSequenceNumber();
    return String.format("region_clientNum_%d_%d", mainSeq, subSeq);
}
```

#### 表结构特征
- **基础结构**: 与`demo_test_clientNumdata`表保持一致
- **主要字段**: `id`, `region`, `D30`, `D29`, ..., `D2`, `D1`, `TOTAL`
- **档位字段**: 30个档位字段，从`D30`到`D1`
- **区域字段**: 所有投放类型统一使用`region`作为区域字段名，但字段定义根据投放类型有所不同：
  - 按档位统一投放: `region` varchar(50) NOT NULL COMMENT "投放区域"
  - 档位+区县: `region` varchar(100) NOT NULL COMMENT "区县区域"
  - 档位+市场类型: `region` varchar(50) DEFAULT NULL COMMENT "市场类型"
  - 档位+城乡分类代码: `region` varchar(50) DEFAULT NULL COMMENT "城乡分类代码"
  - 档位+业态: `region` varchar(50) NOT NULL COMMENT "业态类型"

#### 创建和维护策略
- **表存在检查**: 导入前检查表是否存在
- **表不存在**: 自动创建新表
- **表已存在**: 清空现有数据，重置自增ID，插入新数据
- **数据替换**: 使用`DELETE + INSERT`策略确保数据完整性

#### 使用场景

##### 场景1：档位+区县，非双周上浮
```java
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+区县");
request.setIsBiWeeklyFloat(false); // 非双周上浮

// getSequenceNumber() 返回: 1
// getSubSequenceNumber() 返回: 1
// getTableName() 返回: region_clientNum_1_1
```

##### 场景2：档位+区县，双周上浮
```java
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+区县");
request.setIsBiWeeklyFloat(true); // 双周上浮

// getSequenceNumber() 返回: 1
// getSubSequenceNumber() 返回: 2
// getTableName() 返回: region_clientNum_1_2
```

##### 场景3：档位+城乡分类代码，双周上浮
```java
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+城乡分类代码");
request.setIsBiWeeklyFloat(true); // 双周上浮

// getSequenceNumber() 返回: 3
// getSubSequenceNumber() 返回: 2
// getTableName() 返回: region_clientNum_3_2
```

##### 场景4：档位+业态，非双周上浮
```java
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+业态");
request.setIsBiWeeklyFloat(false); // 非双周上浮

// getSequenceNumber() 返回: 4
// getSubSequenceNumber() 返回: 1
// getTableName() 返回: region_clientNum_4_1
```

##### 场景5：档位+业态，双周上浮
```java
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+业态");
request.setIsBiWeeklyFloat(true); // 双周上浮

// getSequenceNumber() 返回: 4
// getSubSequenceNumber() 返回: 2
// getTableName() 返回: region_clientNum_4_2
```

## 🔧 实际应用指导

### 导入操作流程

#### 卷烟投放基本信息导入
1. **准备Excel文件** - 确保列名与`demo_test_ADVdata`表一致
2. **填写时间参数** - 指定年份、月份、周序号
3. **执行导入** - 系统自动生成表名并导入数据
4. **验证结果** - 检查表名和数据导入状态

#### 区域客户数表导入
1. **准备Excel文件** - 确保列名与`demo_test_clientNumdata`表一致
2. **选择投放类型** - 指定投放方法和扩展投放类型
3. **设置双周上浮** - 仅对支持的投放类型设置双周上浮标识
4. **执行导入** - 系统根据类型组合和双周上浮标识自动确定表名
5. **验证结果** - 检查表名格式（主序号_子序号）和数据替换状态

### 命名规则验证

#### 表名冲突处理
```sql
-- 卷烟投放基本信息表：每次导入前删除同名表
DROP TABLE IF EXISTS cigarette_distribution_info_2025_9_1;

-- 区域客户数表：检查表是否存在（新命名格式）
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = DATABASE() AND table_name = 'region_clientNum_1_1';

-- 检查双周上浮版本的表
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = DATABASE() AND table_name = 'region_clientNum_1_2';
```

#### 数据完整性保障
- ✅ **卷烟投放基本信息**: 完全重建表结构和数据
- ✅ **区域客户数表**: 保持表结构，替换全部数据
- ✅ **事务支持**: 所有操作在事务中执行，确保原子性
- ✅ **回滚机制**: 导入失败时自动回滚，不影响现有数据

## 📊 数据库管理建议

### 表命名最佳实践

#### 1. 避免表名冲突
```java
// 推荐：在导入前进行表名检查
String tableName = String.format("cigarette_distribution_info_%d_%d_%d", 
                                 year, month, weekSeq);
log.info("准备创建表: {}", tableName);
```

#### 2. 序号映射标准化
```java
// 推荐：使用常量定义序号映射
public class DeliveryTypeSequenceConstants {
    // 主序号常量
    public static final int UNIFIED_DELIVERY = 0;
    public static final int COUNTY_DELIVERY = 1;
    public static final int MARKET_DELIVERY = 2;
    public static final int URBAN_RURAL_DELIVERY = 3;
    public static final int BUSINESS_FORMAT_DELIVERY = 4;
    
    // 子序号常量
    public static final int NON_BIWEEKLY_FLOAT = 1;
    public static final int BIWEEKLY_FLOAT = 2;
}
```

#### 3. 表结构一致性
- ✅ **字段命名**: 确保导入表与系统表字段名称一致
- ✅ **数据类型**: 保持字段数据类型的匹配
- ✅ **约束条件**: 遵循主键、外键等约束规则

### 维护和监控

#### 存储空间管理
```sql
-- 查看导入表的存储占用
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size(MB)',
    -- 解析表名中的序号信息（仅对区域客户数表）
    CASE 
        WHEN table_name LIKE 'region_clientNum_%_%' THEN
            CONCAT('主序号:', SUBSTRING_INDEX(SUBSTRING_INDEX(table_name, '_', -2), '_', 1), 
                   ', 子序号:', SUBSTRING_INDEX(table_name, '_', -1))
        WHEN table_name LIKE 'region_clientNum_%' THEN
            CONCAT('旧格式序号:', SUBSTRING_INDEX(table_name, '_', -1))
        ELSE ''
    END AS 'Sequence_Info'
FROM information_schema.tables 
WHERE table_schema = DATABASE() 
AND (table_name LIKE 'cigarette_distribution_info_%' 
     OR table_name LIKE 'region_clientNum_%')
ORDER BY (data_length + index_length) DESC;
```

#### 历史数据清理
```sql
-- 清理过期的卷烟投放基本信息表 (保留最近3个月)
-- 注意：这需要根据实际业务需求调整清理策略
```

### 📋 导入检查清单

#### 导入前检查
- [ ] Excel文件格式正确 (.xlsx 或 .xls)
- [ ] 文件内容不为空
- [ ] 列名与目标表结构一致
- [ ] 时间参数在有效范围内
- [ ] 投放类型参数匹配序号映射规则

#### 导入后验证
- [ ] 表名生成正确
- [ ] 数据导入完整
- [ ] 记录数量匹配
- [ ] 数据类型正确
- [ ] 无数据格式错误

## 🆘 常见问题解答

### Q1: 如果导入相同时间参数的卷烟投放基本信息会怎样？
**A**: 系统会先删除同名表，然后重新创建并导入新数据。原有数据会被完全替换。

### Q2: 区域客户数表的序号映射规则是怎样的？
**A**: 现在使用两位序号格式（主序号_子序号）。主序号对应投放类型，子序号区分双周上浮。所有投放类型均支持双周上浮区分。

### Q3: 如何处理Excel文件中的无效数据？
**A**: 系统会验证Excel文件结构，对于格式不符合要求的数据会返回错误信息，导入操作会回滚。

### Q4: 可以同时导入多个时间段的数据吗？
**A**: 目前每次导入操作只能处理一个时间段。如需导入多个时间段，需要分别执行导入操作。

### Q5: 区域客户数表的数据是累积的还是替换的？
**A**: 是替换的。每次导入会清空表中的现有数据，然后插入新数据，确保数据的完整性和一致性。

### Q6: 双周上浮功能对哪些投放类型生效？
**A**: 对所有投放类型均生效，包括按档位统一投放、档位+区县、档位+市场类型、档位+城乡分类代码和档位+业态。每种投放类型都支持非双周上浮（子序号1）和双周上浮（子序号2）两种表格。

### Q7: 旧版本的表名格式还能使用吗？
**A**: 系统向下兼容。旧的单序号格式(如region_clientNum_1)仍然可以被识别，但建议使用新的双序号格式以支持双周上浮功能。

### Q8: 如何同时管理非双周上浮和双周上浮的数据？
**A**: 同一投放类型的非双周上浮和双周上浮数据会存储在不同的表中，如region_clientNum_1_1和region_clientNum_1_2，可以根据业务需要分别导入和查询。

## 📞 技术支持

- **命名规则查询**: 参考本文档或联系开发团队
- **导入问题反馈**: 请提供详细的错误信息和Excel文件样本
- **表结构调整**: 需要通过正式的需求变更流程处理
- **数据恢复**: 请联系数据库管理员进行数据备份和恢复

---

**文档版本**: v2.1  
**最后更新**: 2025年10月10日  
**更新内容**: 根据实际代码实现更新双周上浮支持范围，所有投放类型均支持双周上浮区分功能  
**审核状态**: ✅ 已审核通过
