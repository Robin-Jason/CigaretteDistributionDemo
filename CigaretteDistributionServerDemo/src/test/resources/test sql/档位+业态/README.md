# 档位+业态算法测试SQL脚本

## 📋 测试概述

**测试对象**: 档位+业态分配算法  
**测试表**: cigarette_distribution_info_2099_1_2 (输入) → cigarette_distribution_prediction_2099_1_2 (输出)  
**测试用例数**: 约202个  
**业态范围**: 6个业态（便利店、超市、商场、烟草专业店、娱乐服务类、其他）

---

## 📂 文件说明

| 文件名 | 功能 | 说明 |
|-------|------|------|
| `01-create-test-tables.sql` | 创建测试表 | 创建info和prediction表 |
| `02-generate-test-data.sql` | 生成测试数据 | 生成202个测试用例 |
| `03-query-test-results.sql` | 查询测试结果 | 10个预定义查询分析结果 |
| `run-all-tests.sh` | 一键运行测试 | 自动化执行全部测试流程 |
| `README.md` | 使用说明 | 本文档 |

---

## 🚀 快速开始（一键执行）

### 方法1：使用Shell脚本（推荐）

```bash
# 1. 进入脚本目录
cd "src/test/resources/test sql/档位+业态"

# 2. 添加执行权限
chmod +x run-all-tests.sh

# 3. 运行测试
./run-all-tests.sh
```

**说明**: 脚本会自动完成建表、生成数据、调用API、查询结果等所有步骤。

---

### 方法2：手动执行（分步骤）

#### 步骤1：创建测试表
```bash
mysql -h localhost -u root -p marketing < 01-create-test-tables.sql
```

#### 步骤2：生成测试数据
```bash
mysql -h localhost -u root -p marketing < 02-generate-test-data.sql
```

**预期结果**: 生成约202个测试用例

#### 步骤3：调用后端API执行算法
```bash
curl -X POST "http://localhost:28080/api/calculate/write-back?year=2099&month=1&weekSeq=2"
```

**预期响应**: `{"success": true, "successCount": 202, ...}`

#### 步骤4：查询测试结果
```bash
mysql -h localhost -u root -p marketing < 03-query-test-results.sql > test_results.txt
```

#### 步骤5：查看结果
```bash
cat test_results.txt
```

---

## 📊 测试用例设计

### 预投放量分布

| 范围 | 数量 | 说明 |
|-----|------|------|
| 100 | 1 | 固定用例 |
| 500 | 1 | 固定用例 |
| 1000 | 1 | 固定用例 |
| 1000-200000 | 199 | 每1000区间随机1个 |
| **总计** | **202** | - |

### 投放区域组合

**6个业态**:
1. 便利店
2. 超市
3. 商场
4. 烟草专业店
5. 娱乐服务类
6. 其他

**组合规则**: 从6个业态中随机选择2-6个进行组合

| 业态数 | 组合数 | 示例 |
|-------|-------|------|
| 2 | 15 | "便利店,超市" |
| 3 | 20 | "便利店,超市,商场" |
| 4 | 15 | "便利店,超市,商场,烟草专业店" |
| 5 | 6 | "便利店,超市,商场,烟草专业店,娱乐服务类" |
| 6 | 1 | "便利店,超市,商场,烟草专业店,娱乐服务类,其他" |

---

## 🎯 预期测试结果

### 性能指标（参考档位+城乡分类代码）

| 指标 | 预期值 | 说明 |
|-----|--------|------|
| 平均误差率 | < 0.2% | 算法精确度高 |
| 完美率（误差=0） | > 20% | 大量完美匹配 |
| 优秀率（误差≤5） | > 99% | 绝大多数优秀 |
| 最大误差 | < 300 | 控制在合理范围 |

---

## 📝 测试结果查询说明

### 查询1：测试用例总览
- 测试用例总数
- 预投放量范围（最小/最大/平均）

### 查询2：测试结果总览
- 卷烟总数
- 生成的分配记录数

### 查询3：误差分析（每个测试用例）
- 预投放量
- 实际投放量
- 误差（绝对值和百分比）
- 投放业态

### 查询4：误差统计
- 平均误差
- 最大误差
- 平均误差率
- 完美案例数
- 优秀案例数

### 查询5：按预投放量范围统计
- 小/中/大/超大量级分组统计
- 各量级的误差表现

### 查询6：按业态数量统计
- 2-6个业态的误差表现对比

### 查询7-10：典型案例分析
- 最大误差案例
- 最小误差率案例
- 完美案例
- 分配详情示例

---

## ⚠️ 注意事项

### 1. 前提条件

**必须存在的表**:
- `region_clientNum_4_1` - 档位+业态客户数基础数据表

**检查方法**:
```sql
SELECT COUNT(*) FROM region_clientNum_4_1;
```

如果表不存在或无数据，请先导入业态客户数基础数据。

---

### 2. 后端服务状态

确保Spring Boot服务运行在端口28080：
```bash
# 检查服务状态
curl http://localhost:28080/actuator/health

# 如果未运行，启动服务
cd /path/to/project
mvn spring-boot:run
```

---

### 3. 数据库连接

确保MySQL服务运行，并且可以连接到marketing数据库：
```bash
mysql -h localhost -u root -p -e "USE marketing; SELECT 1;"
```

---

## 🔧 故障排除

### 问题1：存储过程执行失败
**现象**: 生成数据时报错  
**解决**: 检查delimiter设置和SQL语法

### 问题2：API调用失败
**现象**: curl返回404或500  
**解决**: 
1. 检查后端服务是否运行
2. 检查端口是否正确（28080）
3. 查看后端日志

### 问题3：查询结果为空
**现象**: prediction表无数据  
**解决**:
1. 检查API是否调用成功
2. 检查后端日志查看错误信息
3. 验证region_clientNum_4_1表是否有数据

---

## 📚 相关文档

- 测试报告模板: `test docs/README_测试报告.md`
- 档位+城乡分类代码测试参考: `test sql/档位+城乡分类代码/`
- API文档: `docs/API文档_一键生成分配方案.md`

---

## 🎉 完成测试后

测试完成后，使用查询结果生成测试报告，报告应包含：
1. 总体统计（成功率、平均误差、误差率）
2. 按预投放量范围分析
3. 按业态数量分析
4. 典型案例分析
5. 数据分布和梯度说明

**报告位置**: `test docs/档位+业态/测试报告_202用例_详细分析.md`

---

**脚本版本**: v1.0  
**创建日期**: 2025-10-19

