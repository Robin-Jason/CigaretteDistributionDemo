### 档位+业态类型算法描述

本文档用于说明“档位+业态类型”的卷烟分配算法逻辑。该业务以“业态类型”为投放单元，沿用通用算法的数学目标与约束，但在数据准备与候选方案生成细节上做了面向业态的适配。


#### 一、数学模型
- 投放单元为“业态类型”。设共有 \( F \) 个业态类型、\( B=30 \) 个档位（D30→D1）。
- \( c_{ij} \)：业态类型 \( i \) 在档位 \( j \) 的客户数（来自业态-客户数矩阵）。
- \( x_{ij} \)：对业态类型 \( i \) 在档位 \( j \) 的分配量（非负整数，满足行内非递增约束）。
- 实际投放量 \( S=\sum_{i=1}^{F}\sum_{j=1}^{B} x_{ij}\,c_{ij} \)，目标最小化 \( |S-T| \)，其中 \( T \) 为预投放量。
- 约束：每个业态类型的分配量从高档位到低档位非递增：\( x_{i1}\ge\cdots\ge x_{iB} \)。

本模型以“业态类型”为投放单元，按档位自高到低满足行内非递增约束，目标是使实际投放量贴近预投放量。

#### 二、数据准备与输入输出
由服务层负责：
- 获取全量业态类型列表（按 id 升序去重）。
- 构建业态-客户数矩阵（维度 \([F]\times[30]\)，列序为 D30→D1）。
- 目标业态筛选：基于表 `demo_test_data` 的投放区域字段 `DELIVERY_AREA`来确认某种卷烟具体投放于哪些业态，使用字符串匹配组件匹配出涉及的业态类型集合。
- 根据目标业态集合提取对应的客户数子矩阵，作为算法输入。

算法输入/输出：
- 输入：卷烟基础信息（即表`demo_test_data`，包括目标烟的投放业态类型列表和预投放量 \( T \)）、业态-客户数子矩阵（\([F']\times[30]\)）。
- 输出：分配矩阵 \([F']\times[30]\)，含各业态、各档位的分配值 \( x_{ij} \)。

#### 三、算法流程（业态版应用）
实现思路：
1) 初始化：将分配矩阵全置 0；当前投放量 `currentAmount=0`。
2) 粗调（整列推进）：自 D30 起逐档位尝试“整列 +1”（对所有目标业态在该档位同时 +1），若加上该列后超出 \( T \) 则停止并回退该列推进，记录最后完整列 `lastFullGrade` 与 `currentAmount`。
3) 候选方案生成与比较：
   - 方案1：粗调矩阵本身（快速下界）。
   - 方案2：在较低档位（`lastFullGrade+1` 之后）对部分业态做“局部 +1”，前提是满足行内非递增约束；逐步累加，尽量贴近 \( T \)。
   - 方案3：再次从高档位起尝试“整列 +1”，在逼近临界时对临近档位的少量业态进行微调（`adjustNearbyGrades`）以兼顾均匀性与误差最小化。
   计算各方案对应的实际投放量与误差，选取误差最小者。
4) 约束收敛：自高到低逐档校正，确保每个业态在行内满足非递增约束。
5) 验证与返回：计算最终实际投放量，记录与 \( T \) 的绝对误差并返回分配矩阵。

设计要点：
- 整列推进以“业态列”为对象：同一档位上，跨业态同步推进，体现跨业态的均衡性。
- 局部微调对具体业态在较低档位有选择地增加 1，并严格校验邻位单调性，保持档位阶梯形态稳定。

#### 四、实际投放量计算（用于校验与统计）
服务层提供业态版实际投放量计算能力：
- 对每条记录取其各档位分配值（D30→D1），与对应业态的客户数逐位相乘并求和。
- 对目标业态集合求和得到总实际投放量，用于与 \( T \) 对比或做业务统计输出。

#### 五、边界与鲁棒性
- 目标业态集合为空、客户数矩阵或 \( T \) 为空时，返回空矩阵或 0，并记录日志。
- 单调性强制收敛可在极少数情况下降低个别低档位的分配，属于对约束的必要修正。
- 客户数缺失（null）按 0 处理；所有乘加运算使用 `BigDecimal` 保证精度。

#### 六、复杂度与可扩展性
- 时间复杂度：粗调与再次整列推进 \( O(F'\cdot B) \)，局部微调近似 \( O(F'\cdot B) \)；整体近似线性于参与业态与档位数。
- 空间复杂度：主矩阵 \( O(F'\cdot B) \)。




