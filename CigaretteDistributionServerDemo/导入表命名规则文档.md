# 导入表命名规则文档

## 📋 文档概述

**文档目标**: 明确Excel导入功能中卷烟投放基本信息表和区域客户数表的命名规则  
**适用对象**: 系统管理员、数据维护人员、开发人员  
**版本**: v1.0  
**更新日期**: 2025年9月18日  

## 🗂️ 表命名规则详解

### 1. 卷烟投放基本信息表

#### 命名格式
```
cigarette_distribution_info_{year}_{month}_{weekSeq}
```

#### 参数说明
- `{year}`: 年份 (2020-2099)
- `{month}`: 月份 (1-12)
- `{weekSeq}`: 周序号 (1-5)

#### 命名示例
| 时间参数 | 表名示例 |
|---------|----------|
| 2025年9月第1周 | `cigarette_distribution_info_2025_9_1` |
| 2025年12月第3周 | `cigarette_distribution_info_2025_12_3` |
| 2024年1月第5周 | `cigarette_distribution_info_2024_1_5` |

#### 表结构特征
- **基础结构**: 与`demo_test_ADVdata`表保持一致
- **主要字段**: `CIG_CODE`, `CIG_NAME`, `DELIVERY_AREA`, `DELIVERY_METHOD`, `DELIVERY_ETYPE`, `URS`, `ADV`
- **创建策略**: 每次导入时先删除同名表，再重新创建并插入数据

#### 使用场景
```java
// 导入请求示例
CigaretteImportRequestDto request = new CigaretteImportRequestDto();
request.setFile(excelFile);           // Excel文件
request.setYear(2025);                // 年份
request.setMonth(9);                  // 月份
request.setWeekSeq(1);                // 周序号

// 生成的表名: cigarette_distribution_info_2025_9_1
```

---

### 2. 区域客户数表

#### 命名格式
```
region_clientNum_{sequenceNumber}
```

#### 序号映射规则

| 投放类型组合 | 投放方法 | 扩展投放类型 | 序号 | 表名示例 |
|-------------|----------|-------------|------|----------|
| **按档位统一投放** | 按档位统一投放 | NULL | `0` | `region_clientNum_0` |
| **档位+区县** | 按档位扩展投放 | 档位+区县 | `1` | `region_clientNum_1` |
| **档位+市场类型** | 按档位扩展投放 | 档位+市场类型 | `2` | `region_clientNum_2` |
| **档位+城乡分类代码** | 按档位扩展投放 | 档位+城乡分类代码 | `3` | `region_clientNum_3` |
| **档位+业态** | 按档位扩展投放 | 档位+业态 | `4` | `region_clientNum_4` |

#### 序号生成逻辑
```java
public Integer getSequenceNumber() {
    if ("按档位统一投放".equals(deliveryMethod)) {
        return 0;  // 全市统一投放
    } else if ("按档位扩展投放".equals(deliveryMethod)) {
        switch (deliveryEtype) {
            case "档位+区县": return 1;
            case "档位+市场类型": return 2;
            case "档位+城乡分类代码": return 3;
            case "档位+业态": return 4;
            default: return 0;
        }
    }
    return 0; // 默认值
}
```

#### 表结构特征
- **基础结构**: 与`demo_test_clientNumdata`表保持一致
- **主要字段**: `id`, `URBAN_RURAL_CODE`, `D30`, `D29`, ..., `D2`, `D1`
- **档位字段**: 30个档位字段，从`D30`到`D1`
- **区域字段**: 根据投放类型不同，区域字段名称有所区别：
  - 按档位统一投放、档位+市场类型、档位+城乡分类代码: `URBAN_RURAL_CODE`
  - 档位+区县: `COUNTY`
  - 档位+业态: `BusinessFormat`

#### 创建和维护策略
- **表存在检查**: 导入前检查表是否存在
- **表不存在**: 自动创建新表
- **表已存在**: 清空现有数据，重置自增ID，插入新数据
- **数据替换**: 使用`DELETE + INSERT`策略确保数据完整性

#### 使用场景
```java
// 导入城乡分类代码类型的区域客户数
RegionClientNumImportRequestDto request = new RegionClientNumImportRequestDto();
request.setFile(excelFile);
request.setYear(2025);
request.setMonth(9);
request.setDeliveryMethod("按档位扩展投放");
request.setDeliveryEtype("档位+城乡分类代码");

// getSequenceNumber() 返回: 3
// 生成的表名: region_clientNum_3
```

## 🔧 实际应用指导

### 导入操作流程

#### 卷烟投放基本信息导入
1. **准备Excel文件** - 确保列名与`demo_test_ADVdata`表一致
2. **填写时间参数** - 指定年份、月份、周序号
3. **执行导入** - 系统自动生成表名并导入数据
4. **验证结果** - 检查表名和数据导入状态

#### 区域客户数表导入
1. **准备Excel文件** - 确保列名与`demo_test_clientNumdata`表一致
2. **选择投放类型** - 指定投放方法和扩展投放类型
3. **执行导入** - 系统根据类型组合自动确定序号和表名
4. **验证结果** - 检查表名和数据替换状态

### 命名规则验证

#### 表名冲突处理
```sql
-- 卷烟投放基本信息表：每次导入前删除同名表
DROP TABLE IF EXISTS cigarette_distribution_info_2025_9_1;

-- 区域客户数表：检查表是否存在
SELECT COUNT(*) FROM information_schema.tables 
WHERE table_schema = DATABASE() AND table_name = 'region_clientNum_3';
```

#### 数据完整性保障
- ✅ **卷烟投放基本信息**: 完全重建表结构和数据
- ✅ **区域客户数表**: 保持表结构，替换全部数据
- ✅ **事务支持**: 所有操作在事务中执行，确保原子性
- ✅ **回滚机制**: 导入失败时自动回滚，不影响现有数据

## 📊 数据库管理建议

### 表命名最佳实践

#### 1. 避免表名冲突
```java
// 推荐：在导入前进行表名检查
String tableName = String.format("cigarette_distribution_info_%d_%d_%d", 
                                 year, month, weekSeq);
log.info("准备创建表: {}", tableName);
```

#### 2. 序号映射标准化
```java
// 推荐：使用常量定义序号映射
public class DeliveryTypeSequenceConstants {
    public static final int UNIFIED_DELIVERY = 0;
    public static final int COUNTY_DELIVERY = 1;
    public static final int MARKET_DELIVERY = 2;
    public static final int URBAN_RURAL_DELIVERY = 3;
    public static final int BUSINESS_FORMAT_DELIVERY = 4;
}
```

#### 3. 表结构一致性
- ✅ **字段命名**: 确保导入表与系统表字段名称一致
- ✅ **数据类型**: 保持字段数据类型的匹配
- ✅ **约束条件**: 遵循主键、外键等约束规则

### 维护和监控

#### 存储空间管理
```sql
-- 查看导入表的存储占用
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size(MB)'
FROM information_schema.tables 
WHERE table_schema = DATABASE() 
AND (table_name LIKE 'cigarette_distribution_info_%' 
     OR table_name LIKE 'region_clientNum_%')
ORDER BY (data_length + index_length) DESC;
```

#### 历史数据清理
```sql
-- 清理过期的卷烟投放基本信息表 (保留最近3个月)
-- 注意：这需要根据实际业务需求调整清理策略
```

### 📋 导入检查清单

#### 导入前检查
- [ ] Excel文件格式正确 (.xlsx 或 .xls)
- [ ] 文件内容不为空
- [ ] 列名与目标表结构一致
- [ ] 时间参数在有效范围内
- [ ] 投放类型参数匹配序号映射规则

#### 导入后验证
- [ ] 表名生成正确
- [ ] 数据导入完整
- [ ] 记录数量匹配
- [ ] 数据类型正确
- [ ] 无数据格式错误

## 🆘 常见问题解答

### Q1: 如果导入相同时间参数的卷烟投放基本信息会怎样？
**A**: 系统会先删除同名表，然后重新创建并导入新数据。原有数据会被完全替换。

### Q2: 区域客户数表的序号是固定的吗？
**A**: 是的，序号映射是固定的。每种投放类型组合对应唯一的序号，确保表名的一致性。

### Q3: 如何处理Excel文件中的无效数据？
**A**: 系统会验证Excel文件结构，对于格式不符合要求的数据会返回错误信息，导入操作会回滚。

### Q4: 可以同时导入多个时间段的数据吗？
**A**: 目前每次导入操作只能处理一个时间段。如需导入多个时间段，需要分别执行导入操作。

### Q5: 区域客户数表的数据是累积的还是替换的？
**A**: 是替换的。每次导入会清空表中的现有数据，然后插入新数据，确保数据的完整性和一致性。

## 📞 技术支持

- **命名规则查询**: 参考本文档或联系开发团队
- **导入问题反馈**: 请提供详细的错误信息和Excel文件样本
- **表结构调整**: 需要通过正式的需求变更流程处理
- **数据恢复**: 请联系数据库管理员进行数据备份和恢复

---

**文档版本**: v1.0  
**最后更新**: 2025年9月18日  
**审核状态**: ✅ 已审核通过
