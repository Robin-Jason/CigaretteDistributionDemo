

### 全市卷烟投放预测的数学模型与算法描述

#### 数学模型
全市卷烟投放预测问题可以建模为一个单区域（全市）的优化问题。其核心目标是在满足**非递增约束**的前提下，为全市30个档位的客户制定一个统一的分配方案，使得最终的实际总投放量与预设的总投放量误差最小。

-   设投放区域 \( R=1 \)，代表“全市”这一个整体区域。
-   设档位数量 \( B=30 \)，从最高档位D30（对应 \( j=1 \)）到最低档位D1（对应 \( j=30 \)）。
-   对于每个档位 \( j \)，令 \( c_j \) 表示全市范围内该档位的客户总数。此数据从 `city_clientnum_data` 表中 `URBAN_RURAL_CODE` 为“全市”的记录里获取。
-   令 \( x_j \) 为分配给全市档位 \( j \) 的卷烟数量（即每个该档位的客户获得的数量）。\( x_j \) 是一个非负数，并满足**非递增约束**：\( x_1 \geq x_2 \geq \cdots \geq x_B \)。
-   实际总投放量 \( S \) 的计算公式为：\( S = \sum_{j=1}^{B} x_j c_j \)。
-   预投放量 \( T \) 从 `demo_test_ADVdata` 表中获取，对应每个卷烟品种。
-   算法的目标是：**最小化误差** \( |S - T| \)。

#### 算法描述
该算法在 `CityCigaretteDistributionAlgorithm.java` 中实现，通过贪心填充和迭代微调相结合的方式，在满足约束的同时，逐步逼近预设的投放总量 \( T \)。

1.  **确定客户数向量**：从 `city_clientnum_data` 表中查询“全市”的记录，获取一个包含30个档位客户数的向量 \( C = [c_1, c_2, ……, c_{30}] \)。

2.  **初始化分配方案**：在 `calculateDistribution` 方法中，创建一个大小为 `[1][30]` 的分配矩阵 `allocationMatrix`，并将其所有元素 \( x_j \) 初始化为0。

3.  **贪心填充过程 (`greedyFill`方法)**：
    * 这是一个初步的粗调过程，旨在快速接近目标投放量 \( T \) 而不超过它。
    * 算法会循环遍历所有档位（从D30到D1）和所有区域（在此模型中仅有“全市”一个区域）。
    * 在每次循环中，只要增加一个单位的投放量（`INCREMENT`，值为1）后，计算出的总投放量 `currentAmount` 仍然小于等于 \( T \)，并且满足非递增约束（通过 `isValidIncrement` 方法检查），就会将该档位的分配值 \( x_j \) 增加1。
    * 此过程会持续进行，直到无法再增加任何档位的分配值为止，形成一个基础的分配方案。

4.  **迭代微调过程 (`iterativeRefinement`方法)**：
    * 在贪心填充的基础上，进行精细调整以进一步减小误差 \( |S - T| \)。
    * 此方法会进行最多 `MAX_ITERATIONS`（预设为100次）的循环。
    * 在每次迭代中，算法会遍历所有30个档位，尝试对每个档位的分配值 \( x_j \) 进行两种操作：增加1或减少1。
    * 每次尝试调整后，都会使用 `isMonotonic` 方法检查整个分配方案是否仍然满足**非递增约束**。
    * 如果调整有效（满足约束），则计算新的总投放量和新的误差。算法会记录下在本次迭代中能够使误差变得最小的那一次调整（哪个档位、增加还是减少）。
    * 在单次迭代结束后，采纳那个最优的调整。如果没有任何调整能减小误差，则提前终止微调。

5.  **最终约束强制执行 (`enforceMonotonicConstraint`方法)**：
    * 在微调过程结束后，为确保最终结果的绝对可靠，此方法会最后进行一次检查。
    * 它会从第二个档位（D29）开始遍历，如果发现任何档位的分配值 \( x_j \) 大于了它前一个（更高一级）档位的分配值 \( x_{j-1} \)，就会强制将 \( x_j \) 设为与 \( x_{j-1} \) 相等，从而保证最终输出的分配方案严格遵守非递增约束。

#### 关键因素
-   **非递增约束**：这是算法的核心约束，确保高等级客户的配额不会低于低等级客户。此约束在`iterativeRefinement`和`greedyFill`过程中被持续检查，并在`enforceMonotonicConstraint`中被最终强制执行，确保了分配方案的合理性与公平性。
-   **误差最小化**：算法通过“粗调 (`greedyFill`) + 精调 (`iterativeRefinement`)”的两阶段设计，致力于找到一个能使实际投放总量 \( S \) 与预设目标 \( T \) 最为接近的分配方案。
-   **全市统一方案**：此算法是为全市预测场景设计的，因此它不处理多区域的复杂分配矩阵，而是生成一个统一的、适用于“全市”范围的一维档位分配方案。