# 业态类型功能说明

## 概述

在原有的"档位+城乡分类代码"处理方式基础上，新增了"档位+业态类型"的处理方式。系统现在可以根据`demo_test_advdata`表中的`DELIVERY_ETYPE`字段自动选择使用哪种处理方式。

## 新增功能

### 1. 数据库表
- **demo_test_businessFormat_clientNumData**: 业态类型客户数数据表
  - 字段：`BUSINESS_FORMAT_CODE`（业态类型代码）、`D30`~`D1`（各档位客户数）、`TOTAL`（总客户数）

### 2. 实体类和Repository
- **DemoTestBusinessFormatClientNumData**: 业态类型客户数实体类
- **DemoTestBusinessFormatClientNumDataRepository**: 业态类型数据访问接口

### 3. 服务层扩展
- **getAllBusinessFormatList()**: 获取所有业态类型列表
- **getBusinessFormatCustomerMatrix()**: 获取业态类型客户数矩阵
- **getTargetBusinessFormatList()**: 获取目标业态类型列表（KMP匹配）
- **calculateBusinessFormatDistributionMatrix()**: 计算业态类型分配矩阵

### 4. 控制器新增接口
- **GET /api/cigarette/test-business-format-matrix**: 测试业态类型客户数矩阵
- **GET /api/cigarette/test-business-format-kmp-matching**: 测试业态类型KMP匹配
- **GET /api/cigarette/test-business-format-algorithm**: 测试业态类型分配算法

## 处理逻辑

### 自动识别处理方式
系统根据`demo_test_advdata`表中的`DELIVERY_ETYPE`字段自动选择处理方式：

1. **DELIVERY_ETYPE = "档位+业态类型"**
   - 使用`demo_test_businessFormat_clientNumData`作为工具表
   - 对`delivery_area`字段进行KMP匹配，找到对应的业态类型
   - 使用业态类型客户数矩阵进行分配算法计算

2. **DELIVERY_ETYPE = "档位+城乡分类代码"**（默认）
   - 使用`demo_test_clientNumdata`作为工具表
   - 对`delivery_area`字段进行KMP匹配，找到对应的城乡分类代码
   - 使用城乡分类代码客户数矩阵进行分配算法计算

### 写回数据库
- 两种处理方式都会将分配结果写回`demo_test_data`表
- 在`delivery_area`字段中存储匹配到的目标（业态类型代码或城乡分类代码）
- 分配矩阵的D30~D1值存储在对应的档位字段中

## 使用方法

### 1. 数据库准备
```sql
-- 执行建表脚本
source create_business_format_table.sql;
```

### 2. 配置数据
在`demo_test_advdata`表中设置：
- `delivery_etype = "档位+业态类型"`
- `delivery_area = "BF001,BF002"`（业态类型代码，用逗号分隔）

### 3. 测试接口
```bash
# 测试业态类型客户数矩阵
curl http://localhost:28080/api/cigarette/test-business-format-matrix

# 测试业态类型KMP匹配
curl http://localhost:28080/api/cigarette/test-business-format-kmp-matching

# 测试业态类型分配算法
curl http://localhost:28080/api/cigarette/test-business-format-algorithm

# 写回分配矩阵（支持两种类型）
curl -X POST http://localhost:28080/api/cigarette/write-back?year=2024&month=1&weekSeq=1
```

## 注意事项

1. **数据一致性**: 确保`demo_test_businessFormat_clientNumData`表中的业态类型代码与`delivery_area`字段中的值一致
2. **KMP匹配**: 系统使用KMP算法进行字符串匹配，支持模糊匹配
3. **缓存机制**: 业态类型列表和客户数矩阵会被缓存，提高性能
4. **错误处理**: 如果匹配不到对应的业态类型，会跳过该卷烟的处理

## 扩展性

该架构设计支持未来添加更多处理方式：
- 只需在`writeBackAllocationMatrix`方法中添加新的`DELIVERY_ETYPE`判断分支
- 创建对应的工具表和实体类
- 实现相应的客户数矩阵获取和匹配逻辑
