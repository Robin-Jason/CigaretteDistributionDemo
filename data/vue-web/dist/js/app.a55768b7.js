(function(e){function t(t){for(var a,l,n=t[0],s=t[1],c=t[2],h=0,m=[];h<n.length;h++)l=n[h],Object.prototype.hasOwnProperty.call(r,l)&&r[l]&&m.push(r[l][0]),r[l]=0;for(a in s)Object.prototype.hasOwnProperty.call(s,a)&&(e[a]=s[a]);d&&d(t);while(m.length)m.shift()();return i.push.apply(i,c||[]),o()}function o(){for(var e,t=0;t<i.length;t++){for(var o=i[t],a=!0,n=1;n<o.length;n++){var s=o[n];0!==r[s]&&(a=!1)}a&&(i.splice(t--,1),e=l(l.s=o[0]))}return e}var a={},r={app:0},i=[];function l(t){if(a[t])return a[t].exports;var o=a[t]={i:t,l:!1,exports:{}};return e[t].call(o.exports,o,o.exports,l),o.l=!0,o.exports}l.m=e,l.c=a,l.d=function(e,t,o){l.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},l.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},l.t=function(e,t){if(1&t&&(e=l(e)),8&t)return e;if(4&t&&"object"===typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(l.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)l.d(o,a,function(t){return e[t]}.bind(null,a));return o},l.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return l.d(t,"a",t),t},l.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},l.p="/";var n=window["webpackJsonp"]=window["webpackJsonp"]||[],s=n.push.bind(n);n.push=t,n=n.slice();for(var c=0;c<n.length;c++)t(n[c]);var d=s;i.push([0,"chunk-vendors"]),o()})({0:function(e,t,o){e.exports=o("56d7")},"2c8d":function(e,t,o){},"423a":function(e,t,o){"use strict";o("6394")},"491f":function(e,t,o){"use strict";o("812e")},"4cc8":function(e,t,o){},"4d9e":function(e,t,o){"use strict";o("c5bf")},"56d7":function(e,t,o){"use strict";o.r(t);var a=o("7a23");const r={id:"app"};function i(e,t,o,i,l,n){const s=Object(a["resolveComponent"])("router-view");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",r,[Object(a["createVNode"])(s)])}var l={name:"App"},n=(o("7e3f"),o("6b0d")),s=o.n(n);const c=s()(l,[["render",i]]);var d=c,h=o("6605");const m={class:"layout-container"},u={class:"sidebar"},p={class:"main-content"},b={class:"import-section"},g={class:"data-table-section"},O={class:"form-section"};function f(e,t,o,r,i,l){const n=Object(a["resolveComponent"])("Grid"),s=Object(a["resolveComponent"])("el-icon"),c=Object(a["resolveComponent"])("el-menu-item"),d=Object(a["resolveComponent"])("el-menu"),h=Object(a["resolveComponent"])("ImportTable"),f=Object(a["resolveComponent"])("DataTable"),j=Object(a["resolveComponent"])("SearchForm");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",m,[Object(a["createElementVNode"])("aside",u,[t[1]||(t[1]=Object(a["createElementVNode"])("div",{class:"sidebar-header"},[Object(a["createElementVNode"])("h2",null,"卷烟投放管理系统")],-1)),Object(a["createVNode"])(d,{"default-active":"1",class:"sidebar-menu","background-color":"#2c3e50","text-color":"#ffffff","active-text-color":"#409EFF"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(c,{index:"1"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(n)]),_:1}),t[0]||(t[0]=Object(a["createElementVNode"])("span",null,"模型投放",-1))]),_:1})]),_:1})]),Object(a["createElementVNode"])("main",p,[Object(a["createElementVNode"])("section",b,[Object(a["createVNode"])(h,{onImportSuccess:l.handleImportSuccess,onDataRefresh:l.handleDataRefresh},null,8,["onImportSuccess","onDataRefresh"])]),Object(a["createElementVNode"])("section",g,[Object(a["createVNode"])(f,{ref:"dataTable","search-params":i.searchParams,onRowSelected:l.handleRowSelected,onDataLoaded:l.handleDataLoaded},null,8,["search-params","onRowSelected","onDataLoaded"])]),Object(a["createElementVNode"])("section",O,[Object(a["createVNode"])(j,{ref:"searchForm","selected-record":i.selectedRecord,"table-data":i.tableData,onSearch:l.handleSearch,onSearchNext:l.handleSearchNext,onReset:l.handleReset,onExport:l.handleExport,onCigaretteNameMatched:l.handleCigaretteNameMatched,onPositionUpdated:l.handlePositionUpdated,onAreaAdded:l.handleAreaAdded,onAreasDeleted:l.handleAreasDeleted,onRefreshBeforeFilter:l.handleRefreshBeforeFilter},null,8,["selected-record","table-data","onSearch","onSearchNext","onReset","onExport","onCigaretteNameMatched","onPositionUpdated","onAreaAdded","onAreasDeleted","onRefreshBeforeFilter"])])])])}var j=o("f6f2"),y=o("3ef4");const C={class:"data-table-container"},x={class:"table-header"},w={class:"header-actions"},V={key:0,class:"table-content"},N={class:"encoded-expression"},v={key:1,class:"no-encoding"},D={key:1,class:"no-data-tip"};function k(e,t,o,r,i,l){const n=Object(a["resolveComponent"])("Refresh"),s=Object(a["resolveComponent"])("el-icon"),c=Object(a["resolveComponent"])("el-button"),d=Object(a["resolveComponent"])("Download"),h=Object(a["resolveComponent"])("el-table-column"),m=Object(a["resolveComponent"])("el-tooltip"),u=Object(a["resolveComponent"])("el-table"),p=Object(a["resolveComponent"])("el-empty"),b=Object(a["resolveDirective"])("loading");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",C,[Object(a["createElementVNode"])("div",x,[t[1]||(t[1]=Object(a["createElementVNode"])("h3",null,"卷烟投放数据统计表",-1)),Object(a["createElementVNode"])("div",w,[Object(a["createVNode"])(c,{type:"primary",size:"small",onClick:l.handleRefresh},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(n)]),_:1}),t[0]||(t[0]=Object(a["createTextVNode"])(" 刷新 ",-1))]),_:1},8,["onClick"]),Object(a["createVNode"])(c,{type:"success",size:"small",onClick:l.handleExport,loading:i.exportLoading,disabled:0===i.tableData.length},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(d)]),_:1}),Object(a["createTextVNode"])(" "+Object(a["toDisplayString"])(i.exportLoading?"导出中...":"导出Excel"),1)]),_:1},8,["onClick","loading","disabled"])])]),i.tableData.length>0?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",V,[Object(a["withDirectives"])((Object(a["openBlock"])(),Object(a["createBlock"])(u,{data:i.tableData,style:{width:"100%"},height:"100%",border:"",stripe:"",size:"default","header-cell-style":{background:"#f5f7fa",color:"#606266"},"row-class-name":l.getRowClassName,onRowClick:l.handleRowClick,"highlight-current-row":"","element-loading-text":"正在加载数据..."},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(h,{prop:"cigCode",label:"卷烟代码",width:"100",align:"center"}),Object(a["createVNode"])(h,{prop:"cigName",label:"卷烟名称",width:"180"}),Object(a["createVNode"])(h,{prop:"dateDisplay",label:"日期",width:"150",align:"center"}),Object(a["createVNode"])(h,{prop:"encodedExpression",label:"编码表达",width:"200",align:"center"},{default:Object(a["withCtx"])(e=>[e.row.encodedExpression?(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:0,content:e.row.decodedExpression||"暂无解码信息",placement:"top"},{default:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("span",N,Object(a["toDisplayString"])(e.row.encodedExpression),1)]),_:2},1032,["content"])):(Object(a["openBlock"])(),Object(a["createElementBlock"])("span",v,"-"))]),_:1}),Object(a["createVNode"])(h,{prop:"deliveryArea",label:"投放区域",width:"200"}),(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.reversedPositions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(h,{key:"d"+e,prop:"d"+e,label:e+"档",width:"50",align:"center"},{default:Object(a["withCtx"])(t=>[Object(a["createElementVNode"])("span",{class:Object(a["normalizeClass"])(l.getCellClass(t.row["d"+e]))},Object(a["toDisplayString"])(t.row["d"+e]||0),3)]),_:2},1032,["prop","label"]))),128)),Object(a["createVNode"])(h,{prop:"remark",label:"备注","min-width":"120"})]),_:1},8,["data","row-class-name","onRowClick"])),[[b,i.loading]])])):(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",D,[Object(a["createVNode"])(p,{description:"暂无数据","image-size":100},{description:Object(a["withCtx"])(()=>[...t[2]||(t[2]=[Object(a["createElementVNode"])("span",null,"请先输入查询条件进行查询",-1)])]),_:1})]))])}var F=o("cee4");const E=e=>{const t=Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_API_BASE_URL||"http://localhost:28080"+e,o=F["a"].create({baseURL:t,timeout:1e4});return o.interceptors.request.use(e=>(console.log("发送请求:",e.method&&e.method.toUpperCase(),e.url,e.data||e.params),e),e=>(console.error("请求错误:",e),Promise.reject(e))),o.interceptors.response.use(e=>(console.log("响应数据:",e.data),e),e=>(console.error("响应错误:",e),Promise.reject(e))),o},R=E("/api/data"),T=E("/api/common"),I=E("/api/calculate"),S=E("/api/import"),B={healthCheck(){return T.get("/health")},queryDistribution(e){return R.post("/query",e,{headers:{"Content-Type":"application/json"}})},updateCigaretteInfo(e){return R.post("/update-cigarette",e,{headers:{"Content-Type":"application/json"}})},deleteDeliveryAreas(e){return R.post("/delete-delivery-areas",e,{headers:{"Content-Type":"application/json"}})},batchUpdateFromExpressions(e){return R.post("/batch-update-from-expressions",e,{headers:{"Content-Type":"application/json"}})},writeBackDistribution(e){return I.post(`/write-back?year=${e.year}&month=${e.month}&weekSeq=${e.weekSeq}`)},generateDistributionPlan(e){let t=`/generate-distribution-plan?year=${e.year}&month=${e.month}&weekSeq=${e.weekSeq}`;if(void 0!==e.urbanRatio&&void 0!==e.ruralRatio){const o=e.urbanRatio/100,a=e.ruralRatio/100;t+=`&urbanRatio=${o}&ruralRatio=${a}`}return I.post(t)},calculateTotalActualDelivery(e){return I.post(`/total-actual-delivery?year=${e.year}&month=${e.month}&weekSeq=${e.weekSeq}`)},importBasicInfo(e){return S.post("/cigarette-info",e,{headers:{}})},importCustomerData(e){return S.post("/region-clientnum",e,{headers:{}})},queryRawData(e){return console.warn("queryRawData 接口已废弃，请使用 queryDistribution"),this.queryDistribution(e)},updateDistribution(e){return console.warn("updateDistribution 接口已废弃，请使用 updateCigaretteInfo"),this.updateCigaretteInfo(e)},testAlgorithm(){return console.warn("testAlgorithm 接口暂不可用，请联系后端开发"),Promise.reject(new Error("接口暂不可用"))}};var A=o("25ca"),_=o("21a6");class ${static exportCigaretteData(e,t={},o=""){try{if(!e||!Array.isArray(e)||0===e.length)throw new Error("没有可导出的数据");const a=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),r=`卷烟投放数据统计表_${a}.xlsx`,i=o||r,l=this.generateHeaders(),n=this.prepareTableData(e,l),s=A["a"].book_new(),c=A["a"].aoa_to_sheet(n);this.setColumnWidths(c,l),this.setWorksheetStyles(c,n.length),A["a"].book_append_sheet(s,c,"卷烟投放数据"),Object.keys(t).length>0&&this.addSearchInfoSheet(s,t);const d=A["b"](s,{bookType:"xlsx",type:"array"}),h=new Blob([d],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});return Object(_["saveAs"])(h,i),{success:!0,message:"Excel文件导出成功",filename:i}}catch(a){return console.error("Excel导出失败:",a),{success:!1,message:"导出失败: "+a.message,error:a}}}static generateHeaders(){const e=["卷烟代码","卷烟名称","年份","月份","周序号","编码表达","解码表达","投放区域","预投放量","实际投放量"],t=[];for(let a=30;a>=1;a--)t.push(a+"档");const o=["备注"];return[...e,...t,...o]}static prepareTableData(e,t){const o=[];return o.push(t),e.forEach(e=>{const t=[e.cigCode||"",e.cigName||"",e.year||"",e.month||"",e.weekSeq||"",e.encodedExpression||"",e.decodedExpression||"",e.deliveryArea||"",e.advAmount||0,e.actualDelivery||0];for(let o=30;o>=1;o--){const a="d"+o;t.push(e[a]||0)}t.push(e.remark||""),o.push(t)}),o}static setColumnWidths(e,t){const o={"卷烟代码":12,"卷烟名称":25,"年份":8,"月份":8,"周序号":10,"编码表达":25,"解码表达":40,"投放区域":30,"预投放量":12,"实际投放量":12,"备注":20};t.forEach((t,a)=>{const r=A["a"].encode_col(a);o[t]?e[r+"1"]={...e[r+"1"],w:o[t]}:t.includes("档")&&(e[r+"1"]={...e[r+"1"],w:8})})}static setWorksheetStyles(e,t){const o=A["a"].decode_range(e["!ref"]);for(let a=o.s.c;a<=o.e.c;a++){const t=A["a"].encode_col(a),o=e[t+"1"];o&&(o.s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}})}for(let a=2;a<=t+1;a++)for(let t=o.s.c;t<=o.e.c;t++){const o=A["a"].encode_col(t),r=e[`${o}${a}`];r&&(r.s=t>=10&&t<=39?{alignment:{horizontal:"center",vertical:"center"},border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}}:{border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}})}}static addSearchInfoSheet(e,t){const o=[["查询条件信息"],[""],["查询时间",(new Date).toLocaleString("zh-CN")],["年份",t.year||"未指定"],["月份",t.month||"未指定"],["周序号",t.weekSeq||"未指定"],[""],["导出说明"],["本文件包含卷烟投放数据统计表，包含30个档位的分配值"],["数据来源：系统查询结果"],["导出时间："+(new Date).toLocaleString("zh-CN")]],a=A["a"].aoa_to_sheet(o);a["A1"]={...a["A1"],w:20},a["B1"]={...a["B1"],w:30},a["A1"].s={font:{bold:!0,size:14,color:{rgb:"4472C4"}}},A["a"].book_append_sheet(e,a,"查询信息")}static exportPositionData(e,t={},o=""){try{if(!e||0===Object.keys(e).length)throw new Error("没有可导出的档位数据");const a=(new Date).toISOString().slice(0,19).replace(/:/g,"-"),r=`档位设置_${t.cigName||"卷烟"}_${a}.xlsx`,i=o||r,l=A["a"].book_new(),n=this.preparePositionTableData(e,t),s=A["a"].aoa_to_sheet(n);s["A1"]={...s["A1"],w:15},s["B1"]={...s["B1"],w:12},s["A1"].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"}},s["B1"].s={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{fgColor:{rgb:"4472C4"}},alignment:{horizontal:"center",vertical:"center"}},A["a"].book_append_sheet(l,s,"档位设置");const c=A["b"](l,{bookType:"xlsx",type:"array"}),d=new Blob([c],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});return Object(_["saveAs"])(d,i),{success:!0,message:"档位设置Excel文件导出成功",filename:i}}catch(a){return console.error("档位设置Excel导出失败:",a),{success:!1,message:"导出失败: "+a.message,error:a}}}static preparePositionTableData(e,t){const o=[["档位","分配值"]];for(let a=30;a>=1;a--){const t="position"+a,r=e[t]||0;o.push([a+"档",r])}return t.cigName&&(o.unshift(["卷烟名称",t.cigName]),o.unshift([""])),o}}var P={name:"DataTable",components:{Download:j["Download"],Refresh:j["Refresh"]},props:{searchParams:{type:Object,default:()=>({})}},emits:["row-selected","data-loaded"],data(){return{selectedRow:null,tableData:[],loading:!1,total:0,originalTotal:0,exportLoading:!1}},computed:{reversedPositions(){return Array.from({length:30},(e,t)=>30-t)}},watch:{searchParams:{handler(e){e&&Object.keys(e).length>0&&this.loadData(e)},deep:!0,immediate:!0}},methods:{async loadData(e){if(e.year&&e.month&&e.weekSeq){this.loading=!0;try{const t=await B.queryDistribution({year:e.year,month:e.month,weekSeq:e.weekSeq});if(t.data.success){let e=t.data.data||[];this.total=t.data.total||0,this.originalTotal=t.data.originalTotal||0,e=e.map(e=>({...e,dateDisplay:this.formatDate(e.year,e.month,e.weekSeq)})),this.tableData=this.sortDataForGrouping(e),y["a"].success(`查询成功，共找到 ${this.total} 条记录（原始记录：${this.originalTotal} 条）`),this.$emit("data-loaded",this.tableData),1===this.tableData.length&&(this.handleRowClick(this.tableData[0]),y["a"].info("已自动选中唯一记录"))}else y["a"].error(t.data.message||"查询失败")}catch(t){console.error("查询数据失败:",t),y["a"].error("查询数据失败，请检查网络连接")}finally{this.loading=!1}}},getCellClass(e){return e&&0!==e?e>30?"high-value":e>10?"medium-value":"low-value":""},getRowClassName({row:e,rowIndex:t}){let o="";if(this.selectedRow){const t=String(this.selectedRow.cigCode||"").trim(),a=String(e.cigCode||"").trim(),r=parseInt(this.selectedRow.year)||0,i=parseInt(e.year)||0,l=parseInt(this.selectedRow.month)||0,n=parseInt(e.month)||0,s=parseInt(this.selectedRow.weekSeq)||0,c=parseInt(e.weekSeq)||0,d=t===a&&r===i&&l===n&&s===c;if(d){o+="selected-group-row ";const t=String(this.selectedRow.deliveryArea||"").trim(),a=String(e.deliveryArea||"").trim();t===a&&(o+="current-selected ")}}return this.isGroupFirstRow(e,t)&&(o+="group-first-row "),o.trim()},handleRowClick(e){this.selectedRow={...e};const t={...e,cigCode:e.cigCode,cigName:e.cigName,year:e.year,month:e.month,weekSeq:e.weekSeq,advAmount:e.advAmount,actualDelivery:e.actualDelivery,deliveryArea:e.deliveryArea,deliveryMethod:e.deliveryMethod,deliveryEtype:e.deliveryEtype,remark:e.remark};this.scrollToSelectedGroup(),console.log("选中行详细信息:",{selectedRow:this.selectedRow,selectedRecord:t}),this.$emit("row-selected",t)},handleRefresh(){this.searchParams&&Object.keys(this.searchParams).length>0?this.loadData(this.searchParams):y["a"].warning("请先设置查询条件")},handleExport(){if(0!==this.tableData.length){this.exportLoading=!0;try{const e=$.exportCigaretteData(this.tableData,this.searchParams);e.success?y["a"].success("Excel文件导出成功："+e.filename):y["a"].error(e.message)}catch(e){console.error("导出失败:",e),y["a"].error("导出失败，请稍后重试")}finally{this.exportLoading=!1}}else y["a"].warning("暂无数据可导出")},formatDate(e,t,o){return e&&t&&o?`${e}年${t}月第${o}周`:""},sortDataForGrouping(e){return e.sort((e,t)=>e.cigName!==t.cigName?e.cigName.localeCompare(t.cigName,"zh-CN"):e.year!==t.year?e.year-t.year:e.month!==t.month?e.month-t.month:e.weekSeq!==t.weekSeq?e.weekSeq-t.weekSeq:(e.deliveryArea||"").localeCompare(t.deliveryArea||"","zh-CN"))},isGroupFirstRow(e,t){if(0===t)return!0;const o=this.tableData[t-1];return!o||(String(e.cigName||"")!==String(o.cigName||"")||Number(e.year)!==Number(o.year)||Number(e.month)!==Number(o.month)||Number(e.weekSeq)!==Number(o.weekSeq))},scrollToSelectedGroup(){this.$nextTick(()=>{const e=document.querySelector(".selected-group-row");e&&e.scrollIntoView({behavior:"smooth",block:"center"})})},scrollToSelectedRecord(e){this.selectedRow={...e},this.scrollToSelectedGroup()},updatePositionData(e,t,o,a,r){const i=this.tableData.findIndex(r=>r.cigCode===e&&r.year===t&&r.month===o&&r.weekSeq===a);if(-1!==i){const t={...this.tableData[i]};Object.keys(r).forEach(e=>{if(e.startsWith("position")){const o=e.replace("position",""),a="d"+o;t[a]=r[e]}}),this.tableData.splice(i,1,t),console.log("表格数据已更新: "+e,t),y["a"].success("档位数据更新成功")}}}};o("423a");const q=s()(P,[["render",k],["__scopeId","data-v-09666fb2"]]);var M=q;const L={class:"search-form-container"},z={key:3,class:"position-settings-section"},U={class:"position-header"},W={class:"position-view-toggle"},G={key:0,class:"position-grid"},H={class:"position-label"},Y={class:"dialog-footer"},Q={key:1,class:"encoded-expression-section"},J={class:"encoded-expression-input-container"},K={key:0,class:"decoded-expression-display"},X={class:"encoded-expression-validation"},Z={key:1,class:"encoded-expression-hint"},ee={key:2,class:"edit-mode-status"},te={class:"position-actions"},oe={key:2,class:"delete-area-section"},ae={class:"delete-area-tips"},re={key:0,style:{"margin-left":"5px"}};function ie(e,t,o,r,i,l){const n=Object(a["resolveComponent"])("el-option"),s=Object(a["resolveComponent"])("el-select"),c=Object(a["resolveComponent"])("el-form-item"),d=Object(a["resolveComponent"])("el-input-number"),h=Object(a["resolveComponent"])("Search"),m=Object(a["resolveComponent"])("el-icon"),u=Object(a["resolveComponent"])("el-input"),p=Object(a["resolveComponent"])("Setting"),b=Object(a["resolveComponent"])("el-divider"),g=Object(a["resolveComponent"])("DataBoard"),O=Object(a["resolveComponent"])("el-button"),f=Object(a["resolveComponent"])("Document"),j=Object(a["resolveComponent"])("TrendCharts"),y=Object(a["resolveComponent"])("el-button-group"),C=Object(a["resolveComponent"])("Position3DChart"),x=Object(a["resolveComponent"])("el-dialog"),w=Object(a["resolveComponent"])("Check"),V=Object(a["resolveComponent"])("RefreshLeft"),N=Object(a["resolveComponent"])("el-alert"),v=Object(a["resolveComponent"])("Plus"),D=Object(a["resolveComponent"])("Delete"),k=Object(a["resolveComponent"])("el-checkbox"),F=Object(a["resolveComponent"])("el-checkbox-group"),E=Object(a["resolveComponent"])("ArrowDown"),R=Object(a["resolveComponent"])("Filter"),T=Object(a["resolveComponent"])("Download"),I=Object(a["resolveComponent"])("el-form");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",L,[Object(a["createVNode"])(I,{model:i.searchForm,inline:!0,class:"search-form"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(c,{label:"年份"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{modelValue:i.searchForm.year,"onUpdate:modelValue":t[0]||(t[0]=e=>i.searchForm.year=e),placeholder:"请选择年份",style:{width:"120px"},clearable:""},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.yearOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(n,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(c,{label:"月份"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{modelValue:i.searchForm.month,"onUpdate:modelValue":t[1]||(t[1]=e=>i.searchForm.month=e),placeholder:"请选择月份",style:{width:"120px"},clearable:""},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(12,e=>Object(a["createVNode"])(n,{key:e,label:e+"月",value:e},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(c,{label:"周序号"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(d,{modelValue:i.searchForm.week,"onUpdate:modelValue":t[2]||(t[2]=e=>i.searchForm.week=e),placeholder:"请输入周序号",style:{width:"120px"},min:1,max:5,clearable:""},null,8,["modelValue"])]),_:1}),Object(a["createVNode"])(c,{label:"卷烟名称"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.searchForm.cigaretteName,"onUpdate:modelValue":t[3]||(t[3]=e=>i.searchForm.cigaretteName=e),placeholder:l.cigaretteNamePlaceholder,style:{width:"200px"},clearable:"",disabled:!l.isDateComplete,onInput:l.handleCigaretteNameInput,onChange:l.handleCigaretteNameChange},{prefix:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(h)]),_:1})]),_:1},8,["modelValue","placeholder","disabled","onInput","onChange"])]),_:1}),Object(a["createVNode"])(c,{label:"投放类型"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{modelValue:i.searchForm.distributionType,"onUpdate:modelValue":t[4]||(t[4]=e=>i.searchForm.distributionType=e),placeholder:"请选择投放类型",style:{width:"180px"},clearable:"",disabled:l.isFormDisabled,onChange:l.handleDistributionTypeChange},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(n,{label:"按档位统一投放",value:"按档位统一投放"}),Object(a["createVNode"])(n,{label:"按档位扩展投放",value:"按档位扩展投放"})]),_:1},8,["modelValue","disabled","onChange"])]),_:1}),"按档位扩展投放"===i.searchForm.distributionType?(Object(a["openBlock"])(),Object(a["createBlock"])(c,{key:0,label:"扩展投放类型"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{modelValue:i.searchForm.extendedType,"onUpdate:modelValue":t[5]||(t[5]=e=>i.searchForm.extendedType=e),placeholder:"请选择扩展类型",style:{width:"160px"},clearable:"",disabled:l.isFormDisabled,onChange:l.handleExtendedTypeChange},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(n,{label:"档位+区县",value:"档位+区县"}),Object(a["createVNode"])(n,{label:"档位+市场类型",value:"档位+市场类型"}),Object(a["createVNode"])(n,{label:"档位+城乡分类代码",value:"档位+城乡分类代码"}),Object(a["createVNode"])(n,{label:"档位+业态",value:"档位+业态"})]),_:1},8,["modelValue","disabled","onChange"])]),_:1})):Object(a["createCommentVNode"])("",!0),Object(a["createVNode"])(c,{label:"投放区域"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{modelValue:i.searchForm.distributionArea,"onUpdate:modelValue":t[6]||(t[6]=e=>i.searchForm.distributionArea=e),placeholder:l.areaPlaceholder,style:{width:"300px"},multiple:"","collapse-tags":"","collapse-tags-tooltip":"",clearable:"",disabled:l.isFormDisabled,onChange:l.handleDistributionAreaChange},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.deliveryAreaOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(n,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","placeholder","disabled","onChange"])]),_:1}),o.selectedRecord&&o.selectedRecord.cigCode?(Object(a["openBlock"])(),Object(a["createBlock"])(c,{key:1,label:"预投放量"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{value:l.formatQuantity(o.selectedRecord.advAmount),style:{width:"150px"},readonly:"","suffix-icon":"el-icon-info"},null,8,["value"])]),_:1})):Object(a["createCommentVNode"])("",!0),o.selectedRecord&&o.selectedRecord.cigCode?(Object(a["openBlock"])(),Object(a["createBlock"])(c,{key:2,label:"实际投放量"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{value:l.formatQuantity(o.selectedRecord.actualDelivery),style:{width:"150px"},readonly:"","suffix-icon":"el-icon-info"},null,8,["value"])]),_:1})):Object(a["createCommentVNode"])("",!0),o.selectedRecord&&o.selectedRecord.cigCode?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",z,[Object(a["createElementVNode"])("div",U,[Object(a["createVNode"])(b,{"content-position":"left"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(p)]),_:1}),t[14]||(t[14]=Object(a["createTextVNode"])(" 档位设置 ",-1))]),_:1}),Object(a["createElementVNode"])("div",W,[Object(a["createVNode"])(y,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(O,{type:"grid"===i.positionViewMode?"primary":"",size:"small",onClick:t[7]||(t[7]=e=>l.switchPositionView("grid"))},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(g)]),_:1}),t[15]||(t[15]=Object(a["createTextVNode"])(" 表格视图 ",-1))]),_:1},8,["type"]),Object(a["createVNode"])(O,{type:"encoding"===i.positionViewMode?"primary":"",size:"small",onClick:t[8]||(t[8]=e=>l.switchPositionView("encoding"))},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(f)]),_:1}),t[16]||(t[16]=Object(a["createTextVNode"])(" 编码视图 ",-1))]),_:1},8,["type"]),Object(a["createVNode"])(O,{size:"small",onClick:t[9]||(t[9]=e=>l.switchPositionView("3d")),disabled:!l.hasChartData},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(j)]),_:1}),t[17]||(t[17]=Object(a["createTextVNode"])(" 三维图表 ",-1))]),_:1},8,["disabled"])]),_:1})])]),"grid"===i.positionViewMode?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",G,[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(i.positionData,(e,t)=>(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",{key:"d"+(30-t),class:"position-item"},[Object(a["createElementVNode"])("span",H,"D"+Object(a["toDisplayString"])(30-t)+":",1),Object(a["createVNode"])(d,{modelValue:i.positionData[t],"onUpdate:modelValue":e=>i.positionData[t]=e,min:0,precision:0,step:1,size:"small",style:{width:"90px"},disabled:l.isFormDisabled,onChange:l.handlePositionChange},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"])]))),128))])):Object(a["createCommentVNode"])("",!0),Object(a["createVNode"])(x,{modelValue:i.show3DChart,"onUpdate:modelValue":t[11]||(t[11]=e=>i.show3DChart=e),title:(o.selectedRecord&&o.selectedRecord.cigName||"卷烟")+" - 各区域档位投放分布",width:"95%",height:"85vh","destroy-on-close":!0,"close-on-click-modal":!1,"close-on-press-escape":!0,"show-close":!0,draggable:"",class:"chart-dialog",onOpened:l.handleDialogOpened},{footer:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("div",Y,[Object(a["createVNode"])(O,{onClick:t[10]||(t[10]=e=>i.show3DChart=!1)},{default:Object(a["withCtx"])(()=>[...t[18]||(t[18]=[Object(a["createTextVNode"])("关闭",-1)])]),_:1}),Object(a["createVNode"])(O,{type:"primary",onClick:l.exportChart,disabled:!l.hasChartData},{default:Object(a["withCtx"])(()=>[...t[19]||(t[19]=[Object(a["createTextVNode"])(" 导出图表 ",-1)])]),_:1},8,["onClick","disabled"])])]),default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(C,{ref:"position3DChart",selectedRecord:o.selectedRecord,tableData:o.tableData,style:{height:"1125px"}},null,8,["selectedRecord","tableData"])]),_:1},8,["modelValue","title","onOpened"]),"encoding"===i.positionViewMode?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",Q,[Object(a["createVNode"])(b,{"content-position":"left"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(f)]),_:1}),t[20]||(t[20]=Object(a["createTextVNode"])(" 编码化表达 ",-1))]),_:1}),Object(a["createElementVNode"])("div",J,[Object(a["createVNode"])(c,{label:"编码表达",class:"encoded-expression-form-item"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.encodedExpressionInput,"onUpdate:modelValue":t[12]||(t[12]=e=>i.encodedExpressionInput=e),type:"textarea",rows:6,placeholder:"显示选中卷烟的所有区域聚合编码表达，每行一个不同的档位设置组合",style:{width:"600px"},readonly:!o.selectedRecord||!o.selectedRecord.cigCode||l.isEncodingDisabled,disabled:l.isEncodingDisabled,onInput:l.handleEncodedExpressionInput,onChange:l.handleEncodedExpressionChange,resize:"vertical"},null,8,["modelValue","readonly","disabled","onInput","onChange"]),Object(a["createVNode"])(O,{type:"primary",size:"small",onClick:l.handleUpdateFromEncodedExpression,loading:i.updatingFromEncoded,disabled:!l.isEncodedExpressionChanged||!o.selectedRecord||!l.encodedExpressionValidation.isValid,style:{"margin-left":"10px"}},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(w)]),_:1}),t[21]||(t[21]=Object(a["createTextVNode"])(" 更新记录 ",-1))]),_:1},8,["onClick","loading","disabled"]),l.hasAnyChanges?(Object(a["openBlock"])(),Object(a["createBlock"])(O,{key:0,size:"small",onClick:l.resetEditMode,style:{"margin-left":"10px"}},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(V)]),_:1}),t[22]||(t[22]=Object(a["createTextVNode"])(" 重置修改 ",-1))]),_:1},8,["onClick"])):Object(a["createCommentVNode"])("",!0)]),_:1}),l.decodedExpressionDisplay?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",K,[Object(a["createVNode"])(N,{title:"解码表达式",type:"info",closable:!1,"show-icon":"",description:l.decodedExpressionDisplay},null,8,["description"])])):Object(a["createCommentVNode"])("",!0),Object(a["createElementVNode"])("div",X,[Object(a["createVNode"])(N,{title:l.encodedExpressionValidation.title,type:l.encodedExpressionValidation.type,description:l.encodedExpressionValidation.message,closable:!1,"show-icon":""},null,8,["title","type","description"])]),l.encodedExpressionHint?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",Z,[Object(a["createVNode"])(N,{title:l.encodedExpressionHint,type:"info",closable:!1,"show-icon":""},null,8,["title"])])):Object(a["createCommentVNode"])("",!0),"none"!==i.editMode?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",ee,["encoding"===i.editMode?(Object(a["openBlock"])(),Object(a["createBlock"])(N,{key:0,title:"编码修改模式",type:"info",closable:!1,"show-icon":""},{default:Object(a["withCtx"])(()=>[...t[23]||(t[23]=[Object(a["createElementVNode"])("p",null,"当前正在修改编码表达式，其他表单字段已被锁定",-1),Object(a["createElementVNode"])("p",null,'要修改其他字段，请先点击"重置修改"按钮',-1)])]),_:1})):Object(a["createCommentVNode"])("",!0),"form"===i.editMode?(Object(a["openBlock"])(),Object(a["createBlock"])(N,{key:1,title:"表单修改模式",type:"warning",closable:!1,"show-icon":""},{default:Object(a["withCtx"])(()=>[...t[24]||(t[24]=[Object(a["createElementVNode"])("p",null,"当前正在修改表单设置，编码表达式字段已被锁定",-1),Object(a["createElementVNode"])("p",null,'要修改编码表达式，请先点击"重置修改"按钮',-1)])]),_:1})):Object(a["createCommentVNode"])("",!0)])):Object(a["createCommentVNode"])("",!0)])])):Object(a["createCommentVNode"])("",!0),Object(a["createElementVNode"])("div",te,[Object(a["createVNode"])(O,{type:"primary",size:"small",onClick:l.handleSavePositions,loading:i.savingPositions,disabled:!l.isPositionDataValid},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(w)]),_:1}),t[25]||(t[25]=Object(a["createTextVNode"])(" 保存档位设置 ",-1))]),_:1},8,["onClick","loading","disabled"]),Object(a["createVNode"])(O,{type:"info",size:"small",onClick:l.handleResetPositions},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(V)]),_:1}),t[26]||(t[26]=Object(a["createTextVNode"])(" 重置档位 ",-1))]),_:1},8,["onClick"]),"grid"===i.positionViewMode?(Object(a["openBlock"])(),Object(a["createBlock"])(O,{key:0,type:"success",size:"small",onClick:l.handleAddNewArea,disabled:!l.canAddNewArea},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(v)]),_:1}),t[27]||(t[27]=Object(a["createTextVNode"])(" 新增投放区域 ",-1))]),_:1},8,["onClick","disabled"])):Object(a["createCommentVNode"])("",!0),"grid"===i.positionViewMode?(Object(a["openBlock"])(),Object(a["createBlock"])(O,{key:1,type:"danger",size:"small",onClick:l.handleDeleteAreas,disabled:!l.canDeleteAreas},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(D)]),_:1}),t[28]||(t[28]=Object(a["createTextVNode"])(" 删除投放区域 ",-1))]),_:1},8,["onClick","disabled"])):Object(a["createCommentVNode"])("",!0)]),"grid"===i.positionViewMode&&o.selectedRecord&&o.selectedRecord.allAreas&&o.selectedRecord.allAreas.length>0?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",oe,[Object(a["createVNode"])(b,{"content-position":"left"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(D)]),_:1}),t[29]||(t[29]=Object(a["createTextVNode"])(" 选择要删除的投放区域 ",-1))]),_:1}),Object(a["createVNode"])(F,{modelValue:i.areasToDelete,"onUpdate:modelValue":t[13]||(t[13]=e=>i.areasToDelete=e),class:"delete-area-checkboxes"},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(o.selectedRecord.allAreas,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(k,{key:e,value:e,disabled:o.selectedRecord.allAreas.length<=1},{default:Object(a["withCtx"])(()=>[Object(a["createTextVNode"])(Object(a["toDisplayString"])(e),1)]),_:2},1032,["value","disabled"]))),128))]),_:1},8,["modelValue"]),Object(a["createElementVNode"])("div",ae,[o.selectedRecord.allAreas.length<=1?(Object(a["openBlock"])(),Object(a["createBlock"])(N,{key:0,title:"无法删除：该卷烟至少需要保留一个投放区域",type:"warning",closable:!1,"show-icon":""})):0===i.areasToDelete.length?(Object(a["openBlock"])(),Object(a["createBlock"])(N,{key:1,title:"请选择要删除的投放区域",type:"info",closable:!1,"show-icon":""})):(Object(a["openBlock"])(),Object(a["createBlock"])(N,{key:2,title:`已选择 ${i.areasToDelete.length} 个区域进行删除`,type:"success",closable:!1,"show-icon":""},null,8,["title"]))])])):Object(a["createCommentVNode"])("",!0)])):Object(a["createCommentVNode"])("",!0),Object(a["createVNode"])(c,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(O,{type:"primary",onClick:l.handleSearch,disabled:!i.searchForm.year||!i.searchForm.month||!i.searchForm.week},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(h)]),_:1}),t[30]||(t[30]=Object(a["createTextVNode"])(" 查询 ",-1))]),_:1},8,["onClick","disabled"]),Object(a["createVNode"])(O,{type:"info",onClick:l.handleSearchNext,disabled:!i.searchForm.cigaretteName},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(E)]),_:1}),t[31]||(t[31]=Object(a["createTextVNode"])(" 下一个 ",-1))]),_:1},8,["onClick","disabled"]),Object(a["createVNode"])(O,{type:"warning",onClick:l.handleFilterLargeDeviation,disabled:!o.tableData||0===o.tableData.length,loading:i.filteringDeviation},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(R)]),_:1}),t[32]||(t[32]=Object(a["createTextVNode"])(" 筛选误差>200 ",-1)),i.largeDeviationRecords.length>0?(Object(a["openBlock"])(),Object(a["createElementBlock"])("span",re," ("+Object(a["toDisplayString"])(i.currentDeviationIndex+1)+"/"+Object(a["toDisplayString"])(i.largeDeviationRecords.length)+") ",1)):Object(a["createCommentVNode"])("",!0)]),_:1},8,["onClick","disabled","loading"]),Object(a["createVNode"])(O,{onClick:l.handleReset},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(V)]),_:1}),t[33]||(t[33]=Object(a["createTextVNode"])(" 重置 ",-1))]),_:1},8,["onClick"]),Object(a["createVNode"])(O,{type:"success",onClick:l.handleExport},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(T)]),_:1}),t[34]||(t[34]=Object(a["createTextVNode"])(" 导出 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["model"])])}var le=o("c9a1");const ne={class:"position-3d-chart-container"},se={key:0,class:"no-data-message"},ce={key:1,class:"chart-wrapper"},de={ref:"chartContainer",class:"chart-container"},he={key:0,class:"chart-legend"},me={class:"legend-items"},ue={class:"legend-text"},pe={class:"legend-type"};function be(e,t,o,r,i,l){const n=Object(a["resolveComponent"])("el-empty");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",ne,[l.hasData?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",ce,[Object(a["createElementVNode"])("div",de,null,512),i.uniqueAmounts.length>1?(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",he,[t[0]||(t[0]=Object(a["createElementVNode"])("div",{class:"legend-title"},"投放量颜色映射",-1)),Object(a["createElementVNode"])("div",me,[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(i.uniqueAmounts,(e,t)=>(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",{key:e,class:"legend-item"},[Object(a["createElementVNode"])("span",{class:"legend-color-box",style:Object(a["normalizeStyle"])({backgroundColor:i.colorMap.get(e)})},null,4),Object(a["createElementVNode"])("span",ue,Object(a["toDisplayString"])(e),1),Object(a["createElementVNode"])("span",pe,Object(a["toDisplayString"])(t%2===0?"(暖)":"(冷)"),1)]))),128))])])):Object(a["createCommentVNode"])("",!0)])):(Object(a["openBlock"])(),Object(a["createElementBlock"])("div",se,[Object(a["createVNode"])(n,{description:"暂无数据可显示"})]))])}var ge=o("313e"),Oe=(o("e39c"),{name:"Position3DChart",props:{selectedRecord:{type:Object,default:()=>null},tableData:{type:Array,default:()=>[]}},data(){return{chart:null,chartData:[],uniqueAmounts:[],colorMap:new Map}},computed:{hasData(){return this.chartData&&this.chartData.length>0},cigaretteData(){return this.selectedRecord&&this.selectedRecord.cigCode?this.tableData.filter(e=>e.cigCode===this.selectedRecord.cigCode&&e.year===this.selectedRecord.year&&e.month===this.selectedRecord.month&&e.weekSeq===this.selectedRecord.weekSeq):[]}},watch:{selectedRecord:{handler(){this.updateChartData()},immediate:!0},tableData:{handler(){this.updateChartData()},deep:!0}},mounted(){this.$nextTick(()=>{setTimeout(()=>{this.initChart()},100)})},beforeUnmount(){this.chart&&this.chart.dispose()},methods:{initChart(){if(!this.$refs.chartContainer)return void console.warn("Chart container not found");const e=this.$refs.chartContainer;if(0===e.clientWidth||0===e.clientHeight)return console.warn("Chart container has no width or height, retrying..."),void setTimeout(()=>{this.initChart()},200);console.log("Initializing chart with container size:",{width:e.clientWidth,height:e.clientHeight});try{this.chart=ge["a"](this.$refs.chartContainer),this.updateChartData(),window.addEventListener("resize",this.handleResize)}catch(t){console.error("Error initializing chart:",t)}},reinitChart(){console.log("Reinitializing chart..."),this.chart&&(this.chart.dispose(),this.chart=null),this.$nextTick(()=>{setTimeout(()=>{this.initChart()},50)})},handleResize(){this.chart&&this.chart.resize()},updateChartData(){this.processData(),this.renderChart()},processData(){const e=[],t=new Set,o=new Set;this.cigaretteData.forEach(a=>{const r=a.deliveryArea||"未知区域";t.add(r);for(let t=1;t<=30;t++){const i="d"+t,l=a[i]||0;l>0&&(e.push([r,"D"+t,l]),o.add(l))}}),this.chartData=e,this.areaList=Array.from(t),this.uniqueAmounts=Array.from(o).sort((e,t)=>t-e),this.generateColorMap(),console.log("处理后的三维图表数据:",{data:this.chartData,areas:this.areaList,uniqueAmounts:this.uniqueAmounts,colorMap:Object.fromEntries(this.colorMap),selectedRecord:this.selectedRecord})},generateColorMap(){if(this.colorMap.clear(),0===this.uniqueAmounts.length)return;const e=["#8B0000","#B22222","#DC143C","#FF0000","#FF4500","#FF6347","#FF7F50","#FFA500","#FFB347","#FFD700"],t=["#000080","#0000CD","#0000FF","#1E90FF","#4169E1","#6495ED","#87CEEB","#87CEFA","#ADD8E6","#E0F6FF"];1!==this.uniqueAmounts.length?(this.uniqueAmounts.forEach((o,a)=>{let r;const i=Math.floor(a/2%10);r=a%2===0?e[i]||e[e.length-1]:t[i]||t[t.length-1],this.colorMap.set(o,r)}),console.log("生成的颜色映射:",Object.fromEntries(this.colorMap))):this.colorMap.set(this.uniqueAmounts[0],"#8B0000")},renderChart(){if(!this.chart||!this.hasData)return void console.warn("Chart not initialized or no data available");const e=[];for(let o=1;o<=30;o++)e.push("D"+o);const t={title:{text:(this.selectedRecord&&this.selectedRecord.cigName||"卷烟")+" - 各区域档位投放分布",left:"center",top:10,textStyle:{fontSize:16,fontWeight:"bold",color:"#333"}},tooltip:{trigger:"item",formatter:(e=>function(t){const[o,a,r]=t.data,i=e.get(r)||"#8B0000";return`区域: ${o}<br/>档位: ${a}<br/>投放量: ${r}<br/><span style="color: ${i};">■</span> 颜色: ${i}`})(this.colorMap)},legend:{show:!1},xAxis3D:{type:"category",name:"投放区域",data:this.areaList,nameTextStyle:{fontSize:12,color:"#666"},axisLabel:{fontSize:10,color:"#666",interval:0,rotate:45}},yAxis3D:{type:"category",name:"档位",data:e,nameTextStyle:{fontSize:12,color:"#666"},axisLabel:{fontSize:10,color:"#666"}},zAxis3D:{type:"value",name:"投放量",nameTextStyle:{fontSize:12,color:"#666"},axisLabel:{fontSize:10,color:"#666"}},grid3D:{boxWidth:120,boxDepth:120,boxHeight:60,alpha:25,beta:40,viewControl:{projection:"orthographic",autoRotate:!1,rotateSensitivity:1,zoomSensitivity:1,panSensitivity:1,alpha:25,beta:40,distance:250},light:{main:{intensity:1.5,alpha:30,beta:40},ambient:{intensity:.3}},environment:"#f8f9fa"},series:[{type:"bar3D",data:this.chartData,shading:"lambert",barGap:.4,barCategoryGap:.5,emphasis:{label:{show:!0,fontSize:12,fontWeight:"bold"},itemStyle:{color:"#FFD700"}},itemStyle:{color:(e=>t=>{const o=t.data[2];return e.get(o)||"#8B0000"})(this.colorMap),opacity:.8,borderWidth:1,borderColor:"rgba(255,255,255,0.3)"},label:{show:!1,fontSize:10}}]};this.chart.setOption(t,!0)}}});o("7f18");const fe=s()(Oe,[["render",be],["__scopeId","data-v-209232d4"]]);var je=fe,ye={name:"SearchForm",props:{selectedRecord:{type:Object,default:null},tableData:{type:Array,default:()=>[]}},components:{Search:j["Search"],RefreshLeft:j["RefreshLeft"],Download:j["Download"],ArrowDown:j["ArrowDown"],LocationInformation:j["LocationInformation"],Setting:j["Setting"],Check:j["Check"],Plus:j["Plus"],Delete:j["Delete"],Document:j["Document"],DataBoard:j["DataBoard"],TrendCharts:j["TrendCharts"],Filter:j["Filter"],Position3DChart:je},data(){return{searchForm:{year:null,month:null,week:null,cigaretteName:"",distributionType:"",extendedType:"",distributionArea:[]},areaOptions:{"按档位统一投放":[{label:"全市",value:"全市"}],"档位+区县":[{label:"丹江",value:"丹江"},{label:"房县",value:"房县"},{label:"郧西",value:"郧西"},{label:"郧阳",value:"郧阳"},{label:"竹山",value:"竹山"},{label:"竹溪",value:"竹溪"},{label:"城区",value:"城区"}],"档位+城乡分类代码":[{label:"主城区",value:"主城区"},{label:"城乡结合区",value:"城乡结合区"},{label:"镇中心区",value:"镇中心区"},{label:"镇乡结合区",value:"镇乡结合区"},{label:"特殊区域",value:"特殊区域"},{label:"乡中心区",value:"乡中心区"},{label:"村庄",value:"村庄"}],"档位+市场类型":[{label:"城网",value:"城网"},{label:"农网",value:"农网"}],"档位+业态":[{label:"便利店",value:"便利店"},{label:"超市",value:"超市"},{label:"商场",value:"商场"},{label:"烟草专卖店",value:"烟草专卖店"},{label:"娱乐服务类",value:"娱乐服务类"},{label:"其他",value:"其他"}]},positionData:new Array(30).fill(0),savingPositions:!1,areasToDelete:[],encodedExpressionInput:"",originalEncodedExpression:"",updatingFromEncoded:!1,originalFormState:null,isConsistencyCheckEnabled:!0,editMode:"none",positionViewMode:"grid",show3DChart:!1,largeDeviationRecords:[],currentDeviationIndex:-1,filteringDeviation:!1}},computed:{yearOptions(){const e=(new Date).getFullYear(),t=[];for(let o=e-2;o<=e+10;o++)t.push(o);return t},isDateComplete(){return this.searchForm.year&&this.searchForm.month&&this.searchForm.week},cigaretteNamePlaceholder(){return this.isDateComplete?"请输入卷烟名称":"请先填充年份、月份和周序号"},deliveryAreaOptions(){return"按档位统一投放"===this.searchForm.distributionType?this.areaOptions["按档位统一投放"]||[]:"按档位扩展投放"===this.searchForm.distributionType&&this.searchForm.extendedType&&this.areaOptions[this.searchForm.extendedType]||[]},areaPlaceholder(){return"按档位统一投放"===this.searchForm.distributionType?"请选择投放区域（统一投放）":"按档位扩展投放"!==this.searchForm.distributionType||this.searchForm.extendedType?this.deliveryAreaOptions.length>0?"请选择投放区域":"请先选择投放类型":"请先选择扩展投放类型"},isPositionDataValid(){return!(!this.positionData||30!==this.positionData.length)&&this.positionData.some(e=>e>0)},canAddNewArea(){return this.selectedRecord&&this.selectedRecord.cigCode&&this.searchForm.distributionArea&&this.searchForm.distributionArea.length>0&&this.isPositionDataValid},canDeleteAreas(){return this.selectedRecord&&this.selectedRecord.cigCode&&this.selectedRecord.allAreas&&this.selectedRecord.allAreas.length>1&&this.areasToDelete&&this.areasToDelete.length>0},isEncodedExpressionChanged(){return this.encodedExpressionInput.trim()!==this.originalEncodedExpression.trim()},decodedExpressionDisplay(){if(!this.selectedRecord)return"";const e=this.getRelatedRecords(this.selectedRecord);if(0===e.length)return"";const t=[];return e.forEach((e,o)=>{let a="";a=e.decodedExpression?e.decodedExpression:this.generateRecordDecodedExpression(e),t.push(`${o+1}. ${a}`)}),t.join("\n")},generateRecordDecodedExpression(e){try{let t="";t+=e.deliveryMethod||"未知投放方式",e.deliveryEtype&&"NULL"!==e.deliveryEtype&&(t+="、"+e.deliveryEtype),e.deliveryArea&&(t+="、"+e.deliveryArea);const o=this.getPositionSummary(e);return o&&(t+="、"+o),t}catch(t){return console.warn("生成解码表达式失败:",t),"解码失败"}},getPositionSummary(e){const t=[];for(let o=30;o>=1;o--){const a=e["d"+o]||0;a>0&&t.push(`D${o}=${a}`)}return 0===t.length?"无档位设置":t.length>3?`档位设置：${t.slice(0,3).join("、")}等${t.length}个档位`:"档位设置："+t.join("、")},encodedExpressionValidation(){if(!this.encodedExpressionInput||!this.encodedExpressionInput.trim())return{isValid:!0,type:"info",title:"请输入编码表达式",message:"支持多行输入，每行一个编码表达式"};const e=this.validateEncodedExpressions(this.encodedExpressionInput);return e.isValid?{isValid:!0,type:"success",title:"编码表达式验证通过",message:e.warnings.join(", ")}:{isValid:!1,type:"error",title:"编码表达式验证失败",message:e.errors.join("; ")}},encodedExpressionHint(){if(!this.encodedExpressionInput)return"请选中卷烟记录以显示编码表达";if(this.isEncodedExpressionChanged)return this.hasOtherFormChanges?"编码表达和其他设置均已修改，需要通过一致性验证":'编码表达已修改，点击"更新记录"按钮保存更改';const e=this.encodedExpressionInput.split("\n").filter(e=>e.trim()),t=e.length;return t>1?`当前显示 ${t} 条不同档位设置的区域聚合编码表达式`:"编码格式：投放类型+扩展类型（区域编码）（档位投放量编码）"},hasOtherFormChanges(){return this.hasPositionChanges||this.hasDeliverySettingsChanges},hasPositionChanges(){return!(!this.originalFormState||!this.selectedRecord)&&this.positionData.some((e,t)=>e!==(this.originalFormState.positionData[t]||0))},hasDeliverySettingsChanges(){if(!this.originalFormState||!this.selectedRecord)return!1;const e=this.searchForm.distributionType!==this.originalFormState.distributionType,t=this.searchForm.extendedType!==this.originalFormState.extendedType,o=(this.searchForm.distributionArea||[]).sort(),a=(this.originalFormState.distributionArea||[]).sort(),r=JSON.stringify(o)!==JSON.stringify(a);return e||t||r},needsConsistencyCheck(){return this.isEncodedExpressionChanged&&this.hasOtherFormChanges&&this.isConsistencyCheckEnabled},changesSummary(){const e=[];if(this.isEncodedExpressionChanged&&e.push("编码表达"),this.hasPositionChanges&&e.push("档位设置"),this.hasDeliverySettingsChanges){const t=[];this.originalFormState&&this.searchForm.distributionType!==this.originalFormState.distributionType&&t.push("投放类型"),this.originalFormState&&this.searchForm.extendedType!==this.originalFormState.extendedType&&t.push("扩展投放类型"),this.originalFormState&&JSON.stringify((this.searchForm.distributionArea||[]).sort())!==JSON.stringify((this.originalFormState.distributionArea||[]).sort())&&t.push("投放区域"),e.push(...t)}return e},isEncodingDisabled(){return"form"===this.editMode},isFormDisabled(){return"encoding"===this.editMode},hasAnyChanges(){return"none"!==this.editMode},hasChartData(){return this.selectedRecord&&this.selectedRecord.cigCode&&this.tableData.length>0}},watch:{selectedRecord:{handler(e){e?(this.searchForm.year=e.year,this.searchForm.month=e.month,this.searchForm.week=e.weekSeq||e.week,this.searchForm.cigaretteName=e.cigName||e.cigaretteName,e.deliveryMethod&&(this.searchForm.distributionType=e.deliveryMethod),e.deliveryEtype&&(this.searchForm.extendedType=e.deliveryEtype),e.allAreas&&Array.isArray(e.allAreas)?this.searchForm.distributionArea=[...e.allAreas]:e.deliveryArea&&(this.searchForm.distributionArea=[e.deliveryArea]),this.loadPositionData(e),this.loadEncodedExpression(e),this.saveOriginalFormState(),this.editMode="none",console.log("选中记录更新并自动填充:",{record:e,form:this.searchForm})):(this.positionData=new Array(30).fill(0),this.areasToDelete=[],this.encodedExpressionInput="",this.originalEncodedExpression="",this.originalFormState=null,this.editMode="none")},immediate:!0}},methods:{handleDistributionTypeChange(e){this.selectedRecord?this.setEditMode("form"):(this.searchForm.extendedType="",this.searchForm.distributionArea=[])},handleExtendedTypeChange(){this.selectedRecord?this.setEditMode("form"):this.searchForm.distributionArea=[]},handleDistributionAreaChange(){this.selectedRecord&&this.selectedRecord.cigCode&&this.setEditMode("form")},handlePositionChange(){this.selectedRecord&&this.selectedRecord.cigCode&&this.setEditMode("form")},setEditMode(e){"none"===this.editMode&&(this.editMode=e,console.log(`切换到${"encoding"===e?"编码修改":"表单修改"}模式`))},resetEditMode(){this.editMode="none",this.loadEncodedExpression(this.selectedRecord),this.selectedRecord&&(this.selectedRecord.deliveryMethod&&(this.searchForm.distributionType=this.selectedRecord.deliveryMethod),this.selectedRecord.deliveryEtype&&(this.searchForm.extendedType=this.selectedRecord.deliveryEtype),this.selectedRecord.allAreas&&Array.isArray(this.selectedRecord.allAreas)?this.searchForm.distributionArea=[...this.selectedRecord.allAreas]:this.selectedRecord.deliveryArea&&(this.searchForm.distributionArea=[this.selectedRecord.deliveryArea]),this.loadPositionData(this.selectedRecord),this.saveOriginalFormState()),y["a"].success("已重置修改状态"),console.log("重置编辑模式")},switchPositionView(e){"3d"===e?this.open3DChart():(this.positionViewMode=e,console.log("切换档位显示模式: "+e))},open3DChart(){this.hasChartData?(this.show3DChart=!0,console.log("打开三维图表弹窗")):y["a"].warning("请先选择一个卷烟记录")},handleDialogOpened(){console.log("Dialog opened, reinitializing chart..."),this.$refs.position3DChart&&this.$refs.position3DChart.reinitChart()},exportChart(){y["a"].info("图表导出功能正在开发中...")},handleSearch(){if(!this.searchForm.year||!this.searchForm.month||!this.searchForm.week)return void y["a"].warning("请至少选择一个时间条件");if(this.searchForm.distributionType){if("按档位扩展投放"===this.searchForm.distributionType&&!this.searchForm.extendedType)return void y["a"].warning("请选择扩展投放类型");if(!this.searchForm.distributionArea)return void y["a"].warning("请选择投放区域")}console.log("搜索条件:",this.searchForm);let e="查询条件：";this.searchForm.year&&(e+=this.searchForm.year+"年 "),this.searchForm.month&&(e+=this.searchForm.month+"月 "),this.searchForm.week&&(e+=`第${this.searchForm.week}周 `),this.searchForm.cigaretteName&&(e+="卷烟："+this.searchForm.cigaretteName),y["a"].success(e),this.$emit("search",this.searchForm)},handleSearchNext(){this.searchForm.cigaretteName.trim()?this.$emit("search-next"):y["a"].warning("请先输入卷烟名称")},async handleFilterLargeDeviation(){if(this.tableData&&0!==this.tableData.length){this.filteringDeviation=!0;try{console.log("刷新表格数据以获取最新的投放量信息..."),this.$emit("refresh-before-filter"),await new Promise(e=>setTimeout(e,500));const e=this.tableData.filter(e=>{const t=parseFloat(e.advAmount)||0,o=parseFloat(e.actualDelivery)||0,a=Math.abs(o-t);return a>200});if(console.log("筛选出的误差>200记录:",e),0===e.length)return y["a"].info("没有找到绝对误差大于200的卷烟"),this.largeDeviationRecords=[],void(this.currentDeviationIndex=-1);0===this.largeDeviationRecords.length||this.largeDeviationRecords.length!==e.length?(this.largeDeviationRecords=e,this.currentDeviationIndex=0):(this.currentDeviationIndex=(this.currentDeviationIndex+1)%e.length,this.largeDeviationRecords=e);const t=this.largeDeviationRecords[this.currentDeviationIndex],o=parseFloat(t.advAmount)||0,a=parseFloat(t.actualDelivery)||0,r=Math.abs(a-o);this.$emit("cigarette-name-matched",[t]),y["a"].success({message:`已选中第 ${this.currentDeviationIndex+1}/${this.largeDeviationRecords.length} 个误差记录\n卷烟：${t.cigName}\n预投放量：${o.toFixed(2)}\n实际投放量：${a.toFixed(2)}\n绝对误差：${r.toFixed(2)}`,duration:3e3,dangerouslyUseHTMLString:!1}),console.log("已选中误差记录:",{index:this.currentDeviationIndex+1,total:this.largeDeviationRecords.length,record:t,deviation:r})}catch(e){console.error("筛选误差记录失败:",e),y["a"].error("筛选失败，请重试")}finally{this.filteringDeviation=!1}}else y["a"].warning("暂无数据可筛选")},handleReset(){this.searchForm={year:null,month:null,week:null,cigaretteName:"",distributionType:"",extendedType:"",distributionArea:""},this.largeDeviationRecords=[],this.currentDeviationIndex=-1,y["a"].info("已重置搜索条件"),this.$emit("reset")},handleExport(){y["a"].success("正在导出数据..."),this.$emit("export",this.searchForm)},handleCigaretteNameInput(e){this.searchForm.cigaretteName=e.trim()},handleCigaretteNameChange(){if(this.searchForm.year&&this.searchForm.month&&this.searchForm.week){if(this.searchForm.cigaretteName&&this.tableData.length>0){const e=this.tableData.filter(e=>e.cigName&&e.cigName.includes(this.searchForm.cigaretteName)&&e.year===this.searchForm.year&&e.month===this.searchForm.month&&e.weekSeq===this.searchForm.week);e.length>0?(this.$emit("cigarette-name-matched",e),y["a"].success(`已自动选中匹配的卷烟：${e[0].cigName}，共找到 ${e.length} 个投放区域`)):y["a"].info("未找到匹配的卷烟记录")}}else y["a"].warning("请先填充年份、月份和周序号，然后再搜索卷烟名称")},formatQuantity(e){if(null===e||void 0===e||""===e)return"未设置";const t=parseFloat(e);return isNaN(t)?e:t.toFixed(2)},loadPositionData(e){if(!e)return void(this.positionData=new Array(30).fill(0));const t=[];for(let o=30;o>=1;o--){const a="d"+o,r=e[a]||0;t.push(Number(r))}this.positionData=30===t.length?t:new Array(30).fill(0),console.log("=== 档位数据加载调试 ==="),console.log("从后端接收的原始数据字段:",Object.keys(e).filter(e=>e.startsWith("d")).sort()),console.log("转换后的positionData数组:",this.positionData),console.log("界面将显示的顺序:",this.positionData.map((e,t)=>`D${30-t}=${e}`).join(", ")),console.log("数组第一个值 (对应D30):",this.positionData[0]),console.log("数组最后一个值 (对应D1):",this.positionData[29])},validatePositionConstraints(){console.log("档位数据已更新，不再检查约束条件")},async handleSavePositions(){if(this.selectedRecord&&this.selectedRecord.cigCode)if(this.isPositionDataValid){if(this.needsConsistencyCheck){const e=await this.performConsistencyCheck();if(!e.passed)return}try{this.savingPositions=!0;const e={cigCode:this.selectedRecord.cigCode,cigName:this.selectedRecord.cigName,year:this.selectedRecord.year,month:this.selectedRecord.month,weekSeq:this.selectedRecord.weekSeq,deliveryMethod:this.searchForm.distributionType,deliveryEtype:this.searchForm.extendedType,deliveryArea:this.searchForm.distributionArea.join(","),distribution:[...this.positionData],remark:this.selectedRecord.remark||"档位设置更新"};console.log("=== 档位设置数据传输调试 ==="),console.log("界面显示顺序:",this.positionData.map((e,t)=>`D${30-t}=${e}`).join(", ")),console.log("发送给后端的distribution数组:",e.distribution),console.log("数组长度:",e.distribution.length),console.log("数组第一个值 (应该是D30):",e.distribution[0]),console.log("数组最后一个值 (应该是D1):",e.distribution[29]),console.log("完整请求数据:",e);const t=await B.updateCigaretteInfo(e);if(!t.data.success)throw new Error(t.data.message||"保存失败");y["a"].success({message:`档位设置保存成功！更新了${t.data.updatedRecords||1}条记录`,duration:2e3}),this.$emit("position-updated",{cigCode:e.cigCode,updateData:e})}catch(e){console.error("保存档位设置失败:",e),y["a"].error("保存失败: "+e.message)}finally{this.savingPositions=!1}}else y["a"].error("请检查档位数据，至少设置一个档位值");else y["a"].error("请先选中一个卷烟记录")},handleResetPositions(){this.selectedRecord?(this.loadPositionData(this.selectedRecord),y["a"].info("已重置档位数据")):(this.positionData=new Array(30).fill(0),y["a"].info("已清空档位数据"))},async handleAddNewArea(){if(this.canAddNewArea)try{const e=this.selectedRecord.allAreas||[this.selectedRecord.deliveryArea],t=this.searchForm.distributionArea,o=t.filter(t=>!e.includes(t));if(0===o.length)return void y["a"].warning("没有选择新的投放区域");const a=await le["a"].confirm(`确定要为卷烟 "${this.selectedRecord.cigName}" 新增投放区域：${o.join(", ")} 吗？`,"确认新增投放区域",{confirmButtonText:"确定新增",cancelButtonText:"取消",type:"info"});if("confirm"===a){const e=o.map(e=>{const t={cigCode:this.selectedRecord.cigCode,cigName:this.selectedRecord.cigName,year:this.selectedRecord.year,month:this.selectedRecord.month,weekSeq:this.selectedRecord.weekSeq,deliveryMethod:this.searchForm.distributionType,deliveryEtype:this.searchForm.extendedType,deliveryArea:e,distribution:[...this.positionData],remark:"新增投放区域: "+e};return console.log(`=== 新增区域 ${e} 数据传输调试 ===`),console.log("界面显示顺序:",this.positionData.map((e,t)=>`D${30-t}=${e}`).join(", ")),console.log("发送给后端的distribution数组:",t.distribution),console.log("数组第一个值 (应该是D30):",t.distribution[0]),console.log("数组最后一个值 (应该是D1):",t.distribution[29]),B.updateCigaretteInfo(t)}),t=await Promise.all(e),a=t.filter(e=>e.data.success).length;a===o.length?(y["a"].success({message:`成功新增 ${a} 个投放区域记录`,duration:2e3}),this.$emit("area-added",{cigCode:this.selectedRecord.cigCode,newAreas:o,positionData:this.positionData})):y["a"].warning(`部分新增成功：${a}/${o.length}`)}}catch(e){if("cancel"===e)return;console.error("新增投放区域失败:",e),y["a"].error("新增失败: "+e.message)}else y["a"].warning("请确保已选中卷烟并设置了有效的档位数据")},async handleDeleteAreas(){if(this.canDeleteAreas)try{const e=[...this.areasToDelete],t=this.selectedRecord.allAreas.filter(t=>!e.includes(t));if(0===t.length)return void y["a"].error("不能删除所有投放区域，至少需要保留一个");const o=await le["a"].confirm(`确定要删除卷烟 "${this.selectedRecord.cigName}" 的以下投放区域吗？\n\n${e.join(", ")}\n\n删除后剩余区域：${t.join(", ")}`,"确认删除投放区域",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!1});if("confirm"===o){const o={cigCode:this.selectedRecord.cigCode,cigName:this.selectedRecord.cigName,year:this.selectedRecord.year,month:this.selectedRecord.month,weekSeq:this.selectedRecord.weekSeq,areasToDelete:e};console.log("删除投放区域请求数据:",o);const a=await B.deleteDeliveryAreas(o);if(!a.data.success)throw new Error(a.data.message||"删除失败");y["a"].success({message:`成功删除 ${e.length} 个投放区域记录`,duration:2e3}),this.areasToDelete=[],this.$emit("areas-deleted",{cigCode:this.selectedRecord.cigCode,deletedAreas:e,remainingAreas:t})}}catch(e){if("cancel"===e)return;console.error("删除投放区域失败:",e),y["a"].error("删除失败: "+e.message)}else y["a"].warning("请选择要删除的投放区域")},saveOriginalFormState(){this.originalFormState={distributionType:this.searchForm.distributionType,extendedType:this.searchForm.extendedType,distributionArea:[...this.searchForm.distributionArea||[]],positionData:[...this.positionData],encodedExpression:this.encodedExpressionInput},console.log("保存原始表单状态:",this.originalFormState)},loadEncodedExpression(e){if(!e)return this.encodedExpressionInput="",void(this.originalEncodedExpression="");const t=this.getRelatedRecords(e),o=this.generateAggregatedExpressions(t),a=o.join("\n");this.encodedExpressionInput=a,this.originalEncodedExpression=a,console.log("加载编码化表达:",{cigName:e.cigName,relatedRecordsCount:t.length,groupedExpressionsCount:o.length,multiLineExpressions:a})},getRelatedRecords(e){if(!this.tableData||!e)return[e].filter(Boolean);const t=this.tableData.filter(t=>t.cigCode===e.cigCode&&t.cigName===e.cigName&&t.year===e.year&&t.month===e.month&&t.weekSeq===e.weekSeq);return t.length>0?t:[e]},generateAggregatedExpressions(e){if(!e||0===e.length)return[];const t=[];return e.forEach(e=>{let o="";o=e.encodedExpression?e.encodedExpression:this.generateRecordEncodedExpression(e),t.push(o)}),t},generateRecordEncodedExpression(e){try{let t=this.getDeliveryTypeCode(e),o=this.getAreaCode(e.deliveryArea,e.deliveryEtype);const a=this.generatePositionCode(e);return"按档位统一投放"===e.deliveryMethod?`${t}（${a}）`:`${t}（${o}）（${a}）`}catch(t){return console.warn("生成编码表达式失败:",t),""}},getDeliveryTypeCode(e){if("按档位统一投放"===e.deliveryMethod)return"A";if("按档位扩展投放"===e.deliveryMethod){let t="B";return"档位+区县"===e.deliveryEtype?t+="1":"档位+市场类型"===e.deliveryEtype?t+="2":"档位+城乡分类代码"===e.deliveryEtype?t+="4":"档位+业态"===e.deliveryEtype&&(t+="5"),t}return"A"},getAreaCode(e,t){if(!e)return"";const o={"档位+区县":{"城区":"1","丹江":"2","房县":"3","郧西":"4","郧阳":"5","竹山":"6","竹溪":"7"},"档位+市场类型":{"城网":"C","农网":"N"},"档位+城乡分类代码":{"主城区":"①","城乡结合区":"②","镇中心区":"③","镇乡结合区":"④","特殊区域":"⑤","乡中心区":"⑥","村庄":"⑦"},"档位+业态":{"便利店":"a","超市":"b","商场":"c","烟草专卖店":"d","娱乐服务类":"e","其他":"f"}},a=o[t];return a&&a[e]?a[e]:e.charAt(0)},generatePositionCode(e){const t=[];let o=null,a=0;for(let r=30;r>=1;r--){const i=e["d"+r]||0;i===o?a++:(null!==o&&a>0&&t.push(`${a}×${o}`),o=i,a=1)}return null!==o&&a>0&&t.push(`${a}×${o}`),t.filter(e=>!e.endsWith("×0")).join("+")||"无档位设置"},groupRecordsByPositions(e){const t={};return e.forEach(e=>{const o=[];for(let t=30;t>=1;t--){const a=e["d"+t]||0;a>0&&o.push(`D${t}:${a}`)}const a=o.length>0?o.join(","):"无档位设置";t[a]||(t[a]=[]),t[a].push(e)}),t},handleEncodedExpressionInput(e){this.selectedRecord&&this.selectedRecord.cigCode&&this.setEditMode("encoding"),console.log("编码表达输入变化:",e)},handleEncodedExpressionChange(){this.isEncodedExpressionChanged&&y["a"].info('编码表达已修改，可点击"更新记录"按钮保存')},async handleUpdateFromEncodedExpression(){if(this.selectedRecord&&this.selectedRecord.cigCode)if(this.isEncodedExpressionChanged)if(this.encodedExpressionInput.trim())try{this.updatingFromEncoded=!0,console.log("开始验证编码表达式...");const e=this.validateEncodedExpressions(this.encodedExpressionInput);if(!e.isValid){const t=e.errors.join("\n");return void y["a"].error({dangerouslyUseHTMLString:!1,message:"编码表达式验证失败:\n"+t,duration:5e3})}e.warnings.length>0&&y["a"].success({message:e.warnings.join(", "),duration:3e3});const t=this.encodedExpressionInput.split("\n").map(e=>e.trim()).filter(e=>e.length>0);console.log("准备批量更新，编码表达式列表:",t);const o={cigCode:this.selectedRecord.cigCode,cigName:this.selectedRecord.cigName,year:this.selectedRecord.year,month:this.selectedRecord.month,weekSeq:this.selectedRecord.weekSeq,encodedExpressions:t,remark:`基于编码表达式的批量更新，共${t.length}条表达式`};console.log("批量更新请求数据:",o);const a=await B.batchUpdateFromExpressions(o);if(!a.data.success)throw new Error(a.data.message||"批量更新失败");{let e=a.data.message;"投放类型变更"===a.data.operation?e+=`\n删除了${a.data.deletedRecords}条记录，创建了${a.data.createdRecords}条记录`:"增量更新"===a.data.operation&&(e+=`\n新增${a.data.newAreas}个区域，更新${a.data.updatedAreas}个区域，删除${a.data.deletedAreas}个区域`),y["a"].success({message:e,duration:4e3}),this.originalEncodedExpression=this.encodedExpressionInput,this.$emit("position-updated",{cigCode:o.cigCode,updateData:o,updateType:"batchEncodedExpression",operationType:a.data.operation,result:a.data}),this.editMode="none"}}catch(e){console.error("编码表达式批量更新失败:",e);let t=e.message;e.response&&e.response.data&&(t=e.response.data.message||t),y["a"].error({message:"批量更新失败: "+t,duration:5e3})}finally{this.updatingFromEncoded=!1}else y["a"].error("编码表达不能为空");else y["a"].warning("编码表达未发生变化");else y["a"].error("请先选中一个卷烟记录")},updateSearchForm(e){e&&(this.searchForm.year=e.year,this.searchForm.month=e.month,this.searchForm.week=e.week,console.log("外部更新搜索表单:",e))},async performConsistencyCheck(){try{console.log("开始执行一致性检查...");const e=this.parseEncodedExpression(this.encodedExpressionInput),t=this.checkConsistency(e);if(0===t.length)return console.log("一致性检查通过"),{passed:!0};const o=await this.showConsistencyDialog(t);return o}catch(e){return console.error("一致性检查过程中发生错误:",e),y["a"].warning("一致性检查失败，建议分别保存各项设置"),{passed:!1}}},parseEncodedExpression(e){const t={deliveryType:"",extendedType:"",deliveryTypeCode:"",extendedTypeCode:"",areaCodes:[],areaNames:[],positionCoding:"",positionData:new Array(30).fill(0),isValid:!1,error:""};try{const o=e.trim();if(!o)return t.error="编码表达式不能为空",t;const a=o.charAt(0).toUpperCase();if(!["A","B","C"].includes(a))return t.error="投放类型编码错误，必须以A、B或C开头",t;switch(t.deliveryTypeCode=a,a){case"A":t.deliveryType="按档位统一投放";break;case"B":t.deliveryType="按档位扩展投放";break;case"C":t.deliveryType="按需投放";break}if("B"===a){const e=o.charAt(1);if(!["1","2","3","4","5"].includes(e))return t.error="B类型投放必须指定扩展类型编码（1-5）",t;switch(t.extendedTypeCode=e,e){case"1":t.extendedType="档位+区县";break;case"2":t.extendedType="档位+市场类型";break;case"3":t.extendedType="档位+区县+市场类型";break;case"4":t.extendedType="档位+城乡分类代码";break;case"5":t.extendedType="档位+业态";break}}const r=/（([^）]+)）（([^）]+)）/,i=o.match(r);if(!i)return t.error="编码格式错误，应为：类型+扩展类型（区域编码）（投放量编码）",t;const l=i[1],n=i[2],s=this.parseAreaCodes(l,t.extendedTypeCode);if(!s.isValid)return t.error=s.error,t;t.areaCodes=s.areaCodes,t.areaNames=s.areaNames;const c=this.parsePositionCoding(n);if(!c.isValid)return t.error=c.error,t;t.positionCoding=n,t.positionData=c.positionData,t.isValid=!0}catch(o){console.warn("编码表达解析失败:",o),t.error="解析异常: "+o.message}return t},parseAreaCodes(e,t){const o={areaCodes:[],areaNames:[],isValid:!1,error:""};try{const a={1:{1:"城区",2:"丹江",3:"房县",4:"郧西",5:"郧阳",6:"竹山",7:"竹溪"},2:{C:"城网",N:"农网"},3:{1:"城区",2:"丹江",3:"房县",4:"郧西",5:"郧阳",6:"竹山",7:"竹溪"},4:{"①":"主城区","②":"城乡结合区","③":"镇中心区","④":"镇乡接合区","⑤":"特殊区域","⑥":"乡中心区","⑦":"村庄"},5:{a:"便利店",b:"超市",c:"商场",d:"烟草专业店",e:"娱乐服务类",f:"其他"}},r=a[t]||a["1"],i=e.split("+").map(e=>e.trim()).filter(e=>e);if(0===i.length)return o.error="区域编码不能为空",o;for(const e of i){if(!r[e])return o.error="无效的区域编码: "+e,o;o.areaCodes.push(e),o.areaNames.push(r[e])}o.isValid=!0}catch(a){o.error="区域编码解析异常: "+a.message}return o},parsePositionCoding(e){const t={positionData:new Array(30).fill(0),isValid:!1,error:""};try{const o=e.split("+").map(e=>e.trim()).filter(e=>e);if(0===o.length)return t.error="投放量编码不能为空",t;let a=0;for(const e of o){const o=e.match(/^(\d+)×(\d+)$/);if(!o)return t.error=`投放量编码格式错误: ${e}，应为"档位数×投放量"格式`,t;const r=parseInt(o[1]),i=parseInt(o[2]);if(r<=0||r>30)return t.error=`档位数量错误: ${r}，应在1-30之间`,t;if(i<0)return t.error="投放量不能为负数: "+i,t;a+=r}if(30!==a)return t.error="总档位数必须为30，当前为: "+a,t;let r=0;for(const e of o){const o=e.match(/^(\d+)×(\d+)$/),a=parseInt(o[1]),i=parseInt(o[2]);for(let e=0;e<a;e++)t.positionData[r+e]=i;r+=a}t.isValid=!0}catch(o){t.error="投放量编码解析异常: "+o.message}return t},validateEncodedExpressions(e){const t={isValid:!1,errors:[],warnings:[]};try{const o=e.split("\n").map(e=>e.trim()).filter(e=>e.length>0);if(0===o.length)return t.errors.push("编码表达式列表不能为空"),t;const a=[];for(const e of o){const o=this.parseEncodedExpression(e);if(!o.isValid)return t.errors.push(`编码表达式"${e}"解析失败: ${o.error}`),t;a.push(o)}const r=[...new Set(a.map(e=>e.deliveryTypeCode))];if(r.length>1)return t.errors.push("不允许存在多种投放类型，当前包含: "+r.join(", ")),t;const i=[];for(const e of a)for(const o of e.areaCodes){if(i.includes(o))return t.errors.push("投放区域编号重复: "+o),t;i.push(o)}for(const e of a){const o=e.positionData.length;if(30!==o)return t.errors.push("编码表达式的投放量部分必须包含30个完整档位，当前为: "+o),t}t.isValid=!0,t.parsedExpressions=a,t.warnings.push(`共验证了 ${o.length} 条编码表达式`),t.warnings.push("投放类型: "+a[0].deliveryType),a[0].extendedType&&t.warnings.push("扩展类型: "+a[0].extendedType),t.warnings.push(`涉及区域: ${i.length} 个`)}catch(o){t.errors.push("验证过程异常: "+o.message)}return t},checkConsistency(e){const t=[];return e.deliveryType&&this.searchForm.distributionType&&e.deliveryType!==this.searchForm.distributionType&&t.push({type:"投放类型",encoded:e.deliveryType,current:this.searchForm.distributionType}),e.extendedType&&this.searchForm.extendedType&&e.extendedType!==this.searchForm.extendedType&&t.push({type:"扩展投放类型",encoded:e.extendedType,current:this.searchForm.extendedType}),t},async showConsistencyDialog(e){const t=e.map(e=>`• ${e.type}: 编码表达为"${e.encoded}"，当前设置为"${e.current}"`).join("\n"),o=`检测到以下不一致项：\n\n${t}\n\n请选择处理方式：`;try{const e=await le["a"].confirm(o,"数据一致性检查",{confirmButtonText:"强制更新（忽略冲突）",cancelButtonText:"取消操作",type:"warning",dangerouslyUseHTMLString:!1,customClass:"consistency-check-dialog",beforeClose:(e,t,o)=>{"confirm"===e?(t.confirmButtonText="强制更新中...",t.confirmButtonLoading=!0,setTimeout(()=>{o()},300)):o()}});if("confirm"===e)return y["a"].warning("已选择强制更新，将忽略一致性冲突"),{passed:!0,forced:!0}}catch(a){"cancel"===a&&y["a"].info("已取消更新操作")}return{passed:!1}}}};o("4d9e");const Ce=s()(ye,[["render",ie],["__scopeId","data-v-a26b7134"]]);var xe=Ce;const we={class:"import-table-component"},Ve={class:"import-buttons-row"},Ne={class:"dialog-footer"},ve={class:"dialog-footer"},De={class:"generate-plan-content"},ke={class:"plan-description"},Fe={style:{"font-size":"13px",color:"#606266"}},Ee={class:"generate-tips"},Re={class:"dialog-footer"};function Te(e,t,o,r,i,l){const n=Object(a["resolveComponent"])("DocumentAdd"),s=Object(a["resolveComponent"])("el-icon"),c=Object(a["resolveComponent"])("el-button"),d=Object(a["resolveComponent"])("DataAnalysis"),h=Object(a["resolveComponent"])("Cpu"),m=Object(a["resolveComponent"])("el-option"),u=Object(a["resolveComponent"])("el-select"),p=Object(a["resolveComponent"])("el-form-item"),b=Object(a["resolveComponent"])("Plus"),g=Object(a["resolveComponent"])("el-upload"),O=Object(a["resolveComponent"])("el-alert"),f=Object(a["resolveComponent"])("el-form"),j=Object(a["resolveComponent"])("el-dialog"),y=Object(a["resolveComponent"])("el-checkbox"),C=Object(a["resolveComponent"])("el-divider"),x=Object(a["resolveComponent"])("QuestionFilled"),w=Object(a["resolveComponent"])("el-tooltip"),V=Object(a["resolveComponent"])("el-input-number");return Object(a["openBlock"])(),Object(a["createElementBlock"])("div",we,[Object(a["createElementVNode"])("div",Ve,[Object(a["createVNode"])(c,{type:"primary",size:"default",onClick:l.showBasicInfoImportDialog},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(n)]),_:1}),t[19]||(t[19]=Object(a["createTextVNode"])(" 导入卷烟投放基本信息 ",-1))]),_:1},8,["onClick"]),Object(a["createVNode"])(c,{type:"success",size:"default",onClick:l.showCustomerDataImportDialog},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(d)]),_:1}),t[20]||(t[20]=Object(a["createTextVNode"])(" 导入区域客户数 ",-1))]),_:1},8,["onClick"]),Object(a["createVNode"])(c,{type:"warning",size:"default",onClick:l.showGeneratePlanDialog},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(h)]),_:1}),t[21]||(t[21]=Object(a["createTextVNode"])(" 生成分配方案 ",-1))]),_:1},8,["onClick"])]),Object(a["createVNode"])(j,{modelValue:i.basicInfoImportDialogVisible,"onUpdate:modelValue":t[4]||(t[4]=e=>i.basicInfoImportDialogVisible=e),title:"导入卷烟投放基本信息",width:"500px","close-on-click-modal":!1},{footer:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("span",Ne,[Object(a["createVNode"])(c,{onClick:t[3]||(t[3]=e=>i.basicInfoImportDialogVisible=!1)},{default:Object(a["withCtx"])(()=>[...t[25]||(t[25]=[Object(a["createTextVNode"])("取消",-1)])]),_:1}),Object(a["createVNode"])(c,{type:"primary",onClick:l.handleBasicInfoImport,loading:i.basicInfoImporting,disabled:!l.canImportBasicInfo},{default:Object(a["withCtx"])(()=>[...t[26]||(t[26]=[Object(a["createTextVNode"])(" 确定导入 ",-1)])]),_:1},8,["onClick","loading","disabled"])])]),default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(f,{model:i.basicInfoTimeForm,"label-width":"80px"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(p,{label:"年份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.basicInfoTimeForm.year,"onUpdate:modelValue":t[0]||(t[0]=e=>i.basicInfoTimeForm.year=e),placeholder:"选择年份",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.yearOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(p,{label:"月份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.basicInfoTimeForm.month,"onUpdate:modelValue":t[1]||(t[1]=e=>i.basicInfoTimeForm.month=e),placeholder:"选择月份",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.monthOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e+"月",value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(p,{label:"周序号",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.basicInfoTimeForm.weekSeq,"onUpdate:modelValue":t[2]||(t[2]=e=>i.basicInfoTimeForm.weekSeq=e),placeholder:"选择周序号",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.weekOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:`第${e}周`,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(p,{label:"选择文件",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(g,{ref:"basicInfoUpload",class:"basic-info-upload","auto-upload":!1,"show-file-list":!0,accept:".xlsx,.xls",limit:1,"file-list":i.basicInfoFileList,"before-upload":l.handleBasicInfoBeforeUpload,"on-change":l.handleBasicInfoChange,"on-remove":l.handleBasicInfoRemove},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(c,{type:"primary"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(b)]),_:1}),t[22]||(t[22]=Object(a["createTextVNode"])(" 选择Excel文件 ",-1))]),_:1})]),_:1},8,["file-list","before-upload","on-change","on-remove"]),t[23]||(t[23]=Object(a["createElementVNode"])("div",{class:"upload-tip"},"支持Excel格式(.xlsx, .xls)，文件大小不超过10MB",-1))]),_:1}),Object(a["createVNode"])(p,{label:"表结构要求"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(O,{title:"Excel文件必须包含以下列（大小写敏感）",type:"info",closable:!1,"show-icon":""},{default:Object(a["withCtx"])(()=>[...t[24]||(t[24]=[Object(a["createElementVNode"])("div",{class:"structure-requirements"},[Object(a["createElementVNode"])("p",null,[Object(a["createElementVNode"])("strong",null,"基本信息列：")]),Object(a["createElementVNode"])("ul",null,[Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"CIG_CODE"),Object(a["createTextVNode"])(" - 卷烟代码")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"CIG_NAME"),Object(a["createTextVNode"])(" - 卷烟名称")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"YEAR"),Object(a["createTextVNode"])(" - 年份")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"MONTH"),Object(a["createTextVNode"])(" - 月份")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"WEEK_SEQ"),Object(a["createTextVNode"])(" - 周序号")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"URS"),Object(a["createTextVNode"])(" - URS")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"ADV"),Object(a["createTextVNode"])(" - ADV")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"DELIVERY_METHOD"),Object(a["createTextVNode"])(" - 档位投放方式")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"DELIVERY_ETYPE"),Object(a["createTextVNode"])(" - 扩展投放方式")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"DELIVERY_AREA"),Object(a["createTextVNode"])(" - 投放区域")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"remark"),Object(a["createTextVNode"])(" - 备注")])]),Object(a["createElementVNode"])("p",null,[Object(a["createElementVNode"])("strong",null,"可选列：")]),Object(a["createElementVNode"])("ul",null,[Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"id"),Object(a["createTextVNode"])(" - 主键ID（可选，系统会自动生成）")])])],-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),Object(a["createVNode"])(j,{modelValue:i.customerDataImportDialogVisible,"onUpdate:modelValue":t[11]||(t[11]=e=>i.customerDataImportDialogVisible=e),title:"导入区域客户数",width:"600px","close-on-click-modal":!1},{footer:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("span",ve,[Object(a["createVNode"])(c,{onClick:t[10]||(t[10]=e=>i.customerDataImportDialogVisible=!1)},{default:Object(a["withCtx"])(()=>[...t[30]||(t[30]=[Object(a["createTextVNode"])("取消",-1)])]),_:1}),Object(a["createVNode"])(c,{type:"primary",onClick:l.handleCustomerDataImport,loading:i.customerDataImporting,disabled:!l.canImportCustomerData},{default:Object(a["withCtx"])(()=>[...t[31]||(t[31]=[Object(a["createTextVNode"])(" 确定导入 ",-1)])]),_:1},8,["onClick","loading","disabled"])])]),default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(f,{model:i.customerImportForm,"label-width":"120px"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(p,{label:"投放方法",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.customerImportForm.deliveryMethod,"onUpdate:modelValue":t[5]||(t[5]=e=>i.customerImportForm.deliveryMethod=e),placeholder:"请选择投放方法",style:{width:"100%"},onChange:l.handleCustomerImportTypeChange},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,{label:"按档位统一投放",value:"按档位统一投放"}),Object(a["createVNode"])(m,{label:"按档位扩展投放",value:"按档位扩展投放"})]),_:1},8,["modelValue","onChange"])]),_:1}),"按档位扩展投放"===i.customerImportForm.deliveryMethod?(Object(a["openBlock"])(),Object(a["createBlock"])(p,{key:0,label:"扩展投放类型",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.customerImportForm.deliveryEtype,"onUpdate:modelValue":t[6]||(t[6]=e=>i.customerImportForm.deliveryEtype=e),placeholder:"请选择扩展投放类型",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(m,{label:"档位+区县",value:"档位+区县"}),Object(a["createVNode"])(m,{label:"档位+城乡分类代码",value:"档位+城乡分类代码"}),Object(a["createVNode"])(m,{label:"档位+市场类型",value:"档位+市场类型"}),Object(a["createVNode"])(m,{label:"档位+业态",value:"档位+业态"})]),_:1},8,["modelValue"])]),_:1})):Object(a["createCommentVNode"])("",!0),Object(a["createVNode"])(p,{label:"年份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.customerImportForm.year,"onUpdate:modelValue":t[7]||(t[7]=e=>i.customerImportForm.year=e),placeholder:"请选择年份",style:{width:"100%"},disabled:i.customerDataImporting},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.yearOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),Object(a["createVNode"])(p,{label:"月份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.customerImportForm.month,"onUpdate:modelValue":t[8]||(t[8]=e=>i.customerImportForm.month=e),placeholder:"请选择月份",style:{width:"100%"},disabled:i.customerDataImporting},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.monthOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),Object(a["createVNode"])(p,{label:"双周上浮"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(y,{modelValue:i.customerImportForm.isBiWeeklyFloat,"onUpdate:modelValue":t[9]||(t[9]=e=>i.customerImportForm.isBiWeeklyFloat=e),disabled:i.customerDataImporting},null,8,["modelValue","disabled"])]),_:1}),Object(a["createVNode"])(p,{label:"选择文件",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(g,{ref:"customerDataUpload",class:"customer-data-upload","auto-upload":!1,"show-file-list":!0,accept:".xlsx,.xls",limit:1,"file-list":i.customerDataFileList,"before-upload":l.handleCustomerDataBeforeUpload,"on-change":l.handleCustomerDataChange,"on-remove":l.handleCustomerDataRemove},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(c,{type:"primary"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(b)]),_:1}),t[27]||(t[27]=Object(a["createTextVNode"])(" 选择Excel文件 ",-1))]),_:1})]),_:1},8,["file-list","before-upload","on-change","on-remove"]),t[28]||(t[28]=Object(a["createElementVNode"])("div",{class:"upload-tip"},"支持Excel格式(.xlsx, .xls)，文件大小不超过10MB",-1))]),_:1}),Object(a["createVNode"])(p,{label:"表结构要求"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(O,{title:"Excel文件必须包含以下列（大小写敏感）",type:"info",closable:!1,"show-icon":""},{default:Object(a["withCtx"])(()=>[...t[29]||(t[29]=[Object(a["createElementVNode"])("div",{class:"structure-requirements"},[Object(a["createElementVNode"])("p",null,[Object(a["createElementVNode"])("strong",null,"客户数据列：")]),Object(a["createElementVNode"])("ul",null,[Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"region"),Object(a["createTextVNode"])(" - 区域标识")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"D30"),Object(a["createTextVNode"])(" 到 "),Object(a["createElementVNode"])("code",null,"D1"),Object(a["createTextVNode"])(" - 30个档位客户数列")]),Object(a["createElementVNode"])("li",null,[Object(a["createElementVNode"])("code",null,"TOTAL"),Object(a["createTextVNode"])(" - 总客户数")])]),Object(a["createElementVNode"])("p",null,[Object(a["createElementVNode"])("strong",null,"注意："),Object(a["createTextVNode"])("必须包含D30到D1共30个档位列，不能缺少任何一个")])],-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),Object(a["createVNode"])(j,{modelValue:i.generatePlanDialogVisible,"onUpdate:modelValue":t[18]||(t[18]=e=>i.generatePlanDialogVisible=e),title:"生成分配方案",width:"500px","close-on-click-modal":!1},{footer:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("span",Re,[Object(a["createVNode"])(c,{onClick:t[17]||(t[17]=e=>i.generatePlanDialogVisible=!1)},{default:Object(a["withCtx"])(()=>[...t[37]||(t[37]=[Object(a["createTextVNode"])("取消",-1)])]),_:1}),Object(a["createVNode"])(c,{type:"primary",onClick:l.handleGeneratePlan,loading:i.generatingPlan,disabled:!l.canGeneratePlan},{default:Object(a["withCtx"])(()=>[Object(a["createTextVNode"])(Object(a["toDisplayString"])(i.generatingPlan?"生成中...":"确定生成"),1)]),_:1},8,["onClick","loading","disabled"])])]),default:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("div",De,[Object(a["createElementVNode"])("div",ke,[Object(a["createVNode"])(O,{title:"分配方案生成说明",type:"info",closable:!1,"show-icon":""},{default:Object(a["withCtx"])(()=>[...t[32]||(t[32]=[Object(a["createElementVNode"])("p",null,"系统将根据选定时间的卷烟投放基本信息和区域客户数据，自动计算生成各卷烟的档位分配方案。",-1),Object(a["createElementVNode"])("p",null,"请选择需要生成分配方案的时间范围：",-1)])]),_:1})]),Object(a["createVNode"])(C),Object(a["createVNode"])(f,{model:i.generatePlanForm,"label-width":"80px"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(p,{label:"年份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.generatePlanForm.year,"onUpdate:modelValue":t[12]||(t[12]=e=>i.generatePlanForm.year=e),placeholder:"选择年份",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.yearOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(p,{label:"月份",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.generatePlanForm.month,"onUpdate:modelValue":t[13]||(t[13]=e=>i.generatePlanForm.month=e),placeholder:"选择月份",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.monthOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:e+"月",value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(p,{label:"周序号",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(u,{modelValue:i.generatePlanForm.weekSeq,"onUpdate:modelValue":t[14]||(t[14]=e=>i.generatePlanForm.weekSeq=e),placeholder:"选择周序号",style:{width:"100%"}},{default:Object(a["withCtx"])(()=>[(Object(a["openBlock"])(!0),Object(a["createElementBlock"])(a["Fragment"],null,Object(a["renderList"])(l.weekOptions,e=>(Object(a["openBlock"])(),Object(a["createBlock"])(m,{key:e,label:`第${e}周`,value:e},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),Object(a["createVNode"])(C,{"content-position":"left"},{default:Object(a["withCtx"])(()=>[Object(a["createElementVNode"])("span",Fe,[t[33]||(t[33]=Object(a["createTextVNode"])(" 档位+市场类型分配比例 ",-1)),Object(a["createVNode"])(w,{content:"仅用于投放方式为'档位+市场类型'的卷烟",placement:"top"},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(s,{style:{"margin-left":"5px",cursor:"help"}},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(x)]),_:1})]),_:1})])]),_:1}),Object(a["createVNode"])(O,{title:"比例参数说明",type:"info",closable:!1,"show-icon":"",style:{"margin-bottom":"15px"}},{default:Object(a["withCtx"])(()=>[...t[34]||(t[34]=[Object(a["createElementVNode"])("div",{style:{"font-size":"12px","line-height":"1.6"}},[Object(a["createElementVNode"])("p",{style:{margin:"4px 0"}},'• 仅用于投放方式为"档位+市场类型"的卷烟'),Object(a["createElementVNode"])("p",{style:{margin:"4px 0"}},"• 其他投放方式（档位+区县、档位+城乡分类代码等）不受影响"),Object(a["createElementVNode"])("p",{style:{margin:"4px 0"}},"• 比例总和必须为100%"),Object(a["createElementVNode"])("p",{style:{margin:"4px 0"}},"• 不设置时使用默认值：城网40%，农网60%")],-1)])]),_:1}),Object(a["createVNode"])(p,{label:"城网比例",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(V,{modelValue:i.generatePlanForm.urbanRatio,"onUpdate:modelValue":t[15]||(t[15]=e=>i.generatePlanForm.urbanRatio=e),min:0,max:100,precision:0,step:5,style:{width:"100%"},onChange:l.handleUrbanRatioChange},{suffix:Object(a["withCtx"])(()=>[...t[35]||(t[35]=[Object(a["createTextVNode"])("%",-1)])]),_:1},8,["modelValue","onChange"])]),_:1}),Object(a["createVNode"])(p,{label:"农网比例",required:""},{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(V,{modelValue:i.generatePlanForm.ruralRatio,"onUpdate:modelValue":t[16]||(t[16]=e=>i.generatePlanForm.ruralRatio=e),min:0,max:100,precision:0,step:5,style:{width:"100%"},onChange:l.handleRuralRatioChange},{suffix:Object(a["withCtx"])(()=>[...t[36]||(t[36]=[Object(a["createTextVNode"])("%",-1)])]),_:1},8,["modelValue","onChange"])]),_:1}),Object(a["createVNode"])(p,null,{default:Object(a["withCtx"])(()=>[Object(a["createVNode"])(O,{title:l.ratioValidationMessage,type:l.ratioValidationType,closable:!1,"show-icon":""},null,8,["title","type"])]),_:1})]),_:1},8,["model"]),Object(a["createElementVNode"])("div",Ee,[l.isGeneratePlanTimeComplete?(Object(a["openBlock"])(),Object(a["createBlock"])(O,{key:1,title:`将为 ${i.generatePlanForm.year}年${i.generatePlanForm.month}月第${i.generatePlanForm.weekSeq}周 生成分配方案`,type:"success",closable:!1,"show-icon":""},null,8,["title"])):(Object(a["openBlock"])(),Object(a["createBlock"])(O,{key:0,title:"请选择完整的时间信息后再生成分配方案",type:"warning",closable:!1,"show-icon":""}))])])]),_:1},8,["modelValue"])])}var Ie={name:"ImportTable",components:{DocumentAdd:j["DocumentAdd"],DataAnalysis:j["DataAnalysis"],Plus:j["Plus"],Cpu:j["Cpu"],QuestionFilled:j["QuestionFilled"]},emits:["import-success","data-refresh"],data(){return{basicInfoImportDialogVisible:!1,basicInfoFileList:[],basicInfoImporting:!1,basicInfoTimeForm:{year:null,month:null,weekSeq:null},customerDataImportDialogVisible:!1,customerDataFileList:[],customerDataImporting:!1,customerImportForm:{deliveryMethod:"",deliveryEtype:"",year:null,month:null,isBiWeeklyFloat:!1},generatePlanDialogVisible:!1,generatePlanForm:{year:null,month:null,weekSeq:null,urbanRatio:40,ruralRatio:60},generatingPlan:!1}},computed:{yearOptions(){const e=(new Date).getFullYear(),t=[];for(let o=e-2;o<=e+2;o++)t.push(o);return t},monthOptions(){return Array.from({length:12},(e,t)=>t+1)},weekOptions(){return[1,2,3,4,5]},isBasicInfoTimeComplete(){return this.basicInfoTimeForm.year&&this.basicInfoTimeForm.month&&this.basicInfoTimeForm.weekSeq},canImportBasicInfo(){return this.basicInfoFileList.length>0&&this.isBasicInfoTimeComplete&&!this.basicInfoImporting},canImportCustomerData(){const e=this.customerDataFileList.length>0,t=this.customerImportForm.deliveryMethod,o=this.customerImportForm.year,a=this.customerImportForm.month;let r=!1;return"按档位统一投放"===this.customerImportForm.deliveryMethod?r=!0:"按档位扩展投放"===this.customerImportForm.deliveryMethod&&(r=!!this.customerImportForm.deliveryEtype),e&&t&&o&&a&&r&&!this.customerDataImporting},isGeneratePlanTimeComplete(){return this.generatePlanForm.year&&this.generatePlanForm.month&&this.generatePlanForm.weekSeq},canGeneratePlan(){return this.isGeneratePlanTimeComplete&&this.isRatioValid&&!this.generatingPlan},isRatioValid(){const e=this.generatePlanForm.urbanRatio+this.generatePlanForm.ruralRatio;return 100===e},ratioValidationMessage(){const e=this.generatePlanForm.urbanRatio+this.generatePlanForm.ruralRatio;return 100===e?`比例设置正确：城网 ${this.generatePlanForm.urbanRatio}% + 农网 ${this.generatePlanForm.ruralRatio}% = 100%`:e>100?`比例总和超过100%，当前为 ${e}%，请调整`:`比例总和不足100%，当前为 ${e}%，请调整`},ratioValidationType(){const e=this.generatePlanForm.urbanRatio+this.generatePlanForm.ruralRatio;return 100===e?"success":"warning"}},methods:{showBasicInfoImportDialog(){this.basicInfoImportDialogVisible=!0},handleBasicInfoBeforeUpload(e){const t="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type||"application/vnd.ms-excel"===e.type||"application/excel"===e.type||"application/x-excel"===e.type||"application/x-msexcel"===e.type||e.name.toLowerCase().endsWith(".xlsx")||e.name.toLowerCase().endsWith(".xls"),o=e.size/1024/1024<10;return t?o?(this.basicInfoFileList=[e],console.log("基本信息文件上传前检查:",{file:e,isFile:e instanceof File,fileName:e.name,fileType:e.type,fileSize:e.size}),!1):(y["a"].error("文件大小不能超过10MB!"),!1):(y["a"].error("只能上传Excel文件! 当前文件类型: "+e.type),!1)},handleBasicInfoChange(e,t){if(t&&t.length>0){const t=e.raw||e;this.basicInfoFileList=[t],console.log("基本信息文件变化处理:",{originalFile:t,isFile:t instanceof File,fileName:t.name,fileType:t.type})}else this.basicInfoFileList=[]},handleBasicInfoRemove(){this.basicInfoFileList=[]},async checkBasicInfoStructure(e){try{const t=["CIG_CODE","CIG_NAME","YEAR","MONTH","WEEK_SEQ","URS","ADV","DELIVERY_METHOD","DELIVERY_ETYPE","DELIVERY_AREA","remark"],o=["id"],a=10485760;if(e.size>a)return{valid:!1,message:"文件大小超过限制（最大10MB）"};const r=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/excel","application/x-excel","application/x-msexcel"],i=e.name.toLowerCase(),l=i.endsWith(".xlsx")||i.endsWith(".xls"),n=r.includes(e.type);return n||l?(console.log("检查基本信息Excel表结构...",{fileName:e.name,fileSize:(e.size/1024/1024).toFixed(2)+"MB",fileType:e.type,requiredColumns:t,optionalColumns:o,totalRequiredColumns:t.length,note:"id列是可选的，系统会自动生成新的ID"}),{valid:!0,message:"表结构检查通过，包含所有必需列名",requiredColumns:t}):{valid:!1,message:"文件格式不正确，请上传Excel文件(.xlsx或.xls)。当前文件类型: "+e.type}}catch(t){return{valid:!1,message:"表结构检查失败: "+t.message}}},async handleBasicInfoImport(){if(this.canImportBasicInfo)if(this.basicInfoTimeForm.year&&this.basicInfoTimeForm.month&&this.basicInfoTimeForm.weekSeq){this.basicInfoImporting=!0;try{const e=this.basicInfoFileList[0];if(!e)return void y["a"].error("请先选择文件");if(!(e instanceof File))return void y["a"].error("文件对象无效，请重新选择文件");console.log("基本信息导入文件对象:",{file:e,isFile:e instanceof File,fileName:e.name,fileType:e.type});const t=await this.checkBasicInfoStructure(e);if(!t.valid)return void y["a"].error(t.message);console.log("基本信息导入表单数据:",{year:this.basicInfoTimeForm.year,month:this.basicInfoTimeForm.month,weekSeq:this.basicInfoTimeForm.weekSeq,file:e});const o=new FormData;o.append("file",e),o.append("year",this.basicInfoTimeForm.year.toString()),o.append("month",this.basicInfoTimeForm.month.toString()),o.append("weekSeq",this.basicInfoTimeForm.weekSeq.toString()),console.log("FormData内容:");for(let[r,i]of o.entries())console.log(r+":",i,typeof i);const a=await B.importBasicInfo(o);if(!a.data.success)throw new Error(a.data.message||"导入失败");y["a"].success(`基本信息导入成功！共导入 ${a.data.insertedCount||a.data.importCount} 条记录`),this.basicInfoImportDialogVisible=!1,this.basicInfoFileList=[],this.basicInfoTimeForm={year:null,month:null,weekSeq:null},this.$emit("data-refresh"),this.$emit("import-success",{type:"basic-info",result:a.data})}catch(e){console.error("导入基本信息失败:",e),y["a"].error("导入失败: "+e.message)}finally{this.basicInfoImporting=!1}}else y["a"].error("请选择完整的时间信息（年份、月份、周序号）");else y["a"].warning("请检查文件和时间选择")},showCustomerDataImportDialog(){this.customerDataImportDialogVisible=!0},handleCustomerImportTypeChange(e){this.customerImportForm.deliveryEtype="按档位统一投放"===e?"按档位统一投放":""},handleCustomerDataBeforeUpload(e){const t="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type||"application/vnd.ms-excel"===e.type||"application/excel"===e.type||"application/x-excel"===e.type||"application/x-msexcel"===e.type||e.name.toLowerCase().endsWith(".xlsx")||e.name.toLowerCase().endsWith(".xls"),o=e.size/1024/1024<10;return t?o?(this.customerDataFileList=[e],console.log("文件上传前检查:",{file:e,isFile:e instanceof File,fileName:e.name,fileType:e.type,fileSize:e.size}),!1):(y["a"].error("文件大小不能超过10MB!"),!1):(y["a"].error("只能上传Excel文件! 当前文件类型: "+e.type),!1)},handleCustomerDataChange(e,t){if(t&&t.length>0){const t=e.raw||e;this.customerDataFileList=[t],console.log("文件变化处理:",{originalFile:t,isFile:t instanceof File,fileName:t.name,fileType:t.type})}else this.customerDataFileList=[]},handleCustomerDataRemove(){this.customerDataFileList=[]},async checkCustomerDataStructure(e){try{const t=["region","TOTAL"];for(let e=30;e>=1;e--)t.push("D"+e);const o=10485760;if(e.size>o)return{valid:!1,message:"文件大小超过限制（最大10MB）"};const a=["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel","application/excel","application/x-excel","application/x-msexcel"],r=e.name.toLowerCase(),i=r.endsWith(".xlsx")||r.endsWith(".xls"),l=a.includes(e.type);return l||i?(console.log("检查客户数据Excel表结构...",{fileName:e.name,fileSize:(e.size/1024/1024).toFixed(2)+"MB",fileType:e.type,requiredColumns:t,totalColumns:t.length,dColumns:"D30到D1共30个档位列",note:"必须包含D30到D1共30个档位列，不能缺少任何一个"}),{valid:!0,message:"表结构检查通过，包含所有必需列名（包括30个档位列）",requiredColumns:t}):{valid:!1,message:"文件格式不正确，请上传Excel文件(.xlsx或.xls)。当前文件类型: "+e.type}}catch(t){return{valid:!1,message:"表结构检查失败: "+t.message}}},async handleCustomerDataImport(){if(this.canImportCustomerData){this.customerDataImporting=!0;try{const e=this.customerDataFileList[0];console.log("表结构检查文件对象:",{file:e,isFile:e instanceof File,fileName:e.name,fileType:e.type});const t=await this.checkCustomerDataStructure(e);if(!t.valid)return void y["a"].error(t.message);const o=this.customerDataFileList[0];if(!o)return void y["a"].error("请先选择文件");if(!(o instanceof File))return void y["a"].error("文件对象无效，请重新选择文件");const a=new FormData;a.append("file",o),a.append("year",this.customerImportForm.year.toString()),a.append("month",this.customerImportForm.month.toString()),a.append("deliveryMethod",this.customerImportForm.deliveryMethod);const r="按档位统一投放"===this.customerImportForm.deliveryMethod?"按档位统一投放":this.customerImportForm.deliveryEtype||"";a.append("deliveryEtype",r),a.append("isBiWeeklyFloat",this.customerImportForm.isBiWeeklyFloat.toString()),console.log("客户数据导入参数:",{deliveryMethod:this.customerImportForm.deliveryMethod,deliveryEtype:this.customerImportForm.deliveryEtype,year:this.customerImportForm.year,month:this.customerImportForm.month,isBiWeeklyFloat:this.customerImportForm.isBiWeeklyFloat}),console.log("FormData内容:");for(let[l,n]of a.entries())console.log(l+":",n,typeof n),"file"===l&&console.log("文件对象验证:",{isFile:n instanceof File,fileName:n.name,fileSize:n.size,fileType:n.type});console.log("文件对象详情:",{file:o,fileName:o.name,fileSize:o.size,fileType:o.type,isFile:o instanceof File});const i=await B.importCustomerData(a);if(!i.data.success)throw new Error(i.data.message||"导入失败");y["a"].success(`客户数据导入成功！共导入 ${i.data.insertedCount||i.data.importCount} 条记录`),this.customerDataImportDialogVisible=!1,this.customerDataFileList=[],this.customerImportForm.deliveryMethod="",this.customerImportForm.deliveryEtype="",this.customerImportForm.year=null,this.customerImportForm.month=null,this.customerImportForm.isBiWeeklyFloat=!1,this.$emit("data-refresh"),this.$emit("import-success",{type:"customer-data",result:i.data})}catch(e){console.error("导入客户数据失败:",e);let t="导入失败";if(e.response&&e.response.data){if(console.error("后端错误响应:",e.response.data),e.response.data.message)t=e.response.data.message;else if(e.response.data.errors){const o=e.response.data.errors,a=Object.values(o).join(", ");t="参数验证失败: "+a}}else e.message&&(t=e.message);y["a"].error(t)}finally{this.customerDataImporting=!1}}else y["a"].warning("请检查文件和投放类型选择")},showGeneratePlanDialog(){this.generatePlanForm.urbanRatio=40,this.generatePlanForm.ruralRatio=60,this.generatePlanDialogVisible=!0},handleUrbanRatioChange(e){null!==e&&void 0!==e||(this.generatePlanForm.urbanRatio=0,e=0),e<0?(this.generatePlanForm.urbanRatio=0,e=0):e>100&&(this.generatePlanForm.urbanRatio=100,e=100),this.generatePlanForm.ruralRatio=100-e},handleRuralRatioChange(e){null!==e&&void 0!==e||(this.generatePlanForm.ruralRatio=0,e=0),e<0?(this.generatePlanForm.ruralRatio=0,e=0):e>100&&(this.generatePlanForm.ruralRatio=100,e=100),this.generatePlanForm.urbanRatio=100-e},async handleGeneratePlan(){if(this.canGeneratePlan){this.generatingPlan=!0;try{const e={year:this.generatePlanForm.year,month:this.generatePlanForm.month,weekSeq:this.generatePlanForm.weekSeq,urbanRatio:this.generatePlanForm.urbanRatio,ruralRatio:this.generatePlanForm.ruralRatio};console.log("生成分配方案请求数据（前端格式）:",e),console.log("发送给后端的格式（小数）:",{...e,urbanRatio:e.urbanRatio/100,ruralRatio:e.ruralRatio/100});const t=await B.generateDistributionPlan(e);if(console.log("生成分配方案响应数据:",t.data),!t.data.success)throw new Error(t.data.message||"生成分配方案失败");{y["a"].success({message:"分配方案生成成功！",duration:3e3});const o=[];void 0!==t.data.totalCigarettes&&null!==t.data.totalCigarettes&&o.push(`📊 共处理卷烟种类：${t.data.totalCigarettes} 种`),void 0!==t.data.successfulAllocations&&null!==t.data.successfulAllocations&&o.push(`✅ 成功分配卷烟：${t.data.successfulAllocations} 种`),void 0!==t.data.deletedRecords&&null!==t.data.deletedRecords&&o.push(`🗑️ 删除旧记录：${t.data.deletedRecords} 条`),void 0!==t.data.processedCount&&null!==t.data.processedCount&&o.push(`📝 生成新记录：${t.data.processedCount} 条`),t.data.processingTime&&o.push("⏱️ 处理耗时："+t.data.processingTime);const a=`\n            <div style="text-align: center; line-height: 1.6;">\n              <p style="margin: 10px 0; font-weight: bold; color: #409EFF; font-size: 16px;">✅ 操作执行成功</p>\n              <hr style="margin: 15px 0; border: none; border-top: 1px solid #EBEEF5;">\n              <div style="text-align: left; line-height: 1.8;">\n                ${o.map(e=>`<p style="margin: 8px 0;">${e}</p>`).join("")}\n              </div>\n            </div>\n          `;await Object(le["a"])({title:"生成分配方案完成",message:a,confirmButtonText:"确定",type:"success",customClass:"generation-result-dialog",dangerouslyUseHTMLString:!0}),this.generatePlanDialogVisible=!1,this.generatePlanForm={year:null,month:null,weekSeq:null,urbanRatio:40,ruralRatio:60},this.$emit("data-refresh"),this.$emit("import-success",{type:"generate-plan",result:t.data,searchParams:e})}}catch(e){console.error("生成分配方案失败:",e),y["a"].error("生成失败: "+e.message)}finally{this.generatingPlan=!1}}else this.isGeneratePlanTimeComplete?this.isRatioValid||y["a"].warning("请确保城网和农网比例总和为100%"):y["a"].warning("请选择完整的时间信息")}}};o("491f");const Se=s()(Ie,[["render",Te],["__scopeId","data-v-5d9fde14"]]);var Be=Se,Ae={name:"Home",components:{Grid:j["Grid"],DataTable:M,SearchForm:xe,ImportTable:Be},data(){return{searchParams:{},selectedCigaretteName:"",currentPositionData:{},selectedRecord:null,tableData:[]}},computed:{},methods:{handleSearch(e){console.log("搜索参数:",e),this.searchParams={year:e.year,month:e.month,weekSeq:e.week},y["a"].success(`已查询：${e.year}年${e.month}月第${e.week}周`)},handleDataLoaded(e){this.tableData=e,console.log("表格数据已加载:",e)},handleRowSelected(e){const t=this.tableData.filter(t=>t.cigName===e.cigName&&t.year===e.year&&t.month===e.month&&t.weekSeq===e.weekSeq),o=t.map(e=>e.deliveryArea).filter(e=>e);this.selectedCigaretteName=e.cigName,this.selectedRecord={...e,allAreas:o,totalRecords:t.length},console.log("选中行及相关记录:",{selectedRow:e,relatedRecords:t,allAreas:o}),y["a"].info(`已选中：${e.cigName}，该日期共有 ${t.length} 个投放区域`)},handleReset(){this.searchParams={},this.selectedCigaretteName="",this.currentPositionData={},this.selectedRecord=null,this.tableData=[],this.$refs.dataTable&&(this.$refs.dataTable.selectedRow=null),y["a"].info("已重置查询条件")},handleExport(e){console.log("导出参数:",e),this.tableData&&0!==this.tableData.length?this.$refs.dataTable?this.$refs.dataTable.handleExport():y["a"].error("导出组件未找到"):y["a"].warning("暂无数据可导出，请先查询数据")},handleSearchNext(){this.$refs.dataTable&&this.$refs.dataTable.searchNext()},handleCigaretteNameMatched(e){if(console.log("卷烟名称匹配到记录:",e),Array.isArray(e)&&e.length>0){const t=e[0],o=e.map(e=>e.deliveryArea).filter(e=>e);this.selectedCigaretteName=t.cigName,this.selectedRecord={...t,allAreas:o,totalRecords:e.length},this.$refs.dataTable&&this.$refs.dataTable.scrollToSelectedRecord(t),console.log("搜索匹配选中记录:",{primaryRecord:t,allMatchedRecords:e,allAreas:o})}},async handlePositionUpdated(e){console.log("档位设置已更新:",e);try{this.$refs.dataTable&&(await this.$refs.dataTable.handleRefresh(),setTimeout(()=>{if(this.selectedRecord&&this.selectedRecord.cigCode===e.cigCode){const t=this.tableData.find(t=>t.cigCode===e.cigCode&&t.year===e.updateData.year&&t.month===e.updateData.month&&t.weekSeq===e.updateData.weekSeq);t&&this.handleRowSelected(t)}},500)),y["a"].success("表格数据已刷新，显示最新的档位设置")}catch(t){console.error("刷新表格数据失败:",t),y["a"].warning("档位设置已保存，但表格刷新失败，请手动刷新")}},async handleAreaAdded(e){console.log("新增投放区域:",e);try{this.$refs.dataTable&&(await this.$refs.dataTable.handleRefresh(),setTimeout(()=>{if(this.selectedRecord&&this.selectedRecord.cigCode===e.cigCode){const t=this.tableData.filter(t=>t.cigCode===e.cigCode&&t.year===this.selectedRecord.year&&t.month===this.selectedRecord.month&&t.weekSeq===this.selectedRecord.weekSeq);t.length>0&&(this.handleRowSelected(t[0]),this.$refs.dataTable&&this.$refs.dataTable.scrollToSelectedRecord(t[0]))}},500)),y["a"].success("表格已刷新，新增的投放区域记录已显示并集中相邻排列")}catch(t){console.error("刷新表格数据失败:",t),y["a"].warning("投放区域已新增，但表格刷新失败，请手动刷新")}},async handleAreasDeleted(e){console.log("删除投放区域:",e);try{this.$refs.dataTable&&(await this.$refs.dataTable.handleRefresh(),setTimeout(()=>{if(this.selectedRecord&&this.selectedRecord.cigCode===e.cigCode){const t=this.tableData.filter(t=>t.cigCode===e.cigCode&&t.year===this.selectedRecord.year&&t.month===this.selectedRecord.month&&t.weekSeq===this.selectedRecord.weekSeq);t.length>0?(this.handleRowSelected(t[0]),this.$refs.dataTable&&this.$refs.dataTable.scrollToSelectedRecord(t[0])):(this.selectedRecord=null,this.selectedCigaretteName="")}},500)),y["a"].success("表格已刷新，已删除的投放区域记录已移除")}catch(t){console.error("刷新表格数据失败:",t),y["a"].warning("投放区域已删除，但表格刷新失败，请手动刷新")}},handleImportSuccess(e){console.log("导入成功事件:",e),"generate-plan"===e.type&&e.searchParams&&setTimeout(()=>{console.log("自动刷新卷烟投放数据统计表，使用生成方案的时间范围...");const t={year:e.searchParams.year,month:e.searchParams.month,week:e.searchParams.weekSeq};console.log("搜索参数:",t),this.$refs.searchForm&&this.$refs.searchForm.updateSearchForm&&this.$refs.searchForm.updateSearchForm(t),this.handleSearch(t),setTimeout(()=>{this.$refs.dataTable&&this.$refs.dataTable.handleRefresh&&(console.log("直接刷新DataTable组件..."),this.$refs.dataTable.handleRefresh(),y["a"].info({message:"数据已自动刷新，显示最新的分配方案",duration:2e3}))},200)},1e3)},handleDataRefresh(){console.log("数据刷新事件"),this.$refs.dataTable&&this.$refs.dataTable.handleRefresh()},handleRefreshBeforeFilter(){console.log("筛选误差前刷新数据"),this.$refs.dataTable&&this.$refs.dataTable.handleRefresh()}},beforeUnmount(){this.updateTimer&&clearTimeout(this.updateTimer)}};o("c5aa");const _e=s()(Ae,[["render",f],["__scopeId","data-v-20e38774"]]);var $e=_e;const Pe=[{path:"/",name:"Home",component:$e}],qe=Object(h["a"])({history:Object(h["b"])("/"),routes:Pe});var Me=qe,Le=o("c3a1");o("7437");const ze=Object(a["createApp"])(d);for(const[Ue,We]of Object.entries(j))ze.component(Ue,We);ze.use(Le["a"]),ze.use(Me),ze.mount("#app")},6394:function(e,t,o){},"7e3f":function(e,t,o){"use strict";o("2c8d")},"7f18":function(e,t,o){"use strict";o("a3bc")},"812e":function(e,t,o){},a3bc:function(e,t,o){},c5aa:function(e,t,o){"use strict";o("4cc8")},c5bf:function(e,t,o){}});
//# sourceMappingURL=app.a55768b7.js.map