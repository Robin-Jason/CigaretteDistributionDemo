# 一键部署指南

> **目标服务器**: 10.69.110.130:50130  
> **部署时间**: 约15分钟（首次）  
> **状态**: ✅ 已验证，可立即部署

---

## 🎯 快速部署（3步）

### 第1步：上传文件到服务器

**在本地Mac终端执行**：

```bash
cd /Users/robin/Desktop/CigaretteDistributionSystem
scp -P 50130 -r data/ root@10.69.110.130:/root/cigarette-distribution-system/
```

**输入密码**: `SYyc_110.130#`

**预计时间**: 2-3分钟（上传77MB）

**验证上传成功**：
```bash
# 应该看到文件传输完成，无错误提示
```

---

### 第2步：连接到服务器

```bash
ssh -p 50130 root@10.69.110.130
```

**输入密码**: `SYyc_110.130#`

---

### 第3步：一键部署

**在服务器上执行**：

```bash
cd /root/cigarette-system/data
chmod +x deploy.sh
./deploy.sh
```

**脚本会自动完成**：
1. ✅ 检查Docker环境
2. ✅ 检查所有文件（前端+后端+8个配置+SQL）
3. ✅ 创建数据目录
4. ✅ 复制初始化SQL到 `/data/mysql/init/`
5. ✅ 创建Docker网络
6. ✅ 停止旧服务（如有）
7. ✅ 构建Docker镜像
8. ✅ 启动所有服务

**预计时间**: 10-15分钟

---

## ✅ 验证部署成功

### 1. 检查容器状态

```bash
docker ps
```

**预期输出**：应该看到3个运行中的容器

```
CONTAINER ID   IMAGE               STATUS         PORTS                    NAMES
xxxxxxxxx      vue-web             Up X minutes   0.0.0.0:80->80/tcp       vue-web
xxxxxxxxx      springboot-server   Up X minutes   0.0.0.0:28080->28080/tcp springboot-server
xxxxxxxxx      mysql:8.0           Up X minutes   0.0.0.0:3306->3306/tcp   mysql
```

---

### 2. 检查后端健康

```bash
curl http://localhost:28080/api/common/health
```

**预期返回**：

```json
{
  "status": "UP",
  "message": "卷烟分配服务运行正常",
  "timestamp": "2025-10-24T..."
}
```

---

### 3. 检查数据库

```bash
docker exec -it mysql mysql -usyyc -p'syyc@12AB' marketing -e "SHOW TABLES;"
```

**预期**：看到初始化的数据表

---

### 4. 浏览器访问前端

打开浏览器，访问：

**http://10.69.110.130**

**预期**：看到卷烟投放管理系统的界面

---

## 📋 部署包检查清单

在上传前，请确认以下文件都存在：

- [x] vue-web/dist/index.html ✅ (21MB)
- [x] Springboot-server/app.jar ✅ (56MB)
- [x] mysql/init/init.sql ✅ (18KB)
- [x] deploy.sh ✅ (可执行)
- [x] 8个配置文件 ✅

**总大小**: 77MB

---

## ⚙️ 配置信息

### 数据库配置

| 项目 | 值 |
|-----|-----|
| 数据库 | marketing |
| 用户名 | syyc |
| 密码 | syyc@12AB |
| 类型 | MySQL 8.0 |

### 服务器信息

| 项目 | 值 |
|-----|-----|
| IP | 10.69.110.130 |
| SSH端口 | 50130 |
| 用户名 | root |
| 密码 | SYyc_110.130# |

### 端口映射

| 服务 | 端口 | 访问方式 |
|-----|------|---------|
| 前端 | 80 | 浏览器访问 |
| 后端 | 28080 | 内部访问 |
| 数据库 | 3306 | 内部访问 |

---

## 🔍 故障排查

### 如果Docker未安装

```bash
# 安装Docker
curl -fsSL https://get.docker.com | sh

# 启动Docker
systemctl start docker
systemctl enable docker

# 验证安装
docker --version
docker compose version

# 重新部署
cd /root/cigarette-system/data
./deploy.sh
```

---

### 如果80端口被占用

```bash
# 检查端口占用
netstat -tulpn | grep :80

# 停止占用端口的服务
systemctl stop nginx  # 或其他服务
systemctl disable nginx

# 重新部署
cd /root/cigarette-system/data
docker compose restart vue-web
```

---

### 如果容器启动失败

```bash
# 查看日志
docker compose logs

# 查看特定服务日志
docker compose logs mysql
docker compose logs springboot-server
docker compose logs vue-web

# 重新启动
docker compose down
./deploy.sh
```

---

### 如果前端无法访问

```bash
# 检查防火墙
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw reload

# 检查容器状态
docker ps | grep vue-web

# 查看nginx日志
docker compose logs vue-web
```

---

## 🔧 常用管理命令

```bash
# 进入部署目录
cd /root/cigarette-system/data

# 查看所有服务状态
docker compose ps

# 查看实时日志
docker compose logs -f

# 查看特定服务日志
docker compose logs -f springboot-server

# 重启所有服务
docker compose restart

# 重启特定服务
docker compose restart springboot-server

# 停止所有服务
docker compose down

# 启动所有服务
docker compose up -d

# 查看资源使用
docker stats
```

---

## 📊 数据备份

### 数据库备份（建议每天执行）

```bash
# 手动备份
docker exec mysql mysqldump -usyyc -p'syyc@12AB' --all-databases > /root/backup/mysql_$(date +%Y%m%d).sql

# 创建自动备份脚本
cat > /root/backup-mysql.sh << 'EOF'
#!/bin/bash
BACKUP_DIR="/root/backup/mysql"
mkdir -p $BACKUP_DIR
DATE=$(date +%Y%m%d_%H%M%S)
docker exec mysql mysqldump -usyyc -p'syyc@12AB' --all-databases > $BACKUP_DIR/mysql_$DATE.sql
find $BACKUP_DIR -name "*.sql" -mtime +7 -delete
echo "Backup completed: mysql_$DATE.sql"
EOF

chmod +x /root/backup-mysql.sh

# 添加到定时任务（每天凌晨2点）
(crontab -l 2>/dev/null; echo "0 2 * * * /root/backup-mysql.sh >> /var/log/mysql-backup.log 2>&1") | crontab -
```

---

## 🔄 更新部署

如果需要更新系统（新的jar包或前端代码）：

```bash
# 1. 在本地重新构建
# 前端：npm run build
# 后端：mvn clean package

# 2. 上传新的部署包
scp -P 50130 -r data/ root@10.69.110.130:/root/cigarette-system/

# 3. 在服务器上重新部署
ssh -p 50130 root@10.69.110.130
cd /root/cigarette-system/data
docker compose down
./deploy.sh
```

**注意**：如果只更新代码，数据库数据会保留。

---

## ⚠️ 重要提醒

### 1. 首次部署 vs 更新部署

**首次部署**：
- 会执行 `init.sql` 初始化数据库 ✅
- 创建所有表和数据

**更新部署**：
- 如果 `/data/mysql/data/` 已有数据，`init.sql` 不会重复执行 ⚠️
- 数据库数据会保留

### 2. 完全重置（危险操作）

如需完全重置系统（包括数据库）：

```bash
docker compose down
rm -rf /data/mysql/data/*
./deploy.sh
```

**警告**: 这会删除所有数据库数据！

### 3. 防火墙配置

确保以下端口已开放：

```bash
# 检查防火墙
sudo ufw status

# 开放SSH和Web端口
sudo ufw allow 50130/tcp  # SSH
sudo ufw allow 80/tcp     # Web

# 启用防火墙
sudo ufw enable
```

---

## ✅ 部署成功标志

- ✅ `docker ps` 显示3个容器都是 "Up" 状态
- ✅ 健康检查返回 `"status": "UP"`
- ✅ 浏览器可以访问 http://10.69.110.130
- ✅ 前端页面正常显示
- ✅ 可以查看数据库表

---

## 📞 获取帮助

如遇到问题，请提供：

1. 错误信息截图
2. `docker ps` 输出
3. `docker compose logs` 相关日志
4. 执行的具体命令

---

## 📝 完整命令汇总

### 在本地执行

```bash
# 上传部署包
cd /Users/robin/Desktop/CigaretteDistributionSystem
scp -P 50130 -r data/ root@10.69.110.130:/root/cigarette-system/
# 密码: SYyc_110.130#
```

### 在服务器执行

```bash
# 连接服务器
ssh -p 50130 root@10.69.110.130
# 密码: SYyc_110.130#

# 部署
cd /root/cigarette-system/data
chmod +x deploy.sh
./deploy.sh

# 验证
docker ps
curl http://localhost:28080/api/common/health
```

### 在浏览器访问

```
http://10.69.110.130
```

---

**准备就绪！现在可以开始部署了！** 🚀

预祝部署成功！

