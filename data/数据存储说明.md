# 数据存储说明

> **重要**: 本文档说明数据库和日志的实际存储位置

---

## 📂 部署包中的目录结构

```
data/
├── mysql/
│   ├── init/              # 初始化SQL文件（会复制到服务器）
│   │   └── init.sql       # 18KB - 数据库初始化脚本
│   └── docker-compose.yml # MySQL服务配置
│
├── Springboot-server/     # 后端应用
└── vue-web/               # 前端应用
```

**注意**: 部署包中**没有**数据存储目录，所有数据都存放在服务器上。

---

## 💾 服务器上的数据存储位置

部署后，数据会存储在服务器的以下目录：

### 1. 数据库数据

**路径**: `/data/mysql/data/`

**内容**:
- MySQL所有数据库文件
- 包括 `marketing` 数据库的所有表数据
- 系统数据库（mysql, performance_schema等）

**大小**: 随着使用逐渐增长

**挂载配置** (docker-compose.yml):
```yaml
volumes:
  - /data/mysql/data:/var/lib/mysql
```

**⚠️ 重要**:
- 删除此目录会**丢失所有数据库数据**！
- 必须定期备份此目录

---

### 2. 数据库配置

**路径**: `/data/mysql/conf/`

**用途**: 存放自定义MySQL配置文件（如my.cnf）

**挂载配置**:
```yaml
volumes:
  - /data/mysql/conf:/etc/mysql/conf.d
```

---

### 3. 数据库初始化SQL

**路径**: `/data/mysql/init/`

**内容**: 
- `init.sql` - 从部署包中复制过来
- 首次启动时MySQL会自动执行此目录下的SQL文件

**挂载配置**:
```yaml
volumes:
  - /data/mysql/init:/docker-entrypoint-initdb.d
```

**注意**: 
- 仅在首次启动时执行
- 如果 `/data/mysql/data/` 已有数据，初始化SQL不会重复执行

---

### 4. 后端日志

**路径**: `/data/springboot/logs/`

**内容**:
- `application.log` - Spring Boot应用日志
- 自动轮转（最大100MB，保留30天）

**挂载配置**:
```yaml
volumes:
  - /data/springboot/logs:/app/logs:rw
```

---

### 5. 前端日志

**路径**: `/data/vue-web/logs/`

**内容**:
- `access.log` - Nginx访问日志
- `error.log` - Nginx错误日志

**挂载配置**:
```yaml
volumes:
  - /data/vue-web/logs:/usr/local/openresty/nginx/logs:rw
```

---

## 🔄 数据流程

### 部署时

```
1. 上传部署包到服务器 (约77MB)
   └─ 包含: 前端dist, 后端jar, 配置文件, init.sql

2. 运行 deploy.sh
   ├─ 创建服务器目录:
   │  ├─ /data/mysql/data/     ← 空目录
   │  ├─ /data/mysql/conf/     ← 空目录
   │  ├─ /data/mysql/init/     ← 复制init.sql到此
   │  ├─ /data/springboot/logs/ ← 空目录
   │  └─ /data/vue-web/logs/   ← 空目录
   │
   └─ 启动Docker容器
      └─ MySQL首次启动
         └─ 执行 /data/mysql/init/init.sql
         └─ 在 /data/mysql/data/ 创建数据库文件
```

### 运行时

```
用户访问 → Nginx → Spring Boot → MySQL
                                   ↓
                            读写 /data/mysql/data/
                            
Spring Boot 日志 → /data/springboot/logs/
Nginx 日志 → /data/vue-web/logs/
```

---

## 📊 数据目录大小预估

| 目录 | 初始大小 | 增长速度 | 建议清理 |
|-----|---------|---------|---------|
| `/data/mysql/data/` | ~200MB | 中等 | ❌ 不要删除 |
| `/data/mysql/init/` | 18KB | 不增长 | ✅ 可保留 |
| `/data/springboot/logs/` | 0 | 较快 | ✅ 自动轮转 |
| `/data/vue-web/logs/` | 0 | 较快 | ⚠️ 需定期清理 |

---

## 🔒 数据备份建议

### 1. 数据库备份（最重要）

```bash
# 每天自动备份
docker exec mysql mysqldump -usyyc -p'syyc@12AB' --all-databases > /root/backup/mysql_$(date +%Y%m%d).sql
```

**备份内容**: 所有数据库数据  
**频率**: 每天  
**保留**: 至少7天  

### 2. 配置文件备份

```bash
# 备份部署包（包含所有配置）
tar -czf /root/backup/config_$(date +%Y%m%d).tar.gz /root/cigarette-system/data/
```

**备份内容**: 所有配置文件  
**频率**: 每次修改后  

---

## 🗑️ 数据清理

### 安全清理（日志）

```bash
# 清理30天前的后端日志（如果没有自动轮转）
find /data/springboot/logs/ -name "*.log.*" -mtime +30 -delete

# 清理Nginx日志（保留最近7天）
find /data/vue-web/logs/ -name "*.log" -mtime +7 -delete
```

### 危险操作（数据库）

```bash
# ⚠️ 删除所有数据库数据（危险！）
docker compose down
rm -rf /data/mysql/data/*
./deploy.sh  # 重新初始化
```

**警告**: 这会删除所有数据库数据！仅在需要完全重置时使用。

---

## 📁 完整的服务器目录结构

部署成功后，服务器上的完整目录结构：

```
/root/cigarette-system/
└── data/                           # 部署包
    ├── vue-web/
    ├── Springboot-server/
    ├── mysql/
    ├── docker-compose.yml
    └── deploy.sh

/data/                              # 数据存储（持久化）
├── mysql/
│   ├── data/                      # ⚠️ 数据库数据（重要！）
│   ├── conf/                      # MySQL配置
│   └── init/                      # 初始化SQL
├── springboot/
│   └── logs/                      # 后端日志
└── vue-web/
    └── logs/                      # 前端日志
```

---

## ❓ 常见问题

### Q1: 为什么部署包中没有data目录？

**A**: 数据目录是在服务器上动态创建的，不需要在部署包中携带。这样可以：
- 减小部署包大小
- 避免本地测试数据被上传
- 保持部署包的纯净

### Q2: 如何查看数据库文件大小？

```bash
du -sh /data/mysql/data/
```

### Q3: 如何迁移数据到新服务器？

```bash
# 在旧服务器上备份
docker exec mysql mysqldump -usyyc -p'syyc@12AB' --all-databases > backup.sql

# 在新服务器上恢复
docker exec -i mysql mysql -usyyc -p'syyc@12AB' < backup.sql
```

### Q4: 数据会丢失吗？

只要 `/data/mysql/data/` 目录存在且未被删除，数据就不会丢失。即使：
- 重启服务器 ✅ 数据保留
- 重启容器 ✅ 数据保留  
- 重新部署 ✅ 数据保留（除非删除data目录）

---

**更新时间**: 2025-10-24

